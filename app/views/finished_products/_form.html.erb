<%= form_with(model: finished_product, local: true) do |f| %>
  <% if finished_product.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(finished_product.errors.count, "error") %> 발생</h5>
      <ul>
        <% finished_product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label for="finished_product_name" class="form-label">완제품명 <span class="text-danger">*</span></label>
      <%= f.text_field :name, class: "form-control", required: true, placeholder: "예: 식빵 1개" %>
    </div>
    <div class="col-md-4">
      <label for="finished_product_weight" class="form-label">총 중량</label>
      <div class="input-group">
        <%= f.number_field :weight, step: 0.01, class: "form-control", placeholder: "자동계산", id: "total-weight-input", readonly: true %>
        <span class="input-group-text">g</span>
      </div>
      <small class="text-muted">하단 레시피 중량 합계로 자동 계산됩니다</small>
    </div>
    <div class="col-md-4">
      <label for="finished_product_base_dough_weight" class="form-label">반죽 사용량</label>
      <div class="input-group">
        <%= f.number_field :base_dough_weight, step: 0.01, class: "form-control", placeholder: "총 중량과 같으면 비워두세요", id: "base-dough-weight-input" %>
        <span class="input-group-text">g</span>
      </div>
      <small class="text-muted">추가 재료가 있는 경우만 입력 (예: 울금 기정떡 73g)</small>
    </div>
    <%= f.hidden_field :weight_unit, value: 'g' %>
  </div>

  <!-- 추가 투입재료 -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="form-label mb-0">추가 투입재료</label>
      <button type="button" class="btn btn-sm btn-outline-primary" id="add-additive-btn">
        <i class="bi bi-plus-circle me-1"></i>추가 재료 등록
      </button>
    </div>
    <small class="text-muted d-block mb-2">기본 반죽 외에 추가로 넣는 재료를 등록하세요 (예: 울금가루, 흑미가루 등)</small>

    <div class="table-responsive">
      <table class="table table-bordered" id="additives-table">
        <thead style="background-color: #f5f5f7;">
          <tr>
            <th>품목</th>
            <th style="width: 120px;">중량(g)</th>
            <th style="width: 60px;"></th>
          </tr>
        </thead>
        <tbody id="additives-tbody">
          <%= f.fields_for :finished_product_additives do |additive_fields| %>
            <tr class="additive-row">
              <td>
                <%= additive_fields.collection_select :item_id, @additive_items || [], :id, :name,
                    { include_blank: "품목 선택" },
                    { class: "form-select form-select-sm", required: true } %>
              </td>
              <td>
                <%= additive_fields.number_field :weight, step: 0.01, class: "form-control form-control-sm text-end", placeholder: "0", required: true %>
              </td>
              <td class="text-center">
                <%= additive_fields.hidden_field :_destroy %>
                <button type="button" class="btn btn-sm btn-outline-danger remove-additive-btn">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <% if finished_product.finished_product_additives.empty? %>
        <p class="text-muted small mb-0 no-additives-msg">추가 투입재료가 없습니다. (기본 반죽만 사용)</p>
      <% end %>
    </div>
  </div>

  <!-- 레시피 목록 -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="form-label mb-0">레시피 목록</label>
      <button type="button" class="btn btn-sm btn-outline-primary" id="add-recipe-btn">
        <i class="bi bi-plus-circle me-1"></i>레시피 추가
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered" id="recipes-table">
        <thead style="background-color: #f5f5f7;">
          <tr>
            <th style="width: 40px; text-align: center;">
              <i class="bi bi-grip-vertical text-muted"></i>
            </th>
            <th>레시피명</th>
            <th style="width: 120px;">중량(g)</th>
            <th>비고</th>
            <th style="width: 60px;"></th>
          </tr>
        </thead>
        <tbody id="recipes-tbody">
          <%= f.fields_for :finished_product_recipes do |recipe_fields| %>
            <tr class="recipe-row">
              <td style="cursor: move;" class="text-center">
                <i class="bi bi-grip-vertical text-muted drag-handle"></i>
              </td>
              <td>
                <%= recipe_fields.collection_select :recipe_id, @recipes, :id, :name,
                    {},
                    { class: "form-select form-select-sm", required: true } %>
                <%= recipe_fields.hidden_field :position %>
              </td>
              <td>
                <%= recipe_fields.number_field :quantity, step: 0.01, class: "form-control form-control-sm text-end weight-input", placeholder: "0", required: true %>
              </td>
              <td>
                <%= recipe_fields.text_field :notes, class: "form-control form-control-sm" %>
              </td>
              <td class="text-center">
                <%= recipe_fields.hidden_field :_destroy %>
                <button type="button" class="btn btn-sm btn-outline-danger remove-recipe-btn">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot style="background-color: #fafafa;">
          <tr>
            <td colspan="2" class="text-end"><strong>합계</strong></td>
            <td class="text-end"><strong id="recipe-total-weight">0</strong> g</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- 포장 단위 목록 -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="form-label mb-0">포장 단위</label>
      <button type="button" class="btn btn-sm btn-outline-primary" id="add-packaging-unit-btn">
        <i class="bi bi-box-seam me-1"></i>포장 단위 추가
      </button>
    </div>
    <small class="text-muted d-block mb-2">각 포장 단위(예: 30개입, 16개입)와 사용하는 포장재를 등록하세요.</small>

    <div id="packaging-units-container">
      <%= f.fields_for :packaging_units do |pu_fields| %>
        <div class="card mb-3 packaging-unit-card" data-index="<%= pu_fields.index %>">
          <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center gap-2 flex-grow-1">
              <i class="bi bi-box-seam text-primary"></i>
              <%= pu_fields.text_field :name, class: "form-control form-control-sm", style: "max-width: 150px;", placeholder: "예: 30개입", required: true %>
              <span class="text-muted">-</span>
              <div class="input-group input-group-sm" style="max-width: 150px;">
                <%= pu_fields.number_field :pieces_per_unit, class: "form-control form-control-sm", placeholder: "개수", required: true, min: 1 %>
                <span class="input-group-text">개/박스</span>
              </div>
              <%= pu_fields.hidden_field :position %>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary add-material-btn">
                <i class="bi bi-plus-circle me-1"></i>포장재
              </button>
              <%= pu_fields.hidden_field :_destroy, class: "destroy-field" %>
              <button type="button" class="btn btn-sm btn-outline-danger remove-packaging-unit-btn">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="card-body py-2">
            <table class="table table-sm table-bordered mb-0 materials-table">
              <thead style="background-color: #f8f9fa;">
                <tr>
                  <th style="width: 120px;">포장재 유형</th>
                  <th>포장재 품목</th>
                  <th style="width: 120px;">박스당 수량</th>
                  <th>비고</th>
                  <th style="width: 50px;"></th>
                </tr>
              </thead>
              <tbody class="materials-tbody">
                <%= pu_fields.fields_for :packaging_unit_materials do |pm_fields| %>
                  <% filtered_items = @packaging_items.select { |i| i.category == pm_fields.object.material_type } %>
                  <tr class="material-row">
                    <td>
                      <%= pm_fields.select :material_type,
                          options_for_select([['내포장재', '내포장재'], ['외포장재', '외포장재'], ['기타', '기타']], pm_fields.object.material_type),
                          { include_blank: "선택" },
                          class: "form-select form-select-sm material-type-select" %>
                      <%= pm_fields.hidden_field :position %>
                    </td>
                    <td>
                      <%= pm_fields.collection_select :item_id,
                          pm_fields.object.material_type.present? ? filtered_items : @packaging_items,
                          :id, :name,
                          { include_blank: "포장재 선택" },
                          { class: "form-select form-select-sm item-select", required: true } %>
                    </td>
                    <td>
                      <%= pm_fields.number_field :quantity_per_unit, step: 0.01, class: "form-control form-control-sm text-end", value: pm_fields.object.quantity_per_unit || 1, required: true, min: 0.01 %>
                    </td>
                    <td>
                      <%= pm_fields.text_field :notes, class: "form-control form-control-sm" %>
                    </td>
                    <td class="text-center">
                      <%= pm_fields.hidden_field :_destroy, class: "material-destroy-field" %>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
                        <i class="bi bi-x"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% if pu_fields.object.packaging_unit_materials.empty? %>
              <p class="text-muted small mb-0 mt-2 no-materials-msg">포장재를 추가하려면 위 '포장재' 버튼을 클릭하세요.</p>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 설명 -->
  <div class="mb-3">
    <label for="finished_product_description" class="form-label">설명</label>
    <%= f.text_area :description, class: "form-control", rows: 3, placeholder: "완제품에 대한 설명을 입력하세요" %>
  </div>

  <!-- 비고 -->
  <div class="mb-3">
    <label for="finished_product_notes" class="form-label">비고</label>
    <%= f.text_area :notes, class: "form-control", rows: 2, placeholder: "추가 메모사항" %>
  </div>

  <div class="d-flex gap-2 justify-content-end mt-4">
    <%= f.submit (finished_product.new_record? ? '등록' : '수정'), class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", finished_products_path, class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('turbo:load', function() {
  const tbody = document.getElementById('recipes-tbody');
  if (!tbody) return;

  if (tbody.dataset.initialized === 'true') return;
  tbody.setAttribute('data-initialized', 'true');

  let recipeIndex = <%= finished_product.finished_product_recipes.length %>;

  // 레시피 데이터를 JSON으로 준비
  const recipesData = <%= @recipes.map { |r| { id: r.id, name: r.name } }.to_json.html_safe %>;

  // 레시피 추가
  const addRecipeBtn = document.getElementById('add-recipe-btn');
  if (addRecipeBtn) {
    addRecipeBtn.addEventListener('click', function() {
      const tbody = document.getElementById('recipes-tbody');

      // 레시피 옵션 생성
      const recipeOptions = recipesData.map(recipe =>
        `<option value="${recipe.id}">${recipe.name}</option>`
      ).join('');

      const newRow = `
        <tr class="recipe-row">
          <td style="cursor: move;" class="text-center">
            <i class="bi bi-grip-vertical text-muted drag-handle"></i>
          </td>
          <td>
            <select class="form-select form-select-sm" name="finished_product[finished_product_recipes_attributes][${recipeIndex}][recipe_id]" required>
              ${recipeOptions}
            </select>
            <input type="hidden" name="finished_product[finished_product_recipes_attributes][${recipeIndex}][position]" value="${recipeIndex}">
          </td>
          <td>
            <input type="number" step="0.01" class="form-control form-control-sm text-end weight-input" name="finished_product[finished_product_recipes_attributes][${recipeIndex}][quantity]" placeholder="0" required>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" name="finished_product[finished_product_recipes_attributes][${recipeIndex}][notes]">
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-recipe-btn">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;

      tbody.insertAdjacentHTML('beforeend', newRow);
      recipeIndex++;
      initializeSortable();
    });
  }

  // 레시피 삭제
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-recipe-btn')) {
      const row = e.target.closest('tr');
      const destroyField = row.querySelector('input[name*="_destroy"]');
      if (destroyField) {
        destroyField.value = '1';
        row.style.display = 'none';
      } else {
        row.remove();
      }
      calculateTotalWeight();
      initializeSortable();
    }
  });

  // 중량 입력 시 합계 계산
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('weight-input')) {
      calculateTotalWeight();
    }
  });

  // 총 중량 계산 함수
  function calculateTotalWeight() {
    const tbody = document.getElementById('recipes-tbody');
    if (!tbody) return;

    let totalWeight = 0;
    const weightInputs = tbody.querySelectorAll('.weight-input');

    weightInputs.forEach(input => {
      const row = input.closest('tr');
      if (row && row.style.display !== 'none') {
        const weight = parseFloat(input.value) || 0;
        totalWeight += weight;
      }
    });

    // 하단 합계 표시
    const totalWeightElement = document.getElementById('recipe-total-weight');
    if (totalWeightElement) {
      totalWeightElement.textContent = totalWeight.toFixed(2);
    }

    // 상단 총 중량 필드에 반영
    const totalWeightInput = document.getElementById('total-weight-input');
    if (totalWeightInput) {
      totalWeightInput.value = totalWeight.toFixed(2);
    }
  }

  // SortableJS 초기화
  let sortableInstance = null;

  function initializeSortable() {
    const tbody = document.getElementById('recipes-tbody');
    if (!tbody) return;

    if (typeof Sortable === 'undefined') return;

    if (sortableInstance) {
      sortableInstance.destroy();
      sortableInstance = null;
    }

    sortableInstance = Sortable.create(tbody, {
      handle: '.drag-handle',
      animation: 150,
      onEnd: function() {
        updatePositions();
      }
    });
  }

  function updatePositions() {
    const tbody = document.getElementById('recipes-tbody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
      const positionInput = row.querySelector('input[name*="[position]"]');
      if (positionInput) {
        positionInput.value = index;
      }
    });
  }

  initializeSortable();
  calculateTotalWeight();

  // ===== 추가 투입재료 관리 =====
  let additiveIndex = <%= finished_product.finished_product_additives.length %>;
  const additiveItemsData = <%= (@additive_items || []).map { |i| { id: i.id, name: i.name } }.to_json.html_safe %>;

  const addAdditiveBtn = document.getElementById('add-additive-btn');
  if (addAdditiveBtn) {
    addAdditiveBtn.addEventListener('click', function() {
      const tbody = document.getElementById('additives-tbody');
      const noAdditivesMsg = document.querySelector('.no-additives-msg');

      const itemOptions = additiveItemsData.map(item =>
        `<option value="${item.id}">${item.name}</option>`
      ).join('');

      const newRow = `
        <tr class="additive-row">
          <td>
            <select class="form-select form-select-sm" name="finished_product[finished_product_additives_attributes][${additiveIndex}][item_id]" required>
              <option value="">품목 선택</option>
              ${itemOptions}
            </select>
          </td>
          <td>
            <input type="number" step="0.01" class="form-control form-control-sm text-end" name="finished_product[finished_product_additives_attributes][${additiveIndex}][weight]" placeholder="0" required>
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-additive-btn">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;

      tbody.insertAdjacentHTML('beforeend', newRow);
      additiveIndex++;

      if (noAdditivesMsg) {
        noAdditivesMsg.style.display = 'none';
      }
    });
  }

  // 추가 투입재료 삭제
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-additive-btn')) {
      const row = e.target.closest('tr');
      const destroyField = row.querySelector('input[name*="_destroy"]');
      if (destroyField) {
        destroyField.value = '1';
        row.style.display = 'none';
      } else {
        row.remove();
      }
    }
  });

  // ===== 포장 단위 관리 =====
  let packagingUnitIndex = <%= finished_product.packaging_units.length %>;
  const packagingItemsData = <%= (@packaging_items || []).map { |i| { id: i.id, name: i.name, category: i.category } }.to_json.html_safe %>;

  // 카테고리(material_type)별 품목 필터링 함수
  function getFilteredItemOptions(materialType) {
    const filteredItems = materialType
      ? packagingItemsData.filter(item => item.category === materialType)
      : packagingItemsData;

    return filteredItems.map(item =>
      `<option value="${item.id}">${item.name}</option>`
    ).join('');
  }

  // material_type 변경 시 품목 드롭다운 업데이트
  function updateItemDropdown(materialTypeSelect) {
    const row = materialTypeSelect.closest('tr');
    const itemSelect = row.querySelector('select[name*="[item_id]"]');
    if (!itemSelect) return;

    const materialType = materialTypeSelect.value;
    const currentItemId = itemSelect.value;

    // 옵션 업데이트
    itemSelect.innerHTML = '<option value="">포장재 선택</option>' + getFilteredItemOptions(materialType);

    // 기존 선택값이 필터링된 목록에 있으면 유지
    if (currentItemId) {
      const optionExists = Array.from(itemSelect.options).some(opt => opt.value === currentItemId);
      if (optionExists) {
        itemSelect.value = currentItemId;
      }
    }
  }

  // material_type 변경 이벤트 리스너 (이벤트 위임)
  document.addEventListener('change', function(e) {
    if (e.target.matches('select[name*="[material_type]"]')) {
      updateItemDropdown(e.target);
    }
  });

  // 기존 material_type 선택에 대해 초기화
  document.querySelectorAll('select[name*="[material_type]"]').forEach(select => {
    if (select.value) {
      updateItemDropdown(select);
    }
  });

  // 포장 단위 추가
  const addPackagingUnitBtn = document.getElementById('add-packaging-unit-btn');
  if (addPackagingUnitBtn) {
    addPackagingUnitBtn.addEventListener('click', function() {
      const container = document.getElementById('packaging-units-container');

      const newUnit = `
        <div class="card mb-3 packaging-unit-card" data-index="${packagingUnitIndex}">
          <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center gap-2 flex-grow-1">
              <i class="bi bi-box-seam text-primary"></i>
              <input type="text" class="form-control form-control-sm" style="max-width: 150px;"
                     name="finished_product[packaging_units_attributes][${packagingUnitIndex}][name]"
                     placeholder="예: 30개입" required>
              <span class="text-muted">-</span>
              <div class="input-group input-group-sm" style="max-width: 150px;">
                <input type="number" class="form-control form-control-sm"
                       name="finished_product[packaging_units_attributes][${packagingUnitIndex}][pieces_per_unit]"
                       placeholder="개수" required min="1">
                <span class="input-group-text">개/박스</span>
              </div>
              <input type="hidden" name="finished_product[packaging_units_attributes][${packagingUnitIndex}][position]" value="${packagingUnitIndex}">
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary add-material-btn">
                <i class="bi bi-plus-circle me-1"></i>포장재
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger remove-packaging-unit-btn">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="card-body py-2">
            <table class="table table-sm table-bordered mb-0 materials-table">
              <thead style="background-color: #f8f9fa;">
                <tr>
                  <th style="width: 120px;">포장재 유형</th>
                  <th>포장재 품목</th>
                  <th style="width: 120px;">박스당 수량</th>
                  <th>비고</th>
                  <th style="width: 50px;"></th>
                </tr>
              </thead>
              <tbody class="materials-tbody">
              </tbody>
            </table>
            <p class="text-muted small mb-0 mt-2 no-materials-msg">포장재를 추가하려면 위 '포장재' 버튼을 클릭하세요.</p>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', newUnit);
      packagingUnitIndex++;
    });
  }

  // 포장재 추가 (이벤트 위임)
  document.addEventListener('click', function(e) {
    if (e.target.closest('.add-material-btn')) {
      const card = e.target.closest('.packaging-unit-card');
      const unitIndex = card.dataset.index;
      const tbody = card.querySelector('.materials-tbody');
      const noMaterialsMsg = card.querySelector('.no-materials-msg');

      // 현재 포장재 개수로 materialIndex 결정
      const materialIndex = tbody.querySelectorAll('.material-row').length;

      // 포장재 유형 미선택 시 모든 품목 표시
      const allItemOptions = packagingItemsData.map(item =>
        `<option value="${item.id}">${item.name}</option>`
      ).join('');

      const newRow = `
        <tr class="material-row">
          <td>
            <select class="form-select form-select-sm material-type-select"
                    name="finished_product[packaging_units_attributes][${unitIndex}][packaging_unit_materials_attributes][${materialIndex}][material_type]">
              <option value="">선택</option>
              <option value="내포장재">내포장재</option>
              <option value="외포장재">외포장재</option>
              <option value="기타">기타</option>
            </select>
            <input type="hidden" name="finished_product[packaging_units_attributes][${unitIndex}][packaging_unit_materials_attributes][${materialIndex}][position]" value="${materialIndex}">
          </td>
          <td>
            <select class="form-select form-select-sm item-select"
                    name="finished_product[packaging_units_attributes][${unitIndex}][packaging_unit_materials_attributes][${materialIndex}][item_id]" required>
              <option value="">포장재 선택 (유형 먼저 선택)</option>
            </select>
          </td>
          <td>
            <input type="number" step="0.01" class="form-control form-control-sm text-end"
                   name="finished_product[packaging_units_attributes][${unitIndex}][packaging_unit_materials_attributes][${materialIndex}][quantity_per_unit]"
                   value="1" required min="0.01">
          </td>
          <td>
            <input type="text" class="form-control form-control-sm"
                   name="finished_product[packaging_units_attributes][${unitIndex}][packaging_unit_materials_attributes][${materialIndex}][notes]">
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn">
              <i class="bi bi-x"></i>
            </button>
          </td>
        </tr>
      `;

      tbody.insertAdjacentHTML('beforeend', newRow);

      // 안내 메시지 숨기기
      if (noMaterialsMsg) {
        noMaterialsMsg.style.display = 'none';
      }
    }

    // 포장 단위 삭제
    if (e.target.closest('.remove-packaging-unit-btn')) {
      const card = e.target.closest('.packaging-unit-card');
      const destroyField = card.querySelector('.destroy-field');
      if (destroyField) {
        destroyField.value = '1';
        card.style.display = 'none';
      } else {
        card.remove();
      }
    }

    // 포장재 삭제
    if (e.target.closest('.remove-material-btn')) {
      const row = e.target.closest('.material-row');
      const destroyField = row.querySelector('.material-destroy-field');
      if (destroyField) {
        destroyField.value = '1';
        row.style.display = 'none';
      } else {
        row.remove();
      }
    }
  });
});
</script>
