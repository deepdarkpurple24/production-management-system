<%= form_with(model: ingredient, local: true) do |f| %>
  <% if ingredient.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(ingredient.errors.count, "error") %> 발생</h5>
      <ul>
        <% ingredient.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label for="ingredient_name" class="form-label">재료명 <span class="text-danger">*</span></label>
      <%= f.text_field :name, class: "form-control", required: true, placeholder: "예: 멥쌀죽" %>
    </div>

    <div class="col-md-3">
      <label for="ingredient_production_quantity" class="form-label">생산량 <span class="text-danger">*</span></label>
      <%= f.number_field :production_quantity, step: 0.01, class: "form-control", required: true, placeholder: "2650" %>
    </div>

    <div class="col-md-3">
      <label for="ingredient_production_unit" class="form-label">단위 <span class="text-danger">*</span></label>
      <%= f.select :production_unit,
                   options_for_select(['Kg', 'g', 'L', 'mL', '개'], ingredient.production_unit),
                   { include_blank: "선택" },
                   class: "form-select",
                   required: true %>
    </div>

    <div class="col-md-6">
      <label for="ingredient_equipment_type_id" class="form-label">장비구분</label>
      <%= f.collection_select :equipment_type_id, @equipment_types, :id, :name,
                             { include_blank: "장비구분 선택" },
                             { class: "form-select",
                               id: "ingredient_equipment_type_id" } %>
    </div>

    <div class="col-md-3">
      <label for="ingredient_equipment_mode_id" class="form-label">조리방법</label>
      <%= f.select :equipment_mode_id,
                   options_for_select([]),
                   { include_blank: "먼저 장비구분을 선택하세요" },
                   { class: "form-select", id: "ingredient_equipment_mode_id" } %>
    </div>

    <div class="col-md-3">
      <label for="ingredient_cooking_time" class="form-label">조리시간</label>
      <div class="input-group">
        <%= f.text_field :cooking_time, class: "form-control", placeholder: "30" %>
        <span class="input-group-text">분</span>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="form-label mb-0">품목 목록</label>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-item-btn">
          <i class="bi bi-plus-circle me-1"></i>품목 추가
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-subtotal-btn">
          <i class="bi bi-calculator me-1"></i>소계 추가
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered" id="items-table">
        <thead style="background-color: #f5f5f7;">
          <tr>
            <th style="width: 40px; text-align: center;">
              <i class="bi bi-grip-vertical text-muted"></i>
            </th>
            <th style="width: 120px;">구분</th>
            <th>재료명</th>
            <th style="width: 120px;">중량</th>
            <th style="width: 100px;">단위</th>
            <th>비고</th>
            <th style="width: 60px;"></th>
          </tr>
        </thead>
        <tbody id="items-tbody">
          <%= f.fields_for :ingredient_items do |item_fields| %>
            <tr class="item-row" data-index="<%= item_fields.index %>">
              <td style="cursor: move;" class="text-center">
                <i class="bi bi-grip-vertical text-muted drag-handle"></i>
              </td>
              <td>
                <%= item_fields.select :source_type,
                    options_for_select([['품목', 'item'], ['재료', 'ingredient'], ['기타', 'other']], item_fields.object.source_type || 'item'),
                    {},
                    { class: "form-select form-select-sm source-type-select", required: true } %>
                <%= item_fields.hidden_field :row_type, value: "item" %>
                <%= item_fields.hidden_field :position %>
              </td>
              <td>
                <div class="source-item" style="<%= 'display: none;' unless item_fields.object.source_type.nil? || item_fields.object.source_type == 'item' %>">
                  <%= item_fields.collection_select :item_id, @items, :id, :name,
                      { include_blank: "품목 선택" },
                      { class: "form-select form-select-sm" } %>
                </div>
                <div class="source-ingredient" style="<%= 'display: none;' unless item_fields.object.source_type == 'ingredient' %>">
                  <%= item_fields.collection_select :referenced_ingredient_id, @ingredients, :id, :name,
                      { include_blank: "재료 선택" },
                      { class: "form-select form-select-sm" } %>
                </div>
                <div class="source-other" style="<%= 'display: none;' unless item_fields.object.source_type == 'other' %>">
                  <%= item_fields.text_field :custom_name, class: "form-control form-control-sm", placeholder: "재료명 입력" %>
                </div>
              </td>
              <td>
                <%= item_fields.number_field :quantity, step: 0.01, class: "form-control form-control-sm text-end quantity-input", required: true %>
              </td>
              <td>
                <%= item_fields.select :unit,
                    options_for_select(['Kg', 'g', 'L', 'mL', '개'], item_fields.object.unit),
                    { include_blank: "선택" },
                    class: "form-select form-select-sm" %>
              </td>
              <td>
                <%= item_fields.text_field :notes, class: "form-control form-control-sm" %>
              </td>
              <td class="text-center">
                <%= item_fields.hidden_field :_destroy %>
                <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot style="background-color: #fafafa;">
          <tr>
            <td></td>
            <td></td>
            <td class="text-end"><strong>최종 합계</strong></td>
            <td class="text-end"><strong id="total-quantity">0</strong></td>
            <td><strong>g</strong></td>
            <td>
              <%= f.text_field :notes, class: "form-control form-control-sm" %>
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="mb-3">
    <label for="ingredient_description" class="form-label">설명</label>
    <%= f.text_area :description, class: "form-control", rows: 3 %>
  </div>

  <div class="d-flex gap-2 justify-content-end mt-4">
    <%= f.submit (ingredient.new_record? ? '등록' : '수정'), class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", ingredients_path, class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('turbo:load', function() {
  // ===== 장비구분 선택 시 조리방법(장비 모드) 로드 =====
  const equipmentTypeSelect = document.getElementById('ingredient_equipment_type_id');
  const modeSelect = document.getElementById('ingredient_equipment_mode_id');

  if (equipmentTypeSelect && modeSelect) {
    // 초기 로드 시 선택된 장비구분이 있으면 모드 로드
    if (equipmentTypeSelect.value) {
      loadEquipmentModes(equipmentTypeSelect.value, <%= ingredient.equipment_mode_id || 'null' %>);
    }

    equipmentTypeSelect.addEventListener('change', function() {
      const equipmentTypeId = this.value;

      if (!equipmentTypeId) {
        modeSelect.innerHTML = '<option value="">먼저 장비구분을 선택하세요</option>';
        return;
      }

      loadEquipmentModes(equipmentTypeId, null);
    });
  }

  function loadEquipmentModes(equipmentTypeId, selectedModeId) {
    // AJAX로 해당 장비 타입의 모드 가져오기
    fetch(`/settings/equipment_modes/${equipmentTypeId}`)
      .then(response => response.json())
      .then(modes => {
        modeSelect.innerHTML = '<option value="">조리방법 선택</option>';

        modes.forEach(mode => {
          const option = document.createElement('option');
          option.value = mode.id;
          option.textContent = mode.name;
          if (selectedModeId && mode.id == selectedModeId) {
            option.selected = true;
          }
          modeSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error loading equipment modes:', error);
        modeSelect.innerHTML = '<option value="">모드를 불러오는데 실패했습니다</option>';
      });
  }

  // ===== 품목 목록 관리 =====
  const tbody = document.getElementById('items-tbody');
  if (!tbody) return;

  if (tbody.dataset.initialized === 'true') return;
  tbody.setAttribute('data-initialized', 'true');

  let itemIndex = <%= ingredient.ingredient_items.length %>;

  // Source type 변경 시 표시/숨김 처리
  function handleSourceTypeChange(selectElement) {
    const row = selectElement.closest('tr');
    const sourceType = selectElement.value;

    const itemDiv = row.querySelector('.source-item');
    const ingredientDiv = row.querySelector('.source-ingredient');
    const otherDiv = row.querySelector('.source-other');

    if (itemDiv) itemDiv.style.display = sourceType === 'item' ? 'block' : 'none';
    if (ingredientDiv) ingredientDiv.style.display = sourceType === 'ingredient' ? 'block' : 'none';
    if (otherDiv) otherDiv.style.display = sourceType === 'other' ? 'block' : 'none';
  }

  // 이벤트 위임: source type 변경 이벤트를 document 레벨에서 처리
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('source-type-select')) {
      handleSourceTypeChange(e.target);
    }
  });

  // 데이터 준비
  const itemsData = <%= @items.map { |item| { id: item.id, name: item.name } }.to_json.html_safe %>;
  const ingredientsData = <%= (@ingredients || []).map { |ing| { id: ing.id, name: ing.name } }.to_json.html_safe %>;

  // 품목 추가
  const addItemBtn = document.getElementById('add-item-btn');
  if (addItemBtn) {
    addItemBtn.addEventListener('click', function() {
      const tbody = document.getElementById('items-tbody');
      const itemOptions = itemsData.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
      const ingredientOptions = ingredientsData.map(ing => `<option value="${ing.id}">${ing.name}</option>`).join('');

      const newRow = `
        <tr class="item-row">
          <td style="cursor: move;" class="text-center">
            <i class="bi bi-grip-vertical text-muted drag-handle"></i>
          </td>
          <td>
            <select class="form-select form-select-sm source-type-select" name="ingredient[ingredient_items_attributes][${itemIndex}][source_type]" required>
              <option value="item">품목</option>
              <option value="ingredient">재료</option>
              <option value="other">기타</option>
            </select>
            <input type="hidden" name="ingredient[ingredient_items_attributes][${itemIndex}][row_type]" value="item">
            <input type="hidden" name="ingredient[ingredient_items_attributes][${itemIndex}][position]" value="${itemIndex}">
          </td>
          <td>
            <div class="source-item">
              <select class="form-select form-select-sm" name="ingredient[ingredient_items_attributes][${itemIndex}][item_id]">
                <option value="">품목 선택</option>
                ${itemOptions}
              </select>
            </div>
            <div class="source-ingredient" style="display: none;">
              <select class="form-select form-select-sm" name="ingredient[ingredient_items_attributes][${itemIndex}][referenced_ingredient_id]">
                <option value="">재료 선택</option>
                ${ingredientOptions}
              </select>
            </div>
            <div class="source-other" style="display: none;">
              <input type="text" class="form-control form-control-sm" name="ingredient[ingredient_items_attributes][${itemIndex}][custom_name]" placeholder="재료명 입력">
            </div>
          </td>
          <td>
            <input type="number" step="0.01" class="form-control form-control-sm text-end quantity-input" name="ingredient[ingredient_items_attributes][${itemIndex}][quantity]" required>
          </td>
          <td>
            <select class="form-select form-select-sm" name="ingredient[ingredient_items_attributes][${itemIndex}][unit]">
              <option value="">선택</option>
              <option value="Kg">Kg</option>
              <option value="g">g</option>
              <option value="L">L</option>
              <option value="mL">mL</option>
              <option value="개">개</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" name="ingredient[ingredient_items_attributes][${itemIndex}][notes]">
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;

      tbody.insertAdjacentHTML('beforeend', newRow);

      // 이벤트 위임을 사용하므로 개별 이벤트 리스너 추가 불필요

      itemIndex++;
      calculateTotals();
      initializeSortable();
    });
  }

  // 소계 추가
  const addSubtotalBtn = document.getElementById('add-subtotal-btn');
  if (addSubtotalBtn) {
    addSubtotalBtn.addEventListener('click', function() {
      if (document.querySelector('.subtotal-row')) {
        alert('소계는 한 번만 추가할 수 있습니다.');
        return;
      }

      const tbody = document.getElementById('items-tbody');
      const subtotalRow = `
        <tr class="subtotal-row table-secondary">
          <td class="text-center"><i class="bi bi-grip-vertical text-muted" style="visibility: hidden;"></i></td>
          <td></td>
          <td class="text-end"><strong>소계</strong></td>
          <td class="text-end"><strong class="subtotal-quantity">0</strong></td>
          <td><strong>g</strong></td>
          <td></td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-subtotal-btn">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;

      tbody.insertAdjacentHTML('beforeend', subtotalRow);

      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = `ingredient[ingredient_items_attributes][${itemIndex}][row_type]`;
      hiddenInput.value = 'subtotal';
      tbody.querySelector('.subtotal-row').appendChild(hiddenInput);

      const positionInput = document.createElement('input');
      positionInput.type = 'hidden';
      positionInput.name = `ingredient[ingredient_items_attributes][${itemIndex}][position]`;
      positionInput.value = itemIndex;
      tbody.querySelector('.subtotal-row').appendChild(positionInput);

      itemIndex++;
      calculateTotals();
      initializeSortable();
    });
  }

  // 품목 삭제
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-item-btn')) {
      const row = e.target.closest('tr');
      const destroyField = row.querySelector('input[name*="_destroy"]');
      if (destroyField) {
        destroyField.value = '1';
        row.style.display = 'none';
      } else {
        row.remove();
      }
      calculateTotals();
      initializeSortable();
    }

    if (e.target.closest('.remove-subtotal-btn')) {
      const row = e.target.closest('tr');
      const destroyField = row.querySelector('input[name*="_destroy"]');
      if (destroyField) {
        destroyField.value = '1';
        row.style.display = 'none';
      } else {
        row.remove();
      }
      calculateTotals();
      initializeSortable();
    }
  });

  // 수량 입력 시 계산
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('quantity-input')) {
      calculateTotals();
    }
  });

  // 단위 선택 변경 시 계산
  document.addEventListener('change', function(e) {
    if (e.target.name && e.target.name.includes('[unit]')) {
      calculateTotals();
    }
  });

  // 단위를 g으로 변환하는 함수
  function convertToGrams(quantity, unit) {
    const qty = parseFloat(quantity) || 0;

    switch(unit) {
      case 'Kg':
        return qty * 1000;
      case 'g':
        return qty;
      case 'L':
        return qty * 1000; // 물 기준 (비중 1)
      case 'mL':
        return qty; // 물 기준 (비중 1)
      case '개':
        return 0; // 개는 중량 변환 불가
      default:
        return qty;
    }
  }

  function calculateTotals() {
    const tbody = document.getElementById('items-tbody');
    if (!tbody) return;

    const allRows = Array.from(tbody.querySelectorAll('tr'));
    const subtotalRow = tbody.querySelector('.subtotal-row');

    let totalQuantityInGrams = 0;
    let subtotalQuantityInGrams = 0;
    let beforeSubtotal = true;

    allRows.forEach(row => {
      if (row.style.display === 'none') return;

      if (row.classList.contains('subtotal-row')) {
        beforeSubtotal = false;
        return;
      }

      if (row.classList.contains('item-row')) {
        const quantityInput = row.querySelector('.quantity-input');
        const unitSelect = row.querySelector('select[name*="[unit]"]');

        const quantity = parseFloat(quantityInput?.value) || 0;
        const unit = unitSelect?.value || '';

        const quantityInGrams = convertToGrams(quantity, unit);

        totalQuantityInGrams += quantityInGrams;

        if (beforeSubtotal) {
          subtotalQuantityInGrams += quantityInGrams;
        }
      }
    });

    // 소계 표시 (g 단위)
    if (subtotalRow) {
      const subtotalElement = subtotalRow.querySelector('.subtotal-quantity');
      if (subtotalElement) {
        subtotalElement.textContent = subtotalQuantityInGrams.toFixed(2);
      }
    }

    // 총 수량 표시 (g 단위)
    const totalQuantityElement = document.getElementById('total-quantity');
    if (totalQuantityElement) {
      totalQuantityElement.textContent = totalQuantityInGrams.toFixed(2);
    }
  }

  // SortableJS 초기화
  let sortableInstance = null;

  function initializeSortable() {
    const tbody = document.getElementById('items-tbody');
    if (!tbody) return;
    if (typeof Sortable === 'undefined') return;

    if (sortableInstance) {
      sortableInstance.destroy();
      sortableInstance = null;
    }

    const subtotalRow = tbody.querySelector('.subtotal-row');

    if (subtotalRow) {
      sortableInstance = Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        filter: '.subtotal-row',
        onMove: function(evt) {
          if (evt.related.classList.contains('subtotal-row')) return false;

          const draggedIndex = Array.from(tbody.children).indexOf(evt.dragged);
          const relatedIndex = Array.from(tbody.children).indexOf(evt.related);
          const currentSubtotalIndex = Array.from(tbody.children).indexOf(subtotalRow);

          if (draggedIndex < currentSubtotalIndex && relatedIndex > currentSubtotalIndex) return false;
          if (draggedIndex > currentSubtotalIndex && relatedIndex < currentSubtotalIndex) return false;

          return true;
        },
        onEnd: function() {
          updatePositions();
          calculateTotals();
        }
      });
    } else {
      sortableInstance = Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        onEnd: function() {
          updatePositions();
          calculateTotals();
        }
      });
    }
  }

  function updatePositions() {
    const tbody = document.getElementById('items-tbody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
      const positionInput = row.querySelector('input[name*="[position]"]');
      if (positionInput) {
        positionInput.value = index;
      }
    });
  }

  calculateTotals();
  initializeSortable();
});
</script>

<style>
  /* Bootstrap 폼 검증 체크/X 표시 숨기기 */
  #items-table .form-select.is-valid,
  #items-table .form-control.is-valid {
    background-image: none;
    border-color: #dee2e6;
  }

  #items-table .form-select.is-invalid,
  #items-table .form-control.is-invalid {
    background-image: none;
    border-color: #dee2e6;
  }

  /* 중량 입력 필드 숫자 오른쪽 정렬 */
  #items-table .quantity-input {
    text-align: right;
  }
</style>
