<%= form_with(model: [:inventory, item], local: true, class: "needs-validation") do |f| %>
  <% if item.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <%= pluralize(item.errors.count, "error") %> 발생
      </h5>
      <ul class="mb-0">
        <% item.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- 품목코드 (자동생성 안내) -->
    <div class="col-md-6">
      <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        품목코드
      </label>
      <div class="form-control bg-light" style="color: #86868b;">
        자동 생성됩니다 (예: ITEM-0001)
      </div>
      <small class="text-muted">품목코드는 시스템에서 자동으로 부여됩니다</small>
    </div>

    <!-- 바코드 -->
    <div class="col-md-6">
      <label for="item_barcode" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        바코드
      </label>
      <div class="input-group">
        <%= f.text_field :barcode, class: "form-control", placeholder: "예: 8801234567890", id: "item_barcode_input" %>
        <button type="button" class="btn btn-outline-primary" id="item_barcode_scan_btn">
          <i class="bi bi-upc-scan"></i> 스캔
        </button>
      </div>
      <small class="text-muted">입고 시 바코드 스캔으로 품목 자동 입력</small>
    </div>

    <!-- 품목명 -->
    <div class="col-md-6">
      <label for="item_name" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        품목명 <span class="text-danger">*</span>
      </label>
      <%= f.text_field :name, class: "form-control", placeholder: "예: 밀가루", required: true %>
    </div>

    <!-- 카테고리 -->
    <div class="col-md-6">
      <label for="item_category" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        카테고리
      </label>
      <%= f.select :category,
                   options_for_select(@item_categories.map(&:name), item.category),
                   { include_blank: "선택" },
                   class: "form-select" %>
      <small class="text-muted">설정에서 카테고리를 추가할 수 있습니다</small>
    </div>

    <!-- 개당 중량 -->
    <div class="col-md-6">
      <label for="item_weight" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        개당 중량
      </label>
      <%= f.number_field :weight,
                         class: "form-control",
                         step: "0.01",
                         placeholder: "0",
                         min: "0" %>
      <small class="text-muted">품목의 개당 중량</small>
    </div>

    <!-- 중량 단위 -->
    <div class="col-md-6">
      <label for="item_weight_unit" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        중량 단위
      </label>
      <%= f.select :weight_unit,
                   options_for_select(['Kg', 'g', 'L', 'mL'], item.weight_unit),
                   { include_blank: "선택" },
                   class: "form-select" %>
      <small class="text-muted">중량의 단위</small>
    </div>

    <!-- 최소재고량 -->
    <div class="col-md-6">
      <label for="item_minimum_stock" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        최소재고량
      </label>
      <%= f.number_field :minimum_stock,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "0" %>
      <small class="text-muted">경고 수량</small>
    </div>

    <!-- 적정재고량 -->
    <div class="col-md-6">
      <label for="item_optimal_stock" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        적정재고량
      </label>
      <%= f.number_field :optimal_stock,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "0" %>
      <small class="text-muted">권장 재고</small>
    </div>

    <!-- 보관위치 -->
    <div class="col-md-6">
      <label for="item_storage_location" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        보관위치
      </label>
      <%= f.select :storage_location,
                   options_for_select(@storage_locations.map(&:name), item.storage_location),
                   { include_blank: "선택" },
                   class: "form-select" %>
      <small class="text-muted">설정에서 보관위치를 추가할 수 있습니다</small>
    </div>

    <!-- 제조일로부터 (유통기한 일수) -->
    <div class="col-md-6">
      <label for="item_shelf_life_days" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        제조일로부터 (일)
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           title="입고 시 제조일 입력 시 자동으로 유통기한이 계산됩니다"></i>
      </label>
      <%= f.number_field :shelf_life_days,
                         class: "form-control",
                         placeholder: "예: 365 (1년)",
                         min: "1" %>
      <small class="text-muted">제조일 + 이 일수 = 유통기한 (입고 처리 시 자동 계산)</small>
    </div>

    <!-- 공급업체 -->
    <div class="col-12">
      <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        공급업체
      </label>
      <div id="suppliers-container">
        <% suppliers = (item.suppliers.is_a?(Array) ? item.suppliers : []).presence || [""] %>
        <% suppliers.each_with_index do |supplier, index| %>
          <div class="input-group mb-2 supplier-input-group">
            <input type="text" name="item[suppliers][]" value="<%= supplier %>" class="form-control" placeholder="예: 주식회사 ABC">
            <button type="button" class="btn btn-outline-danger remove-supplier" <%= 'style=display:none;' if index == 0 && suppliers.size == 1 %>>
              <i class="bi bi-dash-circle"></i>
            </button>
          </div>
        <% end %>
      </div>
      <button type="button" class="btn btn-sm btn-outline-primary" id="add-supplier">
        <i class="bi bi-plus-circle me-1"></i>공급업체 추가
      </button>
      <small class="text-muted d-block mt-2">여러 공급업체를 등록할 수 있습니다</small>
    </div>

    <!-- 비고 -->
    <div class="col-12">
      <label for="item_notes" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        비고
      </label>
      <%= f.text_area :notes,
                      class: "form-control",
                      rows: 4,
                      placeholder: "추가 설명이나 특이사항을 입력하세요" %>
    </div>
  </div>

  <!-- 버튼 그룹 -->
  <div class="d-flex gap-2 justify-content-end mt-4 pt-3 border-top">
    <%= f.submit (item.new_record? ? '등록' : '수정'), class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", inventory_items_path, class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<!-- Tooltip 초기화 및 공급업체 추가/제거 기능 -->
<script>
  // Turbo 환경과 일반 환경 모두 지원
  function initItemForm() {
    // URL 파라미터에서 바코드 값 읽어오기
    var urlParams = new URLSearchParams(window.location.search);
    var barcodeFromUrl = urlParams.get('barcode');
    if (barcodeFromUrl) {
      var barcodeInput = document.getElementById('item_barcode_input');
      if (barcodeInput) {
        barcodeInput.value = barcodeFromUrl;
        // 바코드 필드에 포커스
        barcodeInput.focus();
        // 사용자에게 안내 메시지 표시
        if (window.toast) {
          window.toast.info('바코드가 자동으로 입력되었습니다. 품목 정보를 입력해주세요.');
        }
      }
    }

    // Tooltip 초기화
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // 공급업체 추가 버튼
    document.getElementById('add-supplier').addEventListener('click', function() {
      var container = document.getElementById('suppliers-container');
      var newInput = document.createElement('div');
      newInput.className = 'input-group mb-2 supplier-input-group';
      newInput.innerHTML = `
        <input type="text" name="item[suppliers][]" class="form-control" placeholder="예: 주식회사 ABC">
        <button type="button" class="btn btn-outline-danger remove-supplier">
          <i class="bi bi-dash-circle"></i>
        </button>
      `;
      container.appendChild(newInput);
      updateRemoveButtons();
    });

    // 공급업체 제거 버튼 (이벤트 위임)
    document.getElementById('suppliers-container').addEventListener('click', function(e) {
      if (e.target.closest('.remove-supplier')) {
        e.target.closest('.supplier-input-group').remove();
        updateRemoveButtons();
      }
    });

    // 제거 버튼 표시 업데이트 함수
    function updateRemoveButtons() {
      var groups = document.querySelectorAll('.supplier-input-group');
      groups.forEach(function(group, index) {
        var removeBtn = group.querySelector('.remove-supplier');
        if (groups.length === 1) {
          removeBtn.style.display = 'none';
        } else {
          removeBtn.style.display = 'block';
        }
      });
    }

    // 바코드 스캔 기능 (새로운 모달 방식)
    var itemBarcodeScanBtn = document.getElementById('item_barcode_scan_btn');

    if (itemBarcodeScanBtn) {
      // 기존 이벤트 리스너 제거 후 추가 (중복 방지)
      itemBarcodeScanBtn.replaceWith(itemBarcodeScanBtn.cloneNode(true));
      var newBarcodeScanBtn = document.getElementById('item_barcode_scan_btn');
      newBarcodeScanBtn.addEventListener('click', function() {
        window.openBarcodeScanner('item_barcode_input');
      });
    }
  }

  // Turbo 환경 지원
  document.addEventListener('turbo:load', initItemForm);
  // 일반 페이지 로드 (Turbo 없는 경우)
  document.addEventListener('DOMContentLoaded', initItemForm);
</script>
