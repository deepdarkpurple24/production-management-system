<%# encoding: UTF-8 %>
<%= form_with(model: [:inventory, receipt], local: true, class: "needs-validation") do |f| %>
  <% if receipt.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <%= pluralize(receipt.errors.count, "error") %> 발생
      </h5>
      <ul class="mb-0">
        <% receipt.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- 품목 선택 -->
    <div class="col-md-6">
      <label for="receipt_item_id" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        품목 <span class="text-danger">*</span>
      </label>
      <%= f.collection_select :item_id,
                              @items,
                              :id,
                              :name,
                              { include_blank: "품목을 선택하세요", selected: receipt.item_id },
                              { class: "form-select", required: true, id: "receipt_item_id" } %>
      <small class="text-muted">입고할 품목을 선택하세요</small>
    </div>

    <!-- 입고일 -->
    <div class="col-md-6">
      <label for="receipt_receipt_date" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        입고일 <span class="text-danger">*</span>
      </label>
      <%= f.date_field :receipt_date,
                       class: "form-control",
                       value: receipt.receipt_date || Date.today,
                       required: true,
                       id: "receipt_date_input" %>
      <small class="text-muted" id="receipt_date_day"></small>
    </div>

    <!-- 수량 -->
    <div class="col-md-6">
      <label for="receipt_quantity" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        수량 <span class="text-danger">*</span>
      </label>
      <%= f.number_field :quantity,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "1",
                         required: true %>
      <small class="text-muted">입고 수량을 입력하세요</small>
    </div>

    <!-- 개당 중량 -->
    <div class="col-md-3">
      <label for="receipt_unit_weight" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        개당 중량
      </label>
      <%= f.number_field :unit_weight,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "0" %>
      <small class="text-muted">개당 중량</small>
    </div>

    <!-- 중량 단위 -->
    <div class="col-md-3">
      <label for="receipt_unit_weight_unit" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        중량 단위
      </label>
      <%= f.select :unit_weight_unit,
                   options_for_select(['Kg', 'g', 'L', 'mL'], receipt.unit_weight_unit),
                   { include_blank: "선택" },
                   class: "form-select" %>
      <small class="text-muted">중량 단위</small>
    </div>

    <!-- 제조일 -->
    <div class="col-md-6">
      <label for="receipt_manufacturing_date" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        제조일
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           title="제조일을 입력하면 품목에 설정된 유통기한 일수에 따라 자동으로 유통기한이 계산됩니다"></i>
      </label>
      <%= f.date_field :manufacturing_date, class: "form-control", id: "manufacturing_date_input" %>
      <small class="text-muted" id="manufacturing_date_day">제조일 입력 시 유통기한 자동 계산</small>
    </div>

    <!-- 유통기한 -->
    <div class="col-md-6">
      <label for="receipt_expiration_date" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        유통기한
      </label>
      <%= f.date_field :expiration_date, class: "form-control", id: "expiration_date_input" %>
      <small class="text-muted" id="expiration_date_day">직접 입력 또는 제조일을 통한 자동 계산</small>
    </div>

    <!-- 개당 단가 -->
    <div class="col-md-6">
      <label for="receipt_unit_price" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        개당 단가
      </label>
      <div class="input-group">
        <%= f.text_field :unit_price,
                         class: "form-control",
                         placeholder: "0",
                         id: "receipt_unit_price_input",
                         data: { original_value: receipt.unit_price } %>
        <span class="input-group-text">(원)</span>
      </div>
      <small class="text-muted">개당 단가 (선택사항)</small>
    </div>

    <!-- 공급업체 -->
    <div class="col-md-12">
      <label for="receipt_supplier" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        공급업체
      </label>
      <%= f.text_field :supplier, class: "form-control", placeholder: "예: 주식회사 ABC" %>
    </div>

    <!-- 비고 -->
    <div class="col-12">
      <label for="receipt_notes" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        비고
      </label>
      <%= f.text_area :notes,
                      class: "form-control",
                      rows: 4,
                      placeholder: "추가 설명이나 특이사항을 입력하세요" %>
    </div>
  </div>

  <!-- 버튼 그룹 -->
  <div class="d-flex gap-2 justify-content-end mt-4 pt-3 border-top">
    <%= link_to "취소", inventory_receipts_path, class: "btn-apple btn-apple-outline" %>
    <%= f.submit "#{receipt.new_record? ? '등록' : '수정'}하기", class: "btn-apple btn-apple-primary" %>
  </div>
<% end %>

<!-- Tooltip 초기화, 개당 단가 포맷팅, 요일 표시 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tooltip 초기화
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // 요일 표시 함수
    function showDayOfWeek(dateInput, dayElement, prefix) {
      var date = new Date(dateInput.value);
      if (dateInput.value && !isNaN(date)) {
        var days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        var dayOfWeek = days[date.getDay()];
        dayElement.textContent = prefix ? prefix + ' (' + dayOfWeek + ')' : '(' + dayOfWeek + ')';
      } else {
        dayElement.textContent = prefix || '';
      }
    }

    // 입고일 요일 표시
    var receiptDateInput = document.getElementById('receipt_date_input');
    var receiptDateDay = document.getElementById('receipt_date_day');
    if (receiptDateInput && receiptDateDay) {
      // 초기 로드 시 요일 표시
      showDayOfWeek(receiptDateInput, receiptDateDay, '');
      // 날짜 변경 시 요일 업데이트
      receiptDateInput.addEventListener('change', function() {
        showDayOfWeek(receiptDateInput, receiptDateDay, '');
      });
    }

    // 제조일 요일 표시
    var manufacturingDateInput = document.getElementById('manufacturing_date_input');
    var manufacturingDateDay = document.getElementById('manufacturing_date_day');
    if (manufacturingDateInput && manufacturingDateDay) {
      // 초기 로드 시 요일 표시
      if (manufacturingDateInput.value) {
        showDayOfWeek(manufacturingDateInput, manufacturingDateDay, '제조일 입력 시 유통기한 자동 계산');
      }
      // 날짜 변경 시 요일 업데이트
      manufacturingDateInput.addEventListener('change', function() {
        if (manufacturingDateInput.value) {
          showDayOfWeek(manufacturingDateInput, manufacturingDateDay, '제조일 입력 시 유통기한 자동 계산');
        } else {
          manufacturingDateDay.textContent = '제조일 입력 시 유통기한 자동 계산';
        }
      });
    }

    // 유통기한 요일 표시
    var expirationDateInput = document.getElementById('expiration_date_input');
    var expirationDateDay = document.getElementById('expiration_date_day');
    if (expirationDateInput && expirationDateDay) {
      // 초기 로드 시 요일 표시
      if (expirationDateInput.value) {
        showDayOfWeek(expirationDateInput, expirationDateDay, '직접 입력 또는 제조일을 통한 자동 계산');
      }
      // 날짜 변경 시 요일 업데이트
      expirationDateInput.addEventListener('change', function() {
        if (expirationDateInput.value) {
          showDayOfWeek(expirationDateInput, expirationDateDay, '직접 입력 또는 제조일을 통한 자동 계산');
        } else {
          expirationDateDay.textContent = '직접 입력 또는 제조일을 통한 자동 계산';
        }
      });
    }

    // 개당 단가 필드 포맷팅
    var unitPriceInput = document.getElementById('receipt_unit_price_input');
    if (unitPriceInput) {
      // 초기값이 있으면 콤마 포맷 적용
      if (unitPriceInput.dataset.originalValue && unitPriceInput.dataset.originalValue !== '') {
        var initialValue = parseInt(unitPriceInput.dataset.originalValue);
        unitPriceInput.value = initialValue.toLocaleString('ko-KR');
      }

      // 입력 시 콤마 자동 추가
      unitPriceInput.addEventListener('input', function(e) {
        var value = e.target.value.replace(/,/g, ''); // 기존 콤마 제거
        if (value && !isNaN(value)) {
          e.target.value = parseInt(value).toLocaleString('ko-KR');
        }
      });

      // 폼 제출 시 콤마 제거
      unitPriceInput.closest('form').addEventListener('submit', function() {
        unitPriceInput.value = unitPriceInput.value.replace(/,/g, '');
      });
    }
  });
</script>
