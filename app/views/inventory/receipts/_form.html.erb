<%# encoding: UTF-8 %>
<%= form_with(model: [:inventory, receipt], local: true, class: "needs-validation") do |f| %>
  <% if receipt.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <%= pluralize(receipt.errors.count, "error") %> 발생
      </h5>
      <ul class="mb-0">
        <% receipt.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- 바코드 입력/스캔 -->
    <div class="col-12">
      <label for="barcode_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        바코드
      </label>
      <div class="input-group">
        <input type="text" id="barcode_input" class="form-control" placeholder="바코드 번호를 입력하거나 스캔하세요">
        <button type="button" class="btn btn-outline-primary" id="barcode_scan_btn">
          <i class="bi bi-upc-scan"></i> 스캔
        </button>
      </div>
      <small class="text-muted">바코드를 입력하거나 스캔하면 품목이 자동으로 선택됩니다</small>
    </div>

    <!-- 품목 선택 -->
    <div class="col-md-6">
      <label for="receipt_item_id" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        품목 <span class="text-danger">*</span>
      </label>
      <div class="input-group">
        <%= f.collection_select :item_id,
                                @items,
                                :id,
                                :name,
                                { include_blank: "품목을 선택하세요", selected: receipt.item_id },
                                { class: "form-select", required: true, id: "receipt_item_id" } %>
        <%= link_to new_inventory_item_path, class: "btn btn-outline-primary", target: "_blank" do %>
          <i class="bi bi-plus-circle"></i> 새 품목
        <% end %>
      </div>
      <small class="text-muted">입고할 품목을 선택하세요</small>
    </div>

    <!-- 입고일 -->
    <div class="col-md-6">
      <label for="receipt_date_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        입고일 <span class="text-danger">*</span>
      </label>
      <%= f.text_field :receipt_date,
                       value: receipt.receipt_date&.strftime('%Y-%m-%d'),
                       required: true,
                       id: "receipt_date_input",
                       class: "form-control flatpickr",
                       placeholder: "날짜를 선택하세요",
                       readonly: true %>
    </div>

    <!-- 수량 -->
    <div class="col-md-6">
      <label for="receipt_quantity" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        수량 <span class="text-danger">*</span>
      </label>
      <%= f.number_field :quantity,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "1",
                         required: true %>
      <small class="text-muted">입고 수량을 입력하세요</small>
    </div>

    <!-- 개당 중량 -->
    <div class="col-md-3">
      <label for="receipt_unit_weight" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        개당 중량
      </label>
      <%= f.number_field :unit_weight,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "0",
                         id: "receipt_unit_weight" %>
      <small class="text-muted">개당 중량</small>
    </div>

    <!-- 중량 단위 -->
    <div class="col-md-3">
      <label for="receipt_unit_weight_unit" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        중량 단위
      </label>
      <%= f.select :unit_weight_unit,
                   options_for_select(['Kg', 'g', 'L', 'mL'], receipt.unit_weight_unit),
                   { include_blank: "선택" },
                   { class: "form-select", id: "receipt_unit_weight_unit" } %>
      <small class="text-muted">중량 단위</small>
    </div>

    <!-- 제조일 -->
    <div class="col-md-6">
      <label for="manufacturing_date_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        제조일
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           title="제조일을 입력하면 품목에 설정된 유통기한 일수에 따라 자동으로 유통기한이 계산됩니다"></i>
      </label>
      <%= f.text_field :manufacturing_date,
                       value: receipt.manufacturing_date&.strftime('%Y-%m-%d'),
                       id: "manufacturing_date_input",
                       class: "form-control flatpickr",
                       placeholder: "날짜를 선택하세요",
                       readonly: true %>
      <small class="text-muted">제조일 입력 시 유통기한 자동 계산</small>
    </div>

    <!-- 유통기한 -->
    <div class="col-md-6">
      <label for="expiration_date_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        유통기한
      </label>
      <%= f.text_field :expiration_date,
                       value: receipt.expiration_date&.strftime('%Y-%m-%d'),
                       id: "expiration_date_input",
                       class: "form-control flatpickr",
                       placeholder: "날짜를 선택하세요",
                       readonly: true %>
      <small class="text-muted">직접 입력 또는 제조일을 통한 자동 계산</small>
    </div>

    <!-- 개당 단가 -->
    <div class="col-md-6">
      <label for="receipt_unit_price" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        개당 단가
      </label>
      <div class="input-group">
        <%= f.text_field :unit_price,
                         class: "form-control",
                         placeholder: "0",
                         id: "receipt_unit_price_input",
                         data: { original_value: receipt.unit_price } %>
        <span class="input-group-text">(원)</span>
      </div>
      <small class="text-muted">개당 단가 (선택사항)</small>
    </div>

    <!-- 공급업체 -->
    <div class="col-md-6">
      <label for="receipt_supplier" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        공급업체
      </label>
      <div class="input-group">
        <select id="supplier_select" class="form-select" data-lpignore="true" data-form-type="other">
          <option value="">공급업체를 선택하세요</option>
        </select>
        <%= f.hidden_field :supplier, id: "receipt_supplier_hidden" %>
        <button type="button" class="btn btn-outline-primary" id="add-new-supplier-btn">
          <i class="bi bi-plus-circle"></i> 새 공급업체
        </button>
      </div>
      <div id="new-supplier-input" style="display: none;" class="mt-2">
        <div class="input-group">
          <input type="text" id="new_supplier_text" class="form-control" placeholder="새 공급업체 이름을 입력하세요">
          <button type="button" class="btn btn-success" id="save-new-supplier">저장</button>
          <button type="button" class="btn-modern btn-modern-outline" id="cancel-new-supplier">취소</button>
        </div>
      </div>
    </div>

    <!-- 입고 요청자 (자동 입력) -->
    <div class="col-md-6">
      <label for="receipt_requester" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        입고 요청자
      </label>
      <div class="input-group">
        <input type="text"
               value="<%= current_user.name %>"
               class="form-control"
               readonly
               style="background-color: #f5f5f7; cursor: not-allowed;">
        <span class="input-group-text" style="background-color: #f5f5f7;">
          <i class="bi bi-person-check-fill text-success"></i>
        </span>
      </div>
      <small class="text-muted">현재 로그인한 사용자가 자동으로 요청자로 등록됩니다</small>
    </div>

    <!-- 비고 -->
    <div class="col-12">
      <label for="receipt_notes" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        비고
      </label>
      <%= f.text_area :notes,
                      class: "form-control",
                      rows: 4,
                      placeholder: "추가 설명이나 특이사항을 입력하세요" %>
    </div>
  </div>

  <!-- 버튼 그룹 -->
  <div class="d-flex gap-2 justify-content-end mt-4 pt-3 border-top">
    <%= f.submit receipt.new_record? ? '등록' : '수정', class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", inventory_receipts_path, class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<!-- Tooltip 초기화, 개당 단가 포맷팅, Flatpickr 초기화, 공급업체 관리 -->
<script>
  // Turbo 환경에서도 작동하도록 turbo:load 이벤트 사용
  document.addEventListener('turbo:load', function() {
    // Tooltip 초기화
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Flatpickr 초기화 (한국어, YYYY-MM-DD 형식)
    flatpickr('.flatpickr', {
      locale: 'ko',
      dateFormat: 'Y-m-d',
      allowInput: false,
      disableMobile: true
    });

    // 품목 선택 시 공급업체 목록 업데이트
    var itemSelect = document.getElementById('receipt_item_id');
    var supplierSelect = document.getElementById('supplier_select');
    var supplierHidden = document.getElementById('receipt_supplier_hidden');
    var currentItemId = null;

    console.log('supplierSelect 요소:', supplierSelect);
    console.log('supplierSelect가 존재하는가?', supplierSelect !== null);

    <% if receipt.persisted? && receipt.item %>
      // 수정 모드: 초기 공급업체 목록 로드
      currentItemId = <%= receipt.item.id %>;
      loadSuppliers(<%= receipt.item.id %>, '<%= receipt.supplier %>');
    <% end %>

    if (itemSelect) {
      itemSelect.addEventListener('change', function() {
        var itemId = this.value;
        console.log('품목 선택됨:', itemId);
        currentItemId = itemId;
        if (itemId) {
          console.log('공급업체 로딩 시작:', itemId);
          loadSuppliers(itemId);
        } else {
          supplierSelect.innerHTML = '<option value="">공급업체를 선택하세요</option>';
          supplierHidden.value = '';
        }
      });
      console.log('품목 선택 이벤트 리스너 등록 완료');
    } else {
      console.error('품목 선택 요소를 찾을 수 없습니다');
    }

    // 공급업체 선택 시 hidden 필드 업데이트
    if (supplierSelect && supplierHidden) {
      supplierSelect.addEventListener('change', function() {
        supplierHidden.value = this.value;
      });
    }

    // 공급업체 목록 로드 함수
    function loadSuppliers(itemId, selectedSupplier) {
      console.log('loadSuppliers 함수 호출됨, itemId:', itemId, 'selectedSupplier:', selectedSupplier);
      var url = '/inventory/items/' + itemId + '/suppliers';
      console.log('API URL:', url);

      fetch(url)
        .then(response => {
          console.log('API 응답 상태:', response.status, response.ok);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log('받은 데이터:', data);
          console.log('supplierSelect 요소 상태:', supplierSelect);
          console.log('supplierSelect innerHTML 변경 전:', supplierSelect.innerHTML);

          supplierSelect.innerHTML = '<option value="">공급업체를 선택하세요</option>';
          console.log('supplierSelect innerHTML 변경 후:', supplierSelect.innerHTML);

          // 중량 정보 자동 입력
          console.log('중량 정보 로드:', data.weight, data.weight_unit);
          if (data.weight) {
            var unitWeightInput = document.getElementById('receipt_unit_weight');
            console.log('개당 중량 필드:', unitWeightInput);
            if (unitWeightInput) {
              unitWeightInput.value = data.weight;
              console.log('개당 중량 설정됨:', data.weight);
            }
          }
          if (data.weight_unit) {
            var unitWeightUnitSelect = document.getElementById('receipt_unit_weight_unit');
            console.log('중량 단위 필드:', unitWeightUnitSelect);
            console.log('설정할 값:', data.weight_unit);
            if (unitWeightUnitSelect) {
              unitWeightUnitSelect.value = data.weight_unit;
              console.log('중량 단위 설정됨:', unitWeightUnitSelect.value);
            } else {
              console.error('중량 단위 select 요소를 찾을 수 없습니다');
            }
          }

          if (data.suppliers && Array.isArray(data.suppliers) && data.suppliers.length > 0) {
            console.log('공급업체 개수:', data.suppliers.length);
            data.suppliers.forEach(function(supplier) {
              if (supplier && supplier.trim() !== '') {
                console.log('공급업체 추가 중:', supplier);
                var option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                if (selectedSupplier && supplier === selectedSupplier) {
                  option.selected = true;
                  supplierHidden.value = supplier;
                }
                supplierSelect.appendChild(option);
                console.log('추가 완료, 현재 option 개수:', supplierSelect.options.length);
              }
            });
            console.log('공급업체 로딩 완료, 최종 option 개수:', supplierSelect.options.length);
            console.log('최종 innerHTML:', supplierSelect.innerHTML);

            // 강제로 select를 다시 렌더링
            var event = new Event('change');
            supplierSelect.dispatchEvent(event);

            // 짧은 지연 후 화면 갱신
            setTimeout(function() {
              supplierSelect.blur();
              supplierSelect.focus();
            }, 50);
          } else {
            console.log('공급업체 없음');
          }
        })
        .catch(error => {
          console.error('공급업체 로딩 에러:', error);
        });
    }

    // 새 공급업체 추가 버튼
    var addNewSupplierBtn = document.getElementById('add-new-supplier-btn');
    if (addNewSupplierBtn) {
      addNewSupplierBtn.addEventListener('click', function() {
        if (!currentItemId) {
          alert('먼저 품목을 선택해주세요.');
          return;
        }
        document.getElementById('new-supplier-input').style.display = 'block';
        document.getElementById('new_supplier_text').focus();
      });
    }

    // 새 공급업체 저장
    var saveNewSupplierBtn = document.getElementById('save-new-supplier');
    if (saveNewSupplierBtn) {
      saveNewSupplierBtn.addEventListener('click', function() {
        var newSupplier = document.getElementById('new_supplier_text').value.trim();
        if (!newSupplier) {
          alert('공급업체 이름을 입력해주세요.');
          return;
        }
        if (!currentItemId) {
          alert('먼저 품목을 선택해주세요.');
          return;
        }

        // 서버에 새 공급업체 추가
        fetch('/inventory/items/' + currentItemId + '/add_supplier', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ supplier: newSupplier })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 드롭다운에 새 공급업체 추가
            var option = document.createElement('option');
            option.value = newSupplier;
            option.textContent = newSupplier;
            option.selected = true;
            supplierSelect.appendChild(option);
            supplierHidden.value = newSupplier;

            // 입력 필드 초기화 및 숨기기
            document.getElementById('new_supplier_text').value = '';
            document.getElementById('new-supplier-input').style.display = 'none';
          } else {
            alert('공급업체 추가 실패: ' + (data.error || '알 수 없는 오류'));
          }
        })
        .catch(error => {
          console.error('Error adding supplier:', error);
          alert('공급업체 추가 중 오류가 발생했습니다.');
        });
      });
    }

    // 새 공급업체 취소
    var cancelNewSupplierBtn = document.getElementById('cancel-new-supplier');
    if (cancelNewSupplierBtn) {
      cancelNewSupplierBtn.addEventListener('click', function() {
        document.getElementById('new_supplier_text').value = '';
        document.getElementById('new-supplier-input').style.display = 'none';
      });
    }

    // 개당 단가 필드 포맷팅
    var unitPriceInput = document.getElementById('receipt_unit_price_input');
    if (unitPriceInput) {
      // 초기값이 있으면 콤마 포맷 적용
      if (unitPriceInput.dataset.originalValue && unitPriceInput.dataset.originalValue !== '') {
        var initialValue = parseInt(unitPriceInput.dataset.originalValue);
        unitPriceInput.value = initialValue.toLocaleString('ko-KR');
      }

      // 입력 시 콤마 자동 추가
      unitPriceInput.addEventListener('input', function(e) {
        var value = e.target.value.replace(/,/g, ''); // 기존 콤마 제거
        if (value && !isNaN(value)) {
          e.target.value = parseInt(value).toLocaleString('ko-KR');
        }
      });

      // 폼 제출 시 콤마 제거
      unitPriceInput.closest('form').addEventListener('submit', function() {
        unitPriceInput.value = unitPriceInput.value.replace(/,/g, '');
      });
    }

    // 바코드 기능
    var barcodeInput = document.getElementById('barcode_input');
    var barcodeScanBtn = document.getElementById('barcode_scan_btn');

    // 바코드로 품목 검색 함수
    function searchItemByBarcode(barcode) {
      if (!barcode || barcode.trim() === '') {
        return;
      }

      fetch('/inventory/items/find_by_barcode?barcode=' + encodeURIComponent(barcode))
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 품목 선택
            itemSelect.value = data.item.id;
            itemSelect.dispatchEvent(new Event('change'));

            // 중량 정보 자동 입력
            console.log('바코드 - 중량 정보:', data.item.weight, data.item.weight_unit);
            if (data.item.weight) {
              var unitWeightInput = document.getElementById('receipt_unit_weight');
              if (unitWeightInput) {
                unitWeightInput.value = data.item.weight;
                console.log('바코드 - 개당 중량 설정됨:', data.item.weight);
              }
            }
            if (data.item.weight_unit) {
              var unitWeightUnitSelect = document.getElementById('receipt_unit_weight_unit');
              console.log('바코드 - 중량 단위 필드:', unitWeightUnitSelect);
              if (unitWeightUnitSelect) {
                unitWeightUnitSelect.value = data.item.weight_unit;
                console.log('바코드 - 중량 단위 설정됨:', unitWeightUnitSelect.value);
              }
            }

            // 공급업체 로드
            if (data.item.suppliers && data.item.suppliers.length > 0) {
              loadSuppliers(data.item.id);
            }

            alert('품목이 선택되었습니다: ' + data.item.name);
          } else {
            alert(data.error || '바코드를 찾을 수 없습니다.');
          }
        })
        .catch(error => {
          console.error('바코드 검색 에러:', error);
          alert('바코드 검색 중 오류가 발생했습니다.');
        });
    }

    // 바코드 수동 입력 처리
    if (barcodeInput) {
      barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchItemByBarcode(this.value);
        }
      });

      barcodeInput.addEventListener('blur', function() {
        if (this.value.trim() !== '') {
          searchItemByBarcode(this.value);
        }
      });
    }

    // 바코드 스캔 시작 (새로운 모달 방식)
    if (barcodeScanBtn) {
      barcodeScanBtn.addEventListener('click', function() {
        window.openBarcodeScanner('barcode_input', function(barcode) {
          // 바코드 스캔 성공 시 품목 검색
          searchItemByBarcode(barcode);
        });
      });
    }
  });
</script>
