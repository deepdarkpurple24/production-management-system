<%# encoding: UTF-8 %>
<%= form_with(model: [:inventory, shipment], local: true, class: "needs-validation") do |f| %>
  <% if shipment.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <%= pluralize(shipment.errors.count, "error") %> 발생
      </h5>
      <ul class="mb-0">
        <% shipment.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- 바코드 입력/스캔 -->
    <div class="col-12">
      <label for="barcode_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        바코드
      </label>
      <div class="input-group">
        <input type="text" id="barcode_input" class="form-control" placeholder="바코드 번호를 입력하거나 스캔하세요">
        <button type="button" class="btn btn-outline-primary" id="barcode_scan_btn">
          <i class="bi bi-upc-scan"></i> 스캔
        </button>
      </div>
      <small class="text-muted">바코드를 입력하거나 스캔하면 품목이 자동으로 선택됩니다</small>
    </div>

    <!-- 품목 선택 -->
    <div class="col-md-6">
      <label for="shipment_item_id" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        품목 <span class="text-danger">*</span>
      </label>
      <div class="d-flex gap-2">
        <%= f.collection_select :item_id,
                                @items,
                                :id,
                                ->(item) { "#{item.name}#{item.category.present? ? " [#{item.category}]" : ""}" },
                                { include_blank: "품목명을 입력하여 검색...", selected: shipment.item_id },
                                { class: "form-select tom-select-item", required: true, id: "shipment_item_id" } %>
        <%= link_to new_inventory_item_path, class: "btn btn-outline-primary flex-shrink-0", target: "_blank", style: "height: 38px;" do %>
          <i class="bi bi-plus-circle"></i>
        <% end %>
      </div>
      <small class="text-muted">품목명 또는 카테고리를 입력하여 검색하세요</small>
    </div>

    <!-- 출고일시 -->
    <div class="col-md-6">
      <label for="shipment_date_input" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        출고일시 <span class="text-danger">*</span>
      </label>
      <% current_seoul_time = Time.zone.now.strftime('%Y-%m-%d %H:%M') %>
      <%= f.text_field :shipment_date,
                       value: (shipment.shipment_date&.strftime('%Y-%m-%d %H:%M') || current_seoul_time),
                       required: true,
                       id: "shipment_date_input",
                       class: "form-control flatpickr-datetime",
                       placeholder: "날짜와 시간을 선택하세요",
                       readonly: true %>
    </div>

    <!-- 수량 -->
    <div class="col-md-6">
      <label for="shipment_quantity" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        수량 <span class="text-danger">*</span>
      </label>
      <%= f.number_field :quantity,
                         class: "form-control",
                         step: "1",
                         placeholder: "0",
                         min: "1",
                         required: true %>
      <small class="text-muted">출고 수량을 입력하세요</small>
    </div>

    <!-- 출고 목적 -->
    <div class="col-md-6">
      <label for="shipment_purpose" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        출고 목적
      </label>
      <div class="input-group">
        <%= f.text_field :purpose,
                         class: "form-control",
                         list: "purpose_list",
                         placeholder: "선택하거나 직접 입력하세요",
                         id: "shipment_purpose" %>
        <datalist id="purpose_list">
          <% @shipment_purposes.each do |purpose| %>
            <option value="<%= purpose.name %>">
          <% end %>
        </datalist>
        <%= link_to settings_system_path, class: "btn btn-outline-secondary", target: "_blank", title: "설정에서 관리" do %>
          <i class="bi bi-gear"></i>
        <% end %>
      </div>
      <small class="text-muted">목록에서 선택하거나 새로운 목적을 직접 입력하세요</small>
    </div>

    <!-- 출고 요청자 (자동 입력) -->
    <div class="col-md-12">
      <label for="shipment_requester" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        출고 요청자
      </label>
      <div class="input-group">
        <input type="text"
               value="<%= current_user.name %>"
               class="form-control"
               readonly
               style="background-color: #f5f5f7; cursor: not-allowed;">
        <span class="input-group-text" style="background-color: #f5f5f7;">
          <i class="bi bi-person-check-fill text-success"></i>
        </span>
      </div>
      <small class="text-muted">현재 로그인한 사용자가 자동으로 요청자로 등록됩니다</small>
    </div>

    <!-- 비고 -->
    <div class="col-12">
      <label for="shipment_notes" class="form-label" style="font-weight: 500; font-size: 0.875rem;">
        비고
      </label>
      <%= f.text_area :notes,
                      class: "form-control",
                      rows: 4,
                      placeholder: "추가 설명이나 특이사항을 입력하세요" %>
    </div>
  </div>

  <!-- 버튼 그룹 -->
  <div class="d-flex gap-2 justify-content-end mt-4 pt-3 border-top">
    <%= f.submit shipment.new_record? ? '등록' : '수정', class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", inventory_shipments_path, class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<!-- Flatpickr 초기화 및 바코드 기능 -->
<script>
  var shipmentTomSelectInstance = null;

  function initShipmentForm() {
    // Flatpickr 초기화 (날짜 + 시간)
    var shipmentDateInput = document.getElementById('shipment_date_input');
    var currentValue = shipmentDateInput ? shipmentDateInput.value : null;

    flatpickr('.flatpickr-datetime', {
      locale: 'ko',
      enableTime: true,
      dateFormat: 'Y-m-d H:i',
      time_24hr: true,
      allowInput: false,
      disableMobile: true,
      defaultDate: currentValue
    });

    // 바코드 기능
    var itemSelect = document.getElementById('shipment_item_id');
    var barcodeInput = document.getElementById('barcode_input');
    var barcodeScanBtn = document.getElementById('barcode_scan_btn');

    // Tom Select 초기화 (검색형 드롭다운)
    if (itemSelect && typeof TomSelect !== 'undefined') {
      // 기존 Tom Select 인스턴스가 있으면 제거
      if (shipmentTomSelectInstance) {
        shipmentTomSelectInstance.destroy();
        shipmentTomSelectInstance = null;
      }

      // 이미 Tom Select가 적용되어 있는지 확인
      if (!itemSelect.tomselect) {
        shipmentTomSelectInstance = new TomSelect(itemSelect, {
          placeholder: '품목명을 입력하여 검색...',
          allowEmptyOption: true,
          create: false,
          sortField: { field: 'text', direction: 'asc' },
          searchField: ['text'],
          maxOptions: 100,
          render: {
            option: function(data, escape) {
              return '<div class="py-2 px-3">' + escape(data.text) + '</div>';
            },
            item: function(data, escape) {
              return '<div>' + escape(data.text) + '</div>';
            },
            no_results: function(data, escape) {
              return '<div class="no-results py-2 px-3 text-muted">검색 결과가 없습니다</div>';
            }
          }
        });
      }
    }

    // 바코드로 품목 검색 함수
    function searchItemByBarcode(barcode) {
      if (!barcode || barcode.trim() === '') {
        return;
      }

      fetch('/inventory/items/find_by_barcode?barcode=' + encodeURIComponent(barcode))
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 품목 선택 (Tom Select 지원)
            if (itemSelect.tomselect) {
              itemSelect.tomselect.setValue(data.item.id, true);
            } else {
              itemSelect.value = data.item.id;
            }
            itemSelect.dispatchEvent(new Event('change'));
            if (window.toast) {
              window.toast.success('품목이 선택되었습니다: ' + data.item.name);
            }
          } else {
            // 바코드는 인식되었지만 등록된 품목이 없는 경우
            var message = '등록되지 않은 품목입니다.\n\n품목 등록 페이지로 이동하시겠습니까?';
            if (confirm(message)) {
              // 품목 등록 페이지로 이동 (바코드 값 전달)
              window.location.href = '/inventory/items/new?barcode=' + encodeURIComponent(barcode);
            }
          }
        })
        .catch(error => {
          console.error('바코드 검색 에러:', error);
          if (window.toast) {
            window.toast.error('바코드 검색 중 오류가 발생했습니다.');
          } else {
            alert('바코드 검색 중 오류가 발생했습니다.');
          }
        });
    }

    // 바코드 수동 입력 처리
    if (barcodeInput) {
      barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchItemByBarcode(this.value);
        }
      });

      barcodeInput.addEventListener('blur', function() {
        if (this.value.trim() !== '') {
          searchItemByBarcode(this.value);
        }
      });
    }

    // 바코드 스캔 시작 (새로운 모달 방식)
    if (barcodeScanBtn) {
      // 기존 이벤트 리스너 제거 후 추가 (중복 방지)
      barcodeScanBtn.replaceWith(barcodeScanBtn.cloneNode(true));
      var newBarcodeScanBtn = document.getElementById('barcode_scan_btn');
      newBarcodeScanBtn.addEventListener('click', function() {
        window.openBarcodeScanner('barcode_input', function(barcode) {
          // 바코드 스캔 성공 시 품목 검색
          searchItemByBarcode(barcode);
        });
      });
    }
  }

  // Turbo 환경 지원
  document.addEventListener('turbo:load', initShipmentForm);
  // 일반 페이지 로드 (Turbo 없는 경우)
  document.addEventListener('DOMContentLoaded', initShipmentForm);
</script>
