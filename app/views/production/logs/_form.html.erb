<%
  form_url = @production_log.new_record? ? production_logs_path : production_log_path(@production_log)
  form_method = @production_log.new_record? ? :post : :patch
%>
<%= form_with(model: @production_log, url: form_url, method: form_method, local: true) do |form| %>
  <% if @production_log.errors.any? %>
    <div class="alert alert-danger mb-4" role="alert">
      <h5 class="alert-heading mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= pluralize(@production_log.errors.count, "error") %> prohibited this production log from being saved:
      </h5>
      <ul class="mb-0">
        <% @production_log.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- ìƒì‚° ê³„íš ì„ íƒ (Optional) -->
  <div class="mb-3">
    <%= form.label :production_plan_id, "ìƒì‚° ê³„íš", class: "form-label", style: "font-weight: 500;" %>
    <%= form.select :production_plan_id,
                    options_from_collection_for_select(@production_plans, :id,
                      ->(plan) { "#{plan.finished_product.name} - #{plan.production_date} (#{plan.quantity}ê°œ)" },
                      @production_log.production_plan_id),
                    { prompt: "ìƒì‚° ê³„íš ì„ íƒ (ì„ íƒì‚¬í•­)" },
                    class: "form-select",
                    id: "production_plan_select" %>
    <small class="form-text text-muted">ì‚¬ì „ì— ë“±ë¡í•œ ìƒì‚° ê³„íšì„ ì„ íƒí•˜ë©´ ì™„ì œí’ˆê³¼ ë‚ ì§œê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</small>
  </div>

  <!-- ì™„ì œí’ˆ ì„ íƒ -->
  <div class="mb-3">
    <%= form.label :finished_product_id, "ì™„ì œí’ˆ", class: "form-label", style: "font-weight: 500;" %>
    <span class="text-danger">*</span>
    <%= form.select :finished_product_id,
                    options_from_collection_for_select(@finished_products, :id, :name, @production_log.finished_product_id),
                    { prompt: "ì™„ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”" },
                    class: "form-select",
                    required: true,
                    id: "finished_product_select" %>
    <small class="form-text text-muted">ìƒì‚°í•œ ì™„ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.</small>
  </div>

  <!-- ìƒì‚° ì¼ì‹œ -->
  <div class="row mb-3">
    <div class="col-md-6">
      <%= form.label :production_date, "ìƒì‚° ì¼ì", class: "form-label", style: "font-weight: 500;" %>
      <span class="text-danger">*</span>
      <%= form.date_field :production_date,
                          class: "form-control",
                          required: true %>
      <small class="form-text text-muted">ì‹¤ì œ ìƒì‚°í•œ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</small>
    </div>

    <div class="col-md-6">
      <%= form.label :production_time, "ìƒì‚° ì‹œê°„", class: "form-label", style: "font-weight: 500;" %>
      <%= form.time_field :production_time,
                          class: "form-control",
                          placeholder: "ì˜ˆ: 09:00" %>
      <small class="form-text text-muted">ìƒì‚° ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­).</small>
    </div>
  </div>

  <!-- ê¸°ì •ë–¡ ì „ìš© í•„ë“œ ì„¹ì…˜ -->
  <div id="gijeongddeok-fields" style="display: none;">
    <hr class="my-4">
    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
      <i class="bi bi-clipboard-data me-2"></i>ê¸°ì •ë–¡ ìƒì‚° ìƒì„¸ ì •ë³´
    </h5>

    <%
      # ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™” (ìˆœì„œ ë³´ì¥)
      category_order = ['production', 'temperature', 'ingredient', 'makgeolli', 'other']
      category_names = {
        'production' => { name: 'ğŸ“Š ìƒì‚° ì •ë³´', cols: 4 },
        'temperature' => { name: 'ğŸŒ¡ï¸ ì˜¨ë„ ê´€ë¦¬', cols: 4 },
        'ingredient' => { name: 'ğŸ“¦ ì¬ë£Œ íˆ¬ì…ëŸ‰', cols: 4 },
        'makgeolli' => { name: 'ğŸ¶ ë§‰ê±¸ë¦¬ ê´€ë¦¬', cols: 6 },
        'other' => { name: 'ğŸ”§ ê¸°íƒ€', cols: 4 }
      }

      grouped_fields = @gijeongddeok_fields.group_by(&:category)
    %>

    <% category_order.each do |category| %>
      <% next unless grouped_fields[category].present? %>
      <% fields = grouped_fields[category] %>
      <div class="card mb-3">
        <div class="card-header" style="background-color: #f5f5f7;">
          <h6 class="mb-0" style="font-weight: 500;"><%= category_names[category][:name] %></h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <% fields.each do |field| %>
              <div class="col-md-<%= category_names[category][:cols] %>">
                <%= form.label field.field_name, field.label, class: "form-label" %>
                <div class="input-group">
                  <% if field.field_name == 'dough_count' %>
                    <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= field.field_name %>', -0.5)">
                      <i class="bi bi-dash"></i>
                    </button>
                  <% end %>
                  <%= form.number_field field.field_name,
                                        step: field.field_name == 'dough_count' ? 0.5 : ((field.field_name.ends_with?('_temp') || ['steiva_amount', 'water_amount', 'makgeolli_consumption'].include?(field.field_name)) ? 0.1 : 1),
                                        class: "form-control",
                                        id: "production_log_#{field.field_name}" %>
                  <% if field.field_name == 'dough_count' %>
                    <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= field.field_name %>', 0.5)">
                      <i class="bi bi-plus"></i>
                    </button>
                    <span class="input-group-text">í†µ</span>
                  <% else %>
                    <span class="input-group-text">
                      <%= case field.field_name
                          when /temp$/
                            'Â°C'
                          when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                            'g'
                          when 'water_amount'
                            'L'
                          when 'makgeolli_consumption'
                            'mL'
                          else
                            ''
                          end %>
                    </span>
                  <% end %>
                </div>
                <% if field.field_name == 'makgeolli_consumption' %>
                  <small class="form-text text-muted">ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì¬ê³  ì¶œê³  ì²˜ë¦¬ë©ë‹ˆë‹¤.</small>
                <% end %>
              </div>
            <% end %>

            <% if category == 'makgeolli' %>
              <div class="col-md-6">
                <%= form.label :makgeolli_expiry_date, "ë§‰ê±¸ë¦¬ ìœ íš¨ê¸°ê°„", class: "form-label" %>
                <%= form.date_field :makgeolli_expiry_date,
                                    class: "form-control" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- ê¸°ë³¸ ë¹„ê³  -->
  <div class="mb-3">
    <%= form.label :notes, "ë¹„ê³ ", class: "form-label", style: "font-weight: 500;" %>
    <%= form.text_area :notes,
                       class: "form-control",
                       rows: 3,
                       placeholder: "ìƒì‚° ê³¼ì • ì¤‘ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" %>
  </div>

  <%= form.hidden_field :view, value: params[:view] %>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <%= form.submit @production_log.new_record? ? "ë“±ë¡" : "ìˆ˜ì •",
                    class: "btn-modern btn-modern-primary" %>
    <%= link_to "ì·¨ì†Œ", production_logs_path(view: params[:view] || 'monthly', date: @production_log.production_date || Date.today),
                class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<script>
function initProductionLogForm() {
  const finishedProductSelect = document.getElementById('finished_product_select');
  const productionPlanSelect = document.getElementById('production_plan_select');
  const gijeongddeokFields = document.getElementById('gijeongddeok-fields');

  if (!finishedProductSelect || !productionPlanSelect || !gijeongddeokFields) {
    return;
  }

  // ìƒì‚° ê³„íš ë°ì´í„° (ë°˜ì£½í†µìˆ˜ í¬í•¨)
  const productionPlansData = {
    <% @production_plans.each do |plan| %>
      <%= plan.id %>: {
        finished_product_id: <%= plan.finished_product_id %>,
        production_date: '<%= plan.production_date %>',
        quantity: <%= plan.quantity || 0 %>
      },
    <% end %>
  };

  // ê¸°ì •ë–¡ ê¸°ë³¸ê°’ ë°ì´í„°
  const gijeongddeokDefaults = {
    <% @gijeongddeok_fields.each do |field| %>
      <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
    <% end %>
  };

  // ê¸°ë³¸ê°’ ë¡œë“œ ì—¬ë¶€ í”Œë˜ê·¸
  let defaultsLoaded = false;

  // ìƒì‚°ê³„íš ì„ íƒ ì‹œ ì²˜ë¦¬
  productionPlanSelect.addEventListener('change', function() {
    const selectedPlanId = this.value;

    if (selectedPlanId && productionPlansData[selectedPlanId]) {
      const plan = productionPlansData[selectedPlanId];

      // ì™„ì œí’ˆ ìë™ ì„ íƒ
      finishedProductSelect.value = plan.finished_product_id;

      // ìƒì‚° ë‚ ì§œ ìë™ ì…ë ¥
      const productionDateField = document.getElementById('production_log_production_date');
      if (productionDateField) {
        productionDateField.value = plan.production_date;
      }

      // ë°˜ì£½í†µìˆ˜ ìë™ ì…ë ¥ (dough_count í•„ë“œ)
      const doughCountField = document.getElementById('production_log_dough_count');
      if (doughCountField && plan.quantity > 0) {
        doughCountField.value = plan.quantity;
      }

      // ì™„ì œí’ˆ ë³€ê²½ì— ë”°ë¥¸ ê¸°ì •ë–¡ í•„ë“œ í† ê¸€
      toggleGijeongddeokFields();
    }
  });

  // ê¸°ë³¸ê°’ ë¡œë“œ í•¨ìˆ˜
  function loadGijeongddeokDefaults() {
    // ì´ë¯¸ ë¡œë“œí–ˆê±°ë‚˜ ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ë¡œë“œí•˜ì§€ ì•ŠìŒ
    if (defaultsLoaded || <%= @production_log.persisted? ? 'true' : 'false' %>) {
      return;
    }

    <% @gijeongddeok_fields.each do |field| %>
      const <%= field.field_name %>_field = document.getElementById('production_log_<%= field.field_name %>');
      // dough_countëŠ” ìƒì‚°ê³„íšì—ì„œ ë¡œë“œë˜ë¯€ë¡œ ê¸°ë³¸ê°’ ì ìš© ì œì™¸
      if (<%= field.field_name %>_field && <%= field.field_name %>_field.value === '' && '<%= field.field_name %>' !== 'dough_count') {
        <%= field.field_name %>_field.value = gijeongddeokDefaults.<%= field.field_name %>;
      }
    <% end %>

    defaultsLoaded = true;
  }

  // ì™„ì œí’ˆ ì„ íƒ ì‹œ ê¸°ì •ë–¡ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ë° ê¸°ë³¸ê°’ ë¡œë“œ
  function toggleGijeongddeokFields() {
    const selectedOption = finishedProductSelect.options[finishedProductSelect.selectedIndex];
    const productName = selectedOption.text;

    if (productName.includes('ê¸°ì •ë–¡')) {
      gijeongddeokFields.style.display = 'block';
      // ê¸°ì •ë–¡ ì„ íƒ ì‹œ ê¸°ë³¸ê°’ ìë™ ë¡œë“œ
      setTimeout(loadGijeongddeokDefaults, 100);
    } else {
      gijeongddeokFields.style.display = 'none';
      defaultsLoaded = false; // ë‹¤ì‹œ ê¸°ì •ë–¡ì„ ì„ íƒí–ˆì„ ë•Œ ë¡œë“œí•  ìˆ˜ ìˆë„ë¡
    }
  }

  // ì´ˆê¸° ë¡œë“œ ì‹œ ì²´í¬
  if (finishedProductSelect.value) {
    toggleGijeongddeokFields();
  }

  // ì™„ì œí’ˆ ì„ íƒ ë³€ê²½ ì‹œ ì²´í¬
  finishedProductSelect.addEventListener('change', toggleGijeongddeokFields);
}

// DOMContentLoadedì™€ turbo:load ëª¨ë‘ì—ì„œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', initProductionLogForm);
document.addEventListener('turbo:load', initProductionLogForm);

// ë°˜ì£½ í†µìˆ˜ +/- ë²„íŠ¼ í•¸ë“¤ëŸ¬
function adjustValue(fieldId, delta) {
  const field = document.getElementById(fieldId);
  if (field) {
    const currentValue = parseFloat(field.value) || 0;
    const newValue = currentValue + delta;
    field.value = Math.max(0, newValue).toFixed(1);
  }
}
</script>
