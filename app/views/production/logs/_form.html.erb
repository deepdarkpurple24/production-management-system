<%
  form_url = @production_log.new_record? ? production_logs_path : production_log_path(@production_log)
  form_method = @production_log.new_record? ? :post : :patch
%>
<%= form_with(model: @production_log, url: form_url, method: form_method, local: true) do |form| %>
  <% if @production_log.errors.any? %>
    <div class="alert alert-danger mb-4" role="alert">
      <h5 class="alert-heading mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= pluralize(@production_log.errors.count, "error") %> prohibited this production log from being saved:
      </h5>
      <ul class="mb-0">
        <% @production_log.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- 생산 계획 선택 (Optional) -->
  <div class="mb-3">
    <%= form.label :production_plan_id, "생산 계획", class: "form-label", style: "font-weight: 500;" %>
    <%= form.select :production_plan_id,
                    options_from_collection_for_select(@production_plans, :id,
                      ->(plan) { "#{plan.finished_product.name} - #{plan.production_date} (#{plan.quantity}개)" },
                      @production_log.production_plan_id),
                    { prompt: "생산 계획 선택 (선택사항)" },
                    class: "form-select",
                    id: "production_plan_select" %>
    <small class="form-text text-muted">사전에 등록한 생산 계획을 선택하면 완제품과 날짜가 자동으로 채워집니다.</small>
  </div>

  <!-- 완제품 선택 -->
  <div class="mb-3">
    <%= form.label :finished_product_id, "완제품", class: "form-label", style: "font-weight: 500;" %>
    <span class="text-danger">*</span>
    <%= form.select :finished_product_id,
                    options_from_collection_for_select(@finished_products, :id, :name, @production_log.finished_product_id),
                    { prompt: "완제품을 선택하세요" },
                    class: "form-select",
                    required: true,
                    id: "finished_product_select" %>
    <small class="form-text text-muted">생산한 완제품을 선택하세요.</small>
  </div>

  <!-- 생산 일시 -->
  <div class="row mb-3">
    <div class="col-md-6">
      <%= form.label :production_date, "생산 일자", class: "form-label", style: "font-weight: 500;" %>
      <span class="text-danger">*</span>
      <%= form.date_field :production_date,
                          class: "form-control",
                          required: true %>
      <small class="form-text text-muted">실제 생산한 날짜를 입력하세요.</small>
    </div>

    <div class="col-md-6">
      <%= form.label :production_time, "생산 시간", class: "form-label", style: "font-weight: 500;" %>
      <%= form.time_field :production_time,
                          class: "form-control",
                          placeholder: "예: 09:00" %>
      <small class="form-text text-muted">생산 시작 시간을 입력하세요 (선택사항).</small>
    </div>
  </div>

  <!-- 기정떡 전용 필드 섹션 (온도 관리) -->
  <div id="gijeongddeok-fields" style="display: none;">
    <hr class="my-4">
    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
      <i class="bi bi-thermometer-half me-2"></i>온도 관리
    </h5>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <% @gijeongddeok_fields.each do |field| %>
            <div class="col-md-4">
              <%= form.label field.field_name, field.label, class: "form-label" %>
              <div class="input-group">
                <%= form.number_field field.field_name,
                                      step: 0.1,
                                      class: "form-control",
                                      id: "production_log_#{field.field_name}" %>
                <span class="input-group-text"><%= field.unit.presence || '°C' %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 기본 비고 -->
  <div class="mb-3">
    <%= form.label :notes, "비고", class: "form-label", style: "font-weight: 500;" %>
    <%= form.text_area :notes,
                       class: "form-control",
                       rows: 3,
                       placeholder: "생산 과정 중 특이사항이나 메모를 입력하세요 (선택사항)" %>
  </div>

  <%= form.hidden_field :view, value: params[:view] %>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <%= form.submit @production_log.new_record? ? "등록" : "수정",
                    class: "btn-modern btn-modern-primary" %>
    <%= link_to "취소", production_logs_path(view: params[:view] || 'monthly', date: @production_log.production_date || Date.today),
                class: "btn-modern btn-modern-outline" %>
  </div>
<% end %>

<script>
function initProductionLogForm() {
  const finishedProductSelect = document.getElementById('finished_product_select');
  const productionPlanSelect = document.getElementById('production_plan_select');
  const gijeongddeokFields = document.getElementById('gijeongddeok-fields');

  if (!finishedProductSelect || !productionPlanSelect || !gijeongddeokFields) {
    return;
  }

  // 생산 계획 데이터 (반죽통수 포함)
  const productionPlansData = {
    <% @production_plans.each do |plan| %>
      <%= plan.id %>: {
        finished_product_id: <%= plan.finished_product_id %>,
        production_date: '<%= plan.production_date %>',
        quantity: <%= plan.quantity || 0 %>
      },
    <% end %>
  };

  // 기정떡 기본값 데이터
  const gijeongddeokDefaults = {
    <% @gijeongddeok_fields.each do |field| %>
      <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
    <% end %>
  };

  // 기본값 로드 여부 플래그
  let defaultsLoaded = false;

  // 생산계획 선택 시 처리
  productionPlanSelect.addEventListener('change', function() {
    const selectedPlanId = this.value;

    if (selectedPlanId && productionPlansData[selectedPlanId]) {
      const plan = productionPlansData[selectedPlanId];

      // 완제품 자동 선택
      finishedProductSelect.value = plan.finished_product_id;

      // 생산 날짜 자동 입력
      const productionDateField = document.getElementById('production_log_production_date');
      if (productionDateField) {
        productionDateField.value = plan.production_date;
      }

      // 반죽통수 자동 입력 (dough_count 필드)
      const doughCountField = document.getElementById('production_log_dough_count');
      if (doughCountField && plan.quantity > 0) {
        doughCountField.value = plan.quantity;
      }

      // 완제품 변경에 따른 기정떡 필드 토글
      toggleGijeongddeokFields();
    }
  });

  // 기본값 로드 함수
  function loadGijeongddeokDefaults() {
    // 이미 로드했거나 수정 모드인 경우 로드하지 않음
    if (defaultsLoaded || <%= @production_log.persisted? ? 'true' : 'false' %>) {
      return;
    }

    <% @gijeongddeok_fields.each do |field| %>
      const <%= field.field_name %>_field = document.getElementById('production_log_<%= field.field_name %>');
      // dough_count는 생산계획에서 로드되므로 기본값 적용 제외
      if (<%= field.field_name %>_field && <%= field.field_name %>_field.value === '' && '<%= field.field_name %>' !== 'dough_count') {
        <%= field.field_name %>_field.value = gijeongddeokDefaults.<%= field.field_name %>;
      }
    <% end %>

    defaultsLoaded = true;
  }

  // 완제품 선택 시 기정떡 필드 표시/숨김 및 기본값 로드
  function toggleGijeongddeokFields() {
    const selectedOption = finishedProductSelect.options[finishedProductSelect.selectedIndex];
    const productName = selectedOption.text;

    if (productName.includes('기정떡')) {
      gijeongddeokFields.style.display = 'block';
      // 기정떡 선택 시 기본값 자동 로드
      setTimeout(loadGijeongddeokDefaults, 100);
    } else {
      gijeongddeokFields.style.display = 'none';
      defaultsLoaded = false; // 다시 기정떡을 선택했을 때 로드할 수 있도록
    }
  }

  // 초기 로드 시 체크
  if (finishedProductSelect.value) {
    toggleGijeongddeokFields();
  }

  // 완제품 선택 변경 시 체크
  finishedProductSelect.addEventListener('change', toggleGijeongddeokFields);
}

// DOMContentLoaded와 turbo:load 모두에서 실행
document.addEventListener('DOMContentLoaded', initProductionLogForm);
document.addEventListener('turbo:load', initProductionLogForm);

// 반죽 통수 +/- 버튼 핸들러
function adjustValue(fieldId, delta) {
  const field = document.getElementById(fieldId);
  if (field) {
    const currentValue = parseFloat(field.value) || 0;
    const newValue = currentValue + delta;
    field.value = Math.max(0, newValue).toFixed(1);
  }
}
</script>
