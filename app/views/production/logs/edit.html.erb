<div class="container-fluid px-4 py-4">
  <!-- Ìó§Îçî -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 style="font-weight: 600; color: #1d1d1f;">
      <i class="bi bi-pencil-square me-2"></i>Î∞òÏ£ΩÏùºÏßÄ ÏàòÏ†ï
    </h4>
    <span class="badge bg-secondary" style="font-size: 0.9rem;">
      <%= @production_log.production_date.strftime('%YÎÖÑ %mÏõî %dÏùº (%a)') %>
    </span>
  </div>

  <div class="card-modern">
    <div class="card-body p-4">
      <%
        form_url = production_log_path(@production_log)
        recipe = @production_log.recipe
        plan = @production_log.production_plan
      %>

      <%= form_with(model: @production_log, url: form_url, method: :patch, local: true) do |form| %>
        <% if @production_log.errors.any? %>
          <div class="alert alert-danger mb-4" role="alert">
            <h5 class="alert-heading mb-3">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <%= pluralize(@production_log.errors.count, "error") %> prohibited this production log from being saved:
            </h5>
            <ul class="mb-0">
              <% @production_log.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= form.hidden_field :production_plan_id %>
        <%= form.hidden_field :finished_product_id %>
        <%= form.hidden_field :recipe_id %>

        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌëúÏãú -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label" style="font-weight: 500;">ÏôÑÏ†úÌíà</label>
            <div class="form-control-plaintext" style="font-weight: 600; color: #0071e3;">
              <%= @production_log.finished_product&.name || '-' %>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label" style="font-weight: 500;">Î†àÏãúÌîº</label>
            <div class="form-control-plaintext" style="font-weight: 600;">
              <%= @production_log.recipe&.name || '-' %>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label" style="font-weight: 500;">ÏÉùÏÇ∞ Í≥ÑÌöç</label>
            <div class="form-control-plaintext">
              <% if plan %>
                <%= number_with_delimiter(plan.quantity) %>Í∞ú
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </div>
          </div>
        </div>

        <!-- ÏÉùÏÇ∞ ÏùºÏãú -->
        <div class="row mb-3">
          <div class="col-md-6">
            <%= form.label :production_date, "ÏÉùÏÇ∞ ÎÇ†Ïßú", class: "form-label", style: "font-weight: 500;" %>
            <span class="text-danger">*</span>
            <%= form.date_field :production_date, class: "form-control", required: true %>
          </div>
          <div class="col-md-6">
            <%= form.label :production_time, "ÏÉùÏÇ∞ ÏãúÍ∞Ñ", class: "form-label", style: "font-weight: 500;" %>
            <%= form.time_field :production_time, class: "form-control" %>
          </div>
        </div>

        <% if recipe.present? && plan.present? %>
          <%
            # Î†àÏãúÌîº Î∞∞Ïú® Í≥ÑÏÇ∞
            fpr = @production_log.finished_product.finished_product_recipes.find_by(recipe_id: recipe.id)
            weight_per_unit = fpr&.quantity || 0
            is_gijeongddeok = @production_log.finished_product.name.include?('Í∏∞Ï†ïÎñ°')
            show_recipe_ingredients = weight_per_unit > 0 && !is_gijeongddeok
          %>
          <% if show_recipe_ingredients %>
            <%
              recipe_total = recipe.recipe_ingredients.where(row_type: ['ingredient', nil]).sum(:weight)
              recipe_total = recipe_total.zero? ? 1 : recipe_total
              multiplier = (plan.quantity.to_f * weight_per_unit) / recipe_total
              total_scaled = recipe_total * multiplier

              # Ïû•ÎπÑ ÏµúÎåÄ ÏûëÏóÖ Ï§ëÎüâ ÌôïÏù∏
              max_work_capacity = recipe.recipe_equipments.where.not(work_capacity: [nil, 0]).maximum(:work_capacity)
              max_work_capacity_g = max_work_capacity ? max_work_capacity * 1000 : nil

              if max_work_capacity_g && max_work_capacity_g > 0 && total_scaled > max_work_capacity_g
                batch_count = (total_scaled / max_work_capacity_g).ceil
              else
                batch_count = 1
              end
            %>

            <!-- Î†àÏãúÌîº Ïû¨Î£å ÌÖåÏù¥Î∏î -->
            <div class="d-flex gap-3 mb-3 flex-wrap">
            <% batch_count.times do |batch_index| %>
              <div class="card recipe-ingredients-card" style="flex: 1; min-width: 250px;">
                <div class="card-body p-0">
                  <table class="table table-sm mb-0" style="font-size: 0.9rem;">
                    <thead>
                      <tr>
                        <th style="padding: 0.6rem 1rem; font-weight: 600; color: #1d1d1f; background-color: #d6d8db;">
                          <%= recipe.name %>
                          <% if batch_count > 1 %>
                            <span class="badge bg-secondary ms-2" style="font-size: 0.75rem;">
                              <%= batch_index + 1 %>/<%= batch_count %>
                            </span>
                          <% end %>
                        </th>
                        <th class="text-end" style="padding: 0.6rem 1rem; font-weight: 500; color: #6e6e73; background-color: #d6d8db;">
                          <%= @production_log.production_date.strftime('%m-%d') %> <%= @production_log.production_time&.strftime('%H:%M') || '' %>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <% running_subtotal = 0.0 %>
                      <% recipe.recipe_ingredients.order(:position).each do |ri| %>
                        <% if ri.row_type == 'subtotal' %>
                          <% scaled_subtotal = (running_subtotal * multiplier) / batch_count %>
                          <tr>
                            <td style="padding: 0.5rem 1rem; font-weight: 600; color: #1d1d1f; background-color: #d6d8db;">ÏÜåÍ≥Ñ</td>
                            <td class="text-end" style="padding: 0.5rem 1rem; font-weight: 600; color: #0071e3; background-color: #d6d8db;">
                              <%= number_with_delimiter(scaled_subtotal.round(0)) %>
                            </td>
                          </tr>
                          <% running_subtotal = 0.0 %>
                        <% else %>
                          <% running_subtotal += ri.weight.to_f %>
                          <%
                            scaled_weight = (ri.weight.to_f * multiplier) / batch_count
                            field_key = "batch_#{batch_index}_ri_#{ri.id}"
                            saved_weights = @production_log.ingredient_weights || {}
                            display_weight = saved_weights[field_key].present? ? saved_weights[field_key].to_i : scaled_weight.round(0)
                          %>
                          <tr class="ingredient-row" style="cursor: pointer; user-select: none;">
                            <td style="padding: 0.5rem 1rem; color: #1d1d1f;"><%= ri.display_name %></td>
                            <td class="text-end" style="padding: 0.5rem 1rem; color: #1d1d1f; font-weight: 500;">
                              <input type="number" name="production_log[ingredient_weights][<%= field_key %>]"
                                     class="ingredient-weight-input"
                                     value="<%= display_weight %>"
                                     style="width: 80px; text-align: right; border: none; background: transparent; font-weight: 500; color: #1d1d1f; user-select: text;">
                            </td>
                          </tr>
                        <% end %>
                      <% end %>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td style="padding: 0.6rem 1rem; font-weight: 700; color: #1d1d1f; background-color: #d6d8db; border-top: 1px solid #ced4da;">
                          <%= recipe.name %>Î¨¥Í≤å
                        </td>
                        <td class="text-end" style="padding: 0.6rem 1rem; color: #0071e3; font-weight: 700; font-size: 1rem; background-color: #d6d8db; border-top: 1px solid #ced4da;">
                          <%= number_with_delimiter((total_scaled / batch_count).round(0)) %>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            <% end %>
            </div>
          <% end %>
        <% end %>

        <!-- Í∏∞Ï†ïÎñ° Ï†ÑÏö© ÌïÑÎìú ÏÑπÏÖò -->
        <% if @production_log.finished_product&.name&.include?('Í∏∞Ï†ïÎñ°') %>
          <hr class="my-4">
          <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
            <i class="bi bi-clipboard-data me-2"></i>Í∏∞Ï†ïÎñ° ÏÉùÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
          </h5>

          <div class="card mb-3">
            <div class="card-header" style="background-color: #f5f5f7;">
              <h6 class="mb-0" style="font-weight: 500;">üìù ÏÉùÏÇ∞ Ï†ïÎ≥¥</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <% @gijeongddeok_fields.each do |field| %>
                  <% next if field.field_name == 'makgeolli_consumption' %>
                  <div class="col-md-4">
                    <%= form.label field.field_name, field.label, class: "form-label" %>
                    <div class="input-group">
                      <% if field.field_name == 'dough_count' %>
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= field.field_name %>', -0.5)">
                          <i class="bi bi-dash"></i>
                        </button>
                      <% end %>
                      <%= form.number_field field.field_name,
                                            step: field.field_name == 'dough_count' ? 0.5 : 0.1,
                                            class: "form-control",
                                            id: "production_log_#{field.field_name}" %>
                      <% if field.field_name == 'dough_count' %>
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= field.field_name %>', 0.5)">
                          <i class="bi bi-plus"></i>
                        </button>
                        <span class="input-group-text">ÌÜµ</span>
                      <% else %>
                        <span class="input-group-text">
                          <%= case field.field_name
                              when /temp$/
                                '¬∞C'
                              when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                                'g'
                              when 'water_amount'
                                'L'
                              else
                                ''
                              end %>
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨ -->
          <div class="card mb-3">
            <div class="card-header" style="background-color: #f5f5f7;">
              <h6 class="mb-0" style="font-weight: 500;">üç∂ ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <%= form.label :makgeolli_consumption, "ÎßâÍ±∏Î¶¨ ÏÜåÎπÑÎüâ", class: "form-label" %>
                  <div class="input-group">
                    <%= form.number_field :makgeolli_consumption, step: 0.1, class: "form-control" %>
                    <span class="input-group-text">mL</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <%= form.label :makgeolli_expiry_date, "ÎßâÍ±∏Î¶¨ Ïú†Ìö®Í∏∞Í∞Ñ", class: "form-label" %>
                  <%= form.date_field :makgeolli_expiry_date, class: "form-control" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- ÎπÑÍ≥† -->
        <div class="mb-3">
          <%= form.label :notes, "ÎπÑÍ≥†", class: "form-label", style: "font-weight: 500;" %>
          <%= form.text_area :notes, class: "form-control", rows: 3,
                             placeholder: "ÏÉùÏÇ∞ Í≥ºÏ†ï Ï§ë ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)" %>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <%= form.submit "ÏàòÏ†ï", class: "btn-modern btn-modern-primary" %>
          <%= link_to "Ï∑®ÏÜå", production_logs_path, class: "btn-modern btn-modern-outline" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Î∞òÏ£Ω ÌÜµÏàò +/- Î≤ÑÌäº Ìï∏Îì§Îü¨
  function adjustValue(fieldId, delta) {
    const field = document.getElementById(fieldId);
    if (field) {
      const currentValue = parseFloat(field.value) || 0;
      const newValue = currentValue + delta;
      field.value = Math.max(0, newValue).toFixed(1);
    }
  }

  // Ïû¨Î£å Ìñâ ÎçîÎ∏îÌÅ¥Î¶≠/ÎçîÎ∏îÌÉ≠ - Ïû¨Î£å Ìà¨ÏûÖ ÏôÑÎ£å ÌëúÏãú (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ ÏÇ¨Ïö©)
  (function() {
    const CHECKED_COLOR = '#c8e6c9';
    let lastTapTime = 0;
    let lastTapTarget = null;

    function toggleRowColor(row) {
      const cells = row.querySelectorAll('td');
      const isChecked = row.dataset.checked === 'true';

      if (isChecked) {
        cells.forEach(cell => {
          cell.style.backgroundColor = '';
        });
        row.dataset.checked = 'false';
      } else {
        cells.forEach(cell => {
          cell.style.backgroundColor = CHECKED_COLOR;
        });
        row.dataset.checked = 'true';
      }
    }

    document.addEventListener('dblclick', function(e) {
      if (e.target.tagName === 'INPUT') return;
      const row = e.target.closest('.ingredient-row');
      if (row) {
        e.preventDefault();
        toggleRowColor(row);
      }
    });

    document.addEventListener('touchend', function(e) {
      if (e.target.tagName === 'INPUT') return;
      const row = e.target.closest('.ingredient-row');
      if (!row) return;

      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTapTime;

      if (tapLength < 300 && tapLength > 0 && lastTapTarget === row) {
        e.preventDefault();
        toggleRowColor(row);
      }

      lastTapTime = currentTime;
      lastTapTarget = row;
    });
  })();
</script>
