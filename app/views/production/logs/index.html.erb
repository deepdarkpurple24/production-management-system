<%= render 'production/shared/sub_navigation' %>

<div class="container-fluid px-4 py-4">
  <!-- í—¤ë” ì„¹ì…˜ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1" style="font-weight: 600; letter-spacing: -0.02em;">ìƒì‚° ì¼ì§€</h2>
      <p class="text-muted small mb-0">Production Logs</p>
    </div>
  </div>

  <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="card-apple mb-3">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to production_logs_path(date: @date - 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>

        <div class="text-center">
          <h4 class="mb-0" style="font-weight: 600;">
            <%= @date.strftime('%Yë…„ %mì›” %dì¼ (%a)') %>
          </h4>
          <%= link_to "ì˜¤ëŠ˜", production_logs_path(date: Date.today),
                      class: "btn btn-sm btn-link text-muted" %>
        </div>

        <%= link_to production_logs_path(date: @date + 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <% if @today_plans.any? %>
    <!-- ìƒì‚° ê³„íš íƒ­ -->
    <div class="card-apple">
      <div class="card-body p-0">
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs border-bottom-0" id="productionTabs" role="tablist" style="padding: 1rem 1rem 0 1rem;">
          <% @today_plans.each_with_index do |plan, index| %>
            <li class="nav-item" role="presentation">
              <button class="nav-tab-apple <%= 'active' if index == 0 %>"
                      id="plan-<%= plan.id %>-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#plan-<%= plan.id %>"
                      type="button"
                      role="tab">
                <div class="d-flex align-items-center gap-2">
                  <strong><%= plan.finished_product.name %></strong>
                  <span class="badge bg-secondary" style="font-size: 0.7rem;"><%= plan.quantity %>ê°œ</span>
                  <% if plan.production_logs.any? %>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 0.9rem;"></i>
                  <% end %>
                </div>
              </button>
            </li>
          <% end %>
        </ul>

        <!-- íƒ­ ë‚´ìš© -->
        <div class="tab-content" id="productionTabsContent">
          <% @today_plans.each_with_index do |plan, index| %>
            <div class="tab-pane fade <%= 'show active' if index == 0 %>"
                 id="plan-<%= plan.id %>"
                 role="tabpanel">
              <div class="p-4">
                <%
                  # ì´ë¯¸ ë“±ë¡ëœ ì¼ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                  existing_log = plan.production_logs.first
                  log = existing_log || ProductionLog.new(
                    production_plan: plan,
                    finished_product: plan.finished_product,
                    production_date: plan.production_date
                  )
                  form_url = existing_log ? production_log_path(existing_log) : production_logs_path
                  form_method = existing_log ? :patch : :post
                %>

                <!-- ìƒì‚° ê³„íš ì •ë³´ -->
                <div class="alert alert-info mb-4" style="background-color: #e3f2fd; border: none;">
                  <div class="row">
                    <div class="col-md-4">
                      <small class="text-muted d-block">ìƒì‚°ì¼</small>
                      <strong><%= plan.production_date.strftime('%Y-%m-%d') %></strong>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">ì™„ì œí’ˆ</small>
                      <strong><%= plan.finished_product.name %></strong>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">ë°˜ì£½ í†µìˆ˜</small>
                      <strong><%= plan.quantity %>í†µ</strong>
                    </div>
                  </div>
                  <% if plan.notes.present? %>
                    <hr class="my-2">
                    <small class="text-muted d-block mb-1">ê³„íš ë¹„ê³ </small>
                    <div><%= plan.notes %></div>
                  <% end %>
                </div>

                <!-- ìƒì‚° ì¼ì§€ í¼ -->
                <%= form_with(model: log, url: form_url, method: form_method, local: true) do |form| %>
                  <%= form.hidden_field :production_plan_id, value: plan.id %>
                  <%= form.hidden_field :finished_product_id, value: plan.finished_product_id %>
                  <%= form.hidden_field :production_date, value: plan.production_date %>

                  <% if log.errors.any? %>
                    <div class="alert alert-danger mb-4" role="alert">
                      <h5 class="alert-heading mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= pluralize(log.errors.count, "error") %> prohibited this production log from being saved:
                      </h5>
                      <ul class="mb-0">
                        <% log.errors.each do |error| %>
                          <li><%= error.full_message %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <!-- ìƒì‚° ì‹œê°„ -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <%= form.label :production_time, "ìƒì‚° ì‹œê°„", class: "form-label", style: "font-weight: 500;" %>
                      <%= form.time_field :production_time,
                                          value: log.production_time || Time.current.strftime('%H:%M'),
                                          class: "form-control",
                                          placeholder: "ì˜ˆ: 09:00" %>
                      <small class="form-text text-muted">ìƒì‚° ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.</small>
                    </div>
                  </div>

                  <!-- ê¸°ì •ë–¡ ì „ìš© í•„ë“œ ì„¹ì…˜ -->
                  <div id="gijeongddeok-fields-<%= plan.id %>" style="<%= plan.finished_product.name.include?('ê¸°ì •ë–¡') ? '' : 'display: none;' %>">
                    <hr class="my-4">
                    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
                      <i class="bi bi-clipboard-data me-2"></i>ê¸°ì •ë–¡ ìƒì‚° ìƒì„¸ ì •ë³´
                    </h5>

                    <!-- ì„¤ì •ëœ ìˆœì„œëŒ€ë¡œ í•„ë“œ ë Œë”ë§ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">ğŸ“ ìƒì‚° ì •ë³´</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <% @gijeongddeok_fields.each do |field| %>
                            <% next if field.field_name == 'makgeolli_consumption' %>
                            <div class="col-md-4">
                              <%= form.label field.field_name, field.label, class: "form-label" %>
                              <div class="input-group">
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= plan.id %>_<%= field.field_name %>', -0.5)">
                                    <i class="bi bi-dash"></i>
                                  </button>
                                <% end %>
                                <%= form.number_field field.field_name,
                                                      step: field.field_name == 'dough_count' ? 0.5 : ((field.field_name.ends_with?('_temp') || field.field_name.ends_with?('_amount') && field.field_name != 'yeast_amount' && field.field_name != 'salt_amount' && field.field_name != 'sugar_amount') ? 0.1 : nil),
                                                      class: "form-control",
                                                      id: "production_log_#{plan.id}_#{field.field_name}",
                                                      placeholder: field.category == 'temperature' ? "ì˜ˆ: 25.0" : (field.field_name == 'water_amount' ? "ì˜ˆ: 1.5" : "ì˜ˆ: 100") %>
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= plan.id %>_<%= field.field_name %>', 0.5)">
                                    <i class="bi bi-plus"></i>
                                  </button>
                                  <span class="input-group-text">í†µ</span>
                                <% else %>
                                  <span class="input-group-text">
                                    <%= case field.field_name
                                        when /temp$/
                                          'Â°C'
                                        when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                                          'g'
                                        when 'water_amount'
                                          'L'
                                        else
                                          ''
                                        end %>
                                  </span>
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- ë§‰ê±¸ë¦¬ ê´€ë¦¬ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">ğŸ¶ ë§‰ê±¸ë¦¬ ê´€ë¦¬</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <%= form.label :makgeolli_consumption, "ë§‰ê±¸ë¦¬ ì†Œë¹„ëŸ‰", class: "form-label" %>
                            <div class="input-group">
                              <%= form.number_field :makgeolli_consumption,
                                                    step: 0.1,
                                                    class: "form-control",
                                                    id: "production_log_#{plan.id}_makgeolli_consumption",
                                                    placeholder: "ì˜ˆ: 2500" %>
                              <span class="input-group-text">mL</span>
                            </div>
                            <small class="form-text text-muted">ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì¬ê³  ì¶œê³  ì²˜ë¦¬ë©ë‹ˆë‹¤.</small>
                          </div>

                          <div class="col-md-6">
                            <%= form.label :makgeolli_expiry_date, "ë§‰ê±¸ë¦¬ ìœ íš¨ê¸°ê°„", class: "form-label" %>
                            <%= form.date_field :makgeolli_expiry_date,
                                                class: "form-control" %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ê¸°ë³¸ ë¹„ê³  -->
                  <div class="mb-4">
                    <%= form.label :notes, "ë¹„ê³ ", class: "form-label", style: "font-weight: 500;" %>
                    <%= form.text_area :notes,
                                       class: "form-control",
                                       rows: 3,
                                       placeholder: "ìƒì‚° ê³¼ì • ì¤‘ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" %>
                  </div>

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <% if existing_log %>
                      <%= button_to production_log_path(existing_log),
                                    method: :delete,
                                    data: { confirm: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' },
                                    class: "btn btn-outline-danger" do %>
                        <i class="bi bi-trash me-2"></i>ì‚­ì œ
                      <% end %>
                    <% end %>
                    <%= form.submit existing_log ? "ìˆ˜ì •" : "ë“±ë¡",
                                    class: "btn-apple btn-apple-primary" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- ìƒì‚° ê³„íš ì—†ìŒ -->
    <div class="card-apple">
      <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #d2d2d7;"></i>
        <p class="text-muted mt-3 mb-0"><%= @date.strftime('%Yë…„ %mì›” %dì¼') %>ì— ë“±ë¡ëœ ìƒì‚° ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <%= link_to production_plans_path(date: @date),
                    class: "btn-apple btn-apple-primary mt-3" do %>
          <i class="bi bi-calendar-plus me-2"></i>ìƒì‚° ê³„íš ë“±ë¡í•˜ê¸°
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // ê¸°ë³¸ê°’ ë¡œë“œ í•¨ìˆ˜
  function loadGijeongddeokDefaults() {
    // ê¸°ì •ë–¡ ê¸°ë³¸ê°’ ë°ì´í„°
    const defaults = {
      <% @gijeongddeok_fields.each do |field| %>
        <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
      <% end %>
    };

    // ê° íƒ­ì˜ í¼ì„ í™•ì¸í•˜ê³  ê¸°ë³¸ê°’ ì ìš©
    <% @today_plans.each do |plan| %>
      <% if plan.finished_product.name.include?('ê¸°ì •ë–¡') %>
        <% log = plan.production_logs.first || ProductionLog.new %>
        <% if log.new_record? %>
          // ìƒˆ ë ˆì½”ë“œì¸ ê²½ìš°ì—ë§Œ ê¸°ë³¸ê°’ ì ìš©
          <% @gijeongddeok_fields.each do |field| %>
            const field_<%= plan.id %>_<%= field.field_name %> = document.querySelector(`#production_log_<%= plan.id %>_<%= field.field_name %>`);
            if (field_<%= plan.id %>_<%= field.field_name %> && field_<%= plan.id %>_<%= field.field_name %>.value === '') {
              field_<%= plan.id %>_<%= field.field_name %>.value = defaults.<%= field.field_name %> || '';
            }
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  }

  // DOMContentLoadedì™€ turbo:load ëª¨ë‘ì—ì„œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', loadGijeongddeokDefaults);
  document.addEventListener('turbo:load', loadGijeongddeokDefaults);

  // ë°˜ì£½ í†µìˆ˜ +/- ë²„íŠ¼ í•¸ë“¤ëŸ¬
  function adjustValue(fieldId, delta) {
    const field = document.getElementById(fieldId);
    if (field) {
      const currentValue = parseFloat(field.value) || 0;
      const newValue = currentValue + delta;
      field.value = Math.max(0, newValue).toFixed(1);
    }
  }
</script>

<style>
  .nav-tab-apple {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #1d1d1f;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .nav-tab-apple:hover:not(.active) {
    color: #0071e3;
    border-bottom-color: #d2d2d7;
  }

  .nav-tab-apple.active {
    color: #0071e3;
    border-bottom-color: #0071e3;
  }

  .tab-content > .tab-pane {
    background-color: white;
  }
</style>
