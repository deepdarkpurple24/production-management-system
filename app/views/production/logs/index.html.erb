<%= render 'production/shared/sub_navigation' %>

<div class="container-fluid px-4 py-4">
  <!-- 날짜 선택 네비게이션 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <%= link_to production_logs_path(status: @status, date: @selected_date - 1.day),
                  class: "btn btn-outline-secondary btn-sm" do %>
        <i class="bi bi-chevron-left"></i>
      <% end %>

      <input type="date"
             id="date-picker"
             class="form-control form-control-sm"
             value="<%= @selected_date.strftime('%Y-%m-%d') %>"
             style="width: 160px;"
             onchange="window.location.href = '/production/logs?status=<%= @status %>&date=' + this.value">

      <%= link_to production_logs_path(status: @status, date: @selected_date + 1.day),
                  class: "btn btn-outline-secondary btn-sm" do %>
        <i class="bi bi-chevron-right"></i>
      <% end %>

      <% unless @selected_date == Date.today %>
        <%= link_to production_logs_path(status: @status, date: Date.today),
                    class: "btn btn-primary btn-sm ms-2" do %>
          <i class="bi bi-calendar-today me-1"></i>오늘
        <% end %>
      <% end %>
    </div>

    <h5 class="mb-0" style="font-weight: 600; color: #1d1d1f;">
      <%= @selected_date.strftime('%Y년 %m월 %d일 (%a)') %>
    </h5>
  </div>

  <!-- 작업 단계 네비게이션 -->
  <div class="mb-4">
    <ul class="nav nav-pills" style="background-color: #f5f5f7; border-radius: 12px; padding: 0.5rem;">
      <li class="nav-item">
        <%= link_to production_logs_path(status: 'pending', date: @selected_date),
                    class: "nav-link #{'active' if @status == 'pending'}",
                    style: "border-radius: 8px; font-weight: 500; transition: all 0.2s;" do %>
          <i class="bi bi-clock-history me-2"></i>작업 전
          <% if @pending_count > 0 %>
            <span class="badge bg-secondary ms-2"><%= @pending_count %></span>
          <% end %>
        <% end %>
      </li>
      <li class="nav-item">
        <%= link_to production_logs_path(status: 'in_progress', date: @selected_date),
                    class: "nav-link #{'active' if @status == 'in_progress'}",
                    style: "border-radius: 8px; font-weight: 500; transition: all 0.2s;" do %>
          <i class="bi bi-hourglass-split me-2"></i>작업중
          <% if @in_progress_count > 0 %>
            <span class="badge bg-secondary ms-2"><%= @in_progress_count %></span>
          <% end %>
        <% end %>
      </li>
      <li class="nav-item">
        <%= link_to production_logs_path(status: 'completed', date: @selected_date),
                    class: "nav-link #{'active' if @status == 'completed'}",
                    style: "border-radius: 8px; font-weight: 500; transition: all 0.2s;" do %>
          <i class="bi bi-check-circle me-2"></i>작업완료
          <% if @completed_count > 0 %>
            <span class="badge bg-secondary ms-2"><%= @completed_count %></span>
          <% end %>
        <% end %>
      </li>
    </ul>
  </div>

  <!-- 작업 전: 생산계획 목록 -->
  <% if @status == 'pending' %>
    <%= render 'pending_plans' %>

  <!-- 작업중 / 작업완료: 반죽일지 목록 -->
  <% else %>
    <div class="d-flex justify-content-end mb-3">
      <%= link_to new_production_log_path(date: @selected_date),
                  class: "btn-modern btn-modern-primary" do %>
        <i class="bi bi-plus-lg me-2"></i>반죽일지 추가
      <% end %>
    </div>

    <% if (@dough_logs.present? && @dough_logs.any?) || (@production_logs.present? && @production_logs.any?) %>
      <!-- 1차 반죽 섹션 (반죽일이 오늘인 항목) -->
      <% if @dough_logs.present? && @dough_logs.any? %>
        <div class="mb-4">
          <div class="d-flex align-items-center mb-2">
            <span class="badge me-2" style="background-color: #5b9bd5; font-size: 0.9rem; padding: 0.5rem 0.75rem;">
              <i class="bi bi-1-circle me-1"></i>1차 반죽
            </span>
            <small class="text-muted">오늘 반죽 시작 → 내일 생산</small>
          </div>
          <div class="card-modern">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead style="background-color: #e3f2fd; border-bottom: 1px solid #90caf9;">
                    <tr>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 15%;">날짜</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 10%; white-space: nowrap;">반죽시간</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 18%;">레시피</th>
                      <th class="py-3 px-4 text-center" style="font-weight: 500; font-size: 0.875rem; width: 10%;">수량</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 37%;">비고</th>
                      <th class="py-3 px-4 text-center" style="font-weight: 500; font-size: 0.875rem; width: 10%;">관리</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @dough_logs.each do |log| %>
                      <tr style="border-bottom: 1px solid #e8e8ed;">
                        <td class="py-3 px-4">
                          <div><small class="text-primary">반죽: <%= log.dough_date&.strftime('%m/%d') %></small></div>
                          <div><small class="text-muted">생산: <%= log.production_date&.strftime('%m/%d') %></small></div>
                        </td>
                        <td class="py-3 px-4" style="white-space: nowrap;">
                          <% if log.batch_completion_times.present? && log.batch_completion_times.any? %>
                            <% log.batch_completion_times.to_a.sort_by { |k, _| k.to_i }.each do |(batch_idx, time_str)| %>
                              <% time = Time.parse(time_str) rescue nil %>
                              <% if time %>
                                <span class="badge bg-secondary"><%= time.strftime('%H:%M') %></span>
                              <% end %>
                            <% end %>
                          <% elsif log.production_time.present? %>
                            <%= log.production_time.strftime('%H:%M') %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4">
                          <% if log.recipe.present? %>
                            <span style="font-weight: 500;"><%= log.recipe.name %></span>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4 text-center">
                          <% if log.dough_count.present? %>
                            <span class="badge bg-primary"><%= number_with_delimiter(log.dough_count) %>통</span>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4">
                          <% if log.notes.present? %>
                            <%= truncate(log.notes, length: 80) %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4 text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <%= link_to edit_production_log_path(log, from_status: @status), class: "btn btn-sm btn-outline-primary", title: "수정" do %>
                              <i class="bi bi-pencil"></i>
                            <% end %>
                            <%= button_to production_log_path(log, from_status: @status), method: :delete, class: "btn btn-sm btn-outline-danger", title: "삭제", data: { turbo_confirm: "정말 삭제하시겠습니까?" } do %>
                              <i class="bi bi-trash"></i>
                            <% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- 2차 반죽 섹션 (생산일이 오늘인 항목) -->
      <% if @production_logs.present? && @production_logs.any? %>
        <div class="mb-4">
          <div class="d-flex align-items-center mb-2">
            <span class="badge me-2" style="background-color: #ed7d31; font-size: 0.9rem; padding: 0.5rem 0.75rem;">
              <i class="bi bi-2-circle me-1"></i>2차 반죽
            </span>
            <small class="text-muted">어제 반죽 → 오늘 생산</small>
          </div>
          <div class="card-modern">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead style="background-color: #fff3e0; border-bottom: 1px solid #ffcc80;">
                    <tr>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 15%;">날짜</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 10%; white-space: nowrap;">반죽시간</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 18%;">레시피</th>
                      <th class="py-3 px-4 text-center" style="font-weight: 500; font-size: 0.875rem; width: 10%;">수량</th>
                      <th class="py-3 px-4" style="font-weight: 500; font-size: 0.875rem; width: 37%;">비고</th>
                      <th class="py-3 px-4 text-center" style="font-weight: 500; font-size: 0.875rem; width: 10%;">관리</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @production_logs.each do |log| %>
                      <tr style="border-bottom: 1px solid #e8e8ed;">
                        <td class="py-3 px-4">
                          <div><small class="text-muted">반죽: <%= log.dough_date&.strftime('%m/%d') %></small></div>
                          <div><small class="text-warning-emphasis">생산: <%= log.production_date&.strftime('%m/%d') %></small></div>
                        </td>
                        <td class="py-3 px-4" style="white-space: nowrap;">
                          <% if log.batch_completion_times.present? && log.batch_completion_times.any? %>
                            <% log.batch_completion_times.to_a.sort_by { |k, _| k.to_i }.each do |(batch_idx, time_str)| %>
                              <% time = Time.parse(time_str) rescue nil %>
                              <% if time %>
                                <span class="badge bg-secondary"><%= time.strftime('%H:%M') %></span>
                              <% end %>
                            <% end %>
                          <% elsif log.production_time.present? %>
                            <%= log.production_time.strftime('%H:%M') %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4">
                          <% if log.recipe.present? %>
                            <span style="font-weight: 500;"><%= log.recipe.name %></span>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4 text-center">
                          <% if log.dough_count.present? %>
                            <span class="badge bg-primary"><%= number_with_delimiter(log.dough_count) %>통</span>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4">
                          <% if log.notes.present? %>
                            <%= truncate(log.notes, length: 80) %>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                        <td class="py-3 px-4 text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <%= link_to edit_production_log_path(log, from_status: @status), class: "btn btn-sm btn-outline-primary", title: "수정" do %>
                              <i class="bi bi-pencil"></i>
                            <% end %>
                            <%= button_to production_log_path(log, from_status: @status), method: :delete, class: "btn btn-sm btn-outline-danger", title: "삭제", data: { turbo_confirm: "정말 삭제하시겠습니까?" } do %>
                              <i class="bi bi-trash"></i>
                            <% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="card-modern">
        <div class="card-body p-0">
          <div class="text-center py-5">
            <i class="bi bi-journal-x" style="font-size: 4rem; color: #d2d2d7;"></i>
            <h5 class="mt-4 mb-2" style="font-weight: 600; color: #86868b;">
              <%= @status == 'in_progress' ? '작업중인 반죽일지가 없습니다' : '완료된 반죽일지가 없습니다' %>
            </h5>
            <p class="text-muted small">상단의 "반죽일지 추가" 버튼을 클릭하여 반죽일지를 추가하세요.</p>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<style>
  .nav-pills .nav-link {
    color: #1d1d1f;
  }

  .nav-pills .nav-link.active {
    background-color: #007aff !important;
    color: white !important;
  }

  .nav-pills .nav-link:hover:not(.active) {
    background-color: #e8e8ed;
  }
</style>
