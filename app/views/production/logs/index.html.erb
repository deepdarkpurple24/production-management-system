<%= render 'production/shared/sub_navigation' %>

<div class="container-fluid px-4 py-4">
  <!-- Ìó§Îçî ÏÑπÏÖò -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1" style="font-weight: 600; letter-spacing: -0.02em;">ÏÉùÏÇ∞ ÏùºÏßÄ</h2>
      <p class="text-muted small mb-0">Production Logs</p>
    </div>
  </div>

  <!-- ÎÇ†Ïßú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
  <div class="card-apple mb-3">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to production_logs_path(date: @date - 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>

        <div class="text-center">
          <h4 class="mb-0" style="font-weight: 600;">
            <%= @date.strftime('%YÎÖÑ %mÏõî %dÏùº (%a)') %>
          </h4>
          <%= link_to "Ïò§Îäò", production_logs_path(date: Date.today),
                      class: "btn btn-sm btn-link text-muted" %>
        </div>

        <%= link_to production_logs_path(date: @date + 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <% if @today_plans.any? %>
    <!-- ÏÉùÏÇ∞ Í≥ÑÌöç ÌÉ≠ -->
    <div class="card-apple">
      <div class="card-body p-0">
        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <ul class="nav nav-tabs border-bottom-0" id="productionTabs" role="tablist" style="padding: 1rem 1rem 0 1rem;">
          <% @today_plans.each_with_index do |plan, index| %>
            <li class="nav-item" role="presentation">
              <button class="nav-tab-apple <%= 'active' if index == 0 %>"
                      id="plan-<%= plan.id %>-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#plan-<%= plan.id %>"
                      type="button"
                      role="tab">
                <div class="d-flex align-items-center gap-2">
                  <strong><%= plan.finished_product.name %></strong>
                  <span class="badge bg-secondary" style="font-size: 0.7rem;"><%= plan.quantity %>Í∞ú</span>
                  <% if plan.production_logs.any? %>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 0.9rem;"></i>
                  <% end %>
                </div>
              </button>
            </li>
          <% end %>
        </ul>

        <!-- ÌÉ≠ ÎÇ¥Ïö© -->
        <div class="tab-content" id="productionTabsContent">
          <% @today_plans.each_with_index do |plan, index| %>
            <div class="tab-pane fade <%= 'show active' if index == 0 %>"
                 id="plan-<%= plan.id %>"
                 role="tabpanel">
              <div class="p-4">
                <%
                  # Ïù¥ÎØ∏ Îì±Î°ùÎêú ÏùºÏßÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                  existing_log = plan.production_logs.first
                  log = existing_log || ProductionLog.new(
                    production_plan: plan,
                    finished_product: plan.finished_product,
                    production_date: plan.production_date
                  )
                  form_url = existing_log ? production_log_path(existing_log) : production_logs_path
                  form_method = existing_log ? :patch : :post
                %>

                <!-- ÏÉùÏÇ∞ Í≥ÑÌöç Ï†ïÎ≥¥ -->
                <div class="alert alert-info mb-4" style="background-color: #e3f2fd; border: none;">
                  <div class="row">
                    <div class="col-md-4">
                      <small class="text-muted d-block">ÏÉùÏÇ∞Ïùº</small>
                      <strong><%= plan.production_date.strftime('%Y-%m-%d') %></strong>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">ÏôÑÏ†úÌíà</small>
                      <strong><%= plan.finished_product.name %></strong>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">Í≥ÑÌöç ÏàòÎüâ</small>
                      <strong><%= plan.quantity %>Í∞ú</strong>
                    </div>
                  </div>
                  <% if plan.notes.present? %>
                    <hr class="my-2">
                    <small class="text-muted d-block mb-1">Í≥ÑÌöç ÎπÑÍ≥†</small>
                    <div><%= plan.notes %></div>
                  <% end %>
                </div>

                <!-- ÏÉùÏÇ∞ ÏùºÏßÄ Ìèº -->
                <%= form_with(model: log, url: form_url, method: form_method, local: true) do |form| %>
                  <%= form.hidden_field :production_plan_id, value: plan.id %>
                  <%= form.hidden_field :finished_product_id, value: plan.finished_product_id %>
                  <%= form.hidden_field :production_date, value: plan.production_date %>

                  <% if log.errors.any? %>
                    <div class="alert alert-danger mb-4" role="alert">
                      <h5 class="alert-heading mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= pluralize(log.errors.count, "error") %> prohibited this production log from being saved:
                      </h5>
                      <ul class="mb-0">
                        <% log.errors.each do |error| %>
                          <li><%= error.full_message %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <!-- ÏÉùÏÇ∞ ÏãúÍ∞Ñ -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <%= form.label :production_time, "ÏÉùÏÇ∞ ÏãúÍ∞Ñ", class: "form-label", style: "font-weight: 500;" %>
                      <%= form.time_field :production_time,
                                          value: log.production_time || Time.current.strftime('%H:%M'),
                                          class: "form-control",
                                          placeholder: "Ïòà: 09:00" %>
                      <small class="form-text text-muted">ÏÉùÏÇ∞ ÏãúÏûë ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                  </div>

                  <!-- Í∏∞Ï†ïÎñ° Ï†ÑÏö© ÌïÑÎìú ÏÑπÏÖò -->
                  <div id="gijeongddeok-fields-<%= plan.id %>" style="<%= plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°') ? '' : 'display: none;' %>">
                    <hr class="my-4">
                    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
                      <i class="bi bi-clipboard-data me-2"></i>Í∏∞Ï†ïÎñ° ÏÉùÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                    </h5>

                    <!-- ÏÑ§Ï†ïÎêú ÏàúÏÑúÎåÄÎ°ú ÌïÑÎìú Î†åÎçîÎßÅ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">üìù ÏÉùÏÇ∞ Ï†ïÎ≥¥</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <% @gijeongddeok_fields.each do |field| %>
                            <% next if field.field_name == 'makgeolli_consumption' %>
                            <div class="col-md-4">
                              <%= form.label field.field_name, field.label, class: "form-label" %>
                              <div class="input-group">
                                <%= form.number_field field.field_name,
                                                      step: (field.field_name.ends_with?('_temp') || field.field_name.ends_with?('_amount') && field.field_name != 'yeast_amount' && field.field_name != 'salt_amount' && field.field_name != 'sugar_amount') ? 0.1 : nil,
                                                      class: "form-control",
                                                      id: "production_log_#{plan.id}_#{field.field_name}",
                                                      placeholder: field.category == 'temperature' ? "Ïòà: 25.0" : (field.field_name == 'water_amount' ? "Ïòà: 1.5" : "Ïòà: 100") %>
                                <span class="input-group-text">
                                  <%= case field.field_name
                                      when /temp$/
                                        '¬∞C'
                                      when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                                        'g'
                                      when 'water_amount'
                                        'L'
                                      else
                                        ''
                                      end %>
                                </span>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">üç∂ ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <%= form.label :makgeolli_consumption, "ÎßâÍ±∏Î¶¨ ÏÜåÎπÑÎüâ", class: "form-label" %>
                            <div class="input-group">
                              <%= form.number_field :makgeolli_consumption,
                                                    step: 0.1,
                                                    class: "form-control",
                                                    id: "production_log_#{plan.id}_makgeolli_consumption",
                                                    placeholder: "Ïòà: 2500" %>
                              <span class="input-group-text">mL</span>
                            </div>
                            <small class="form-text text-muted">ÏûÖÎ†• Ïãú ÏûêÎèôÏúºÎ°ú Ïû¨Í≥† Ï∂úÍ≥† Ï≤òÎ¶¨Îê©ÎãàÎã§.</small>
                          </div>

                          <div class="col-md-6">
                            <%= form.label :makgeolli_expiry_date, "ÎßâÍ±∏Î¶¨ Ïú†Ìö®Í∏∞Í∞Ñ", class: "form-label" %>
                            <%= form.date_field :makgeolli_expiry_date,
                                                class: "form-control" %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Í∏∞Î≥∏ ÎπÑÍ≥† -->
                  <div class="mb-4">
                    <%= form.label :notes, "ÎπÑÍ≥†", class: "form-label", style: "font-weight: 500;" %>
                    <%= form.text_area :notes,
                                       class: "form-control",
                                       rows: 3,
                                       placeholder: "ÏÉùÏÇ∞ Í≥ºÏ†ï Ï§ë ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)" %>
                  </div>

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <% if existing_log %>
                      <%= button_to production_log_path(existing_log),
                                    method: :delete,
                                    data: { confirm: 'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?' },
                                    class: "btn btn-outline-danger" do %>
                        <i class="bi bi-trash me-2"></i>ÏÇ≠Ï†ú
                      <% end %>
                    <% end %>
                    <%= form.submit existing_log ? "ÏàòÏ†ï" : "Îì±Î°ù",
                                    class: "btn-apple btn-apple-primary" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- ÏÉùÏÇ∞ Í≥ÑÌöç ÏóÜÏùå -->
    <div class="card-apple">
      <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #d2d2d7;"></i>
        <p class="text-muted mt-3 mb-0"><%= @date.strftime('%YÎÖÑ %mÏõî %dÏùº') %>Ïóê Îì±Î°ùÎêú ÏÉùÏÇ∞ Í≥ÑÌöçÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        <%= link_to production_plans_path(date: @date),
                    class: "btn-apple btn-apple-primary mt-3" do %>
          <i class="bi bi-calendar-plus me-2"></i>ÏÉùÏÇ∞ Í≥ÑÌöç Îì±Î°ùÌïòÍ∏∞
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Í∏∞Ï†ïÎñ° Í∏∞Î≥∏Í∞í Îç∞Ïù¥ÌÑ∞
    const defaults = {
      <% @gijeongddeok_fields.each do |field| %>
        <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
      <% end %>
    };

    // Í∞Å ÌÉ≠Ïùò ÌèºÏùÑ ÌôïÏù∏ÌïòÍ≥† Í∏∞Î≥∏Í∞í Ï†ÅÏö©
    <% @today_plans.each do |plan| %>
      <% if plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°') %>
        <% log = plan.production_logs.first || ProductionLog.new %>
        <% if log.new_record? %>
          // ÏÉà Î†àÏΩîÎìúÏù∏ Í≤ΩÏö∞ÏóêÎßå Í∏∞Î≥∏Í∞í Ï†ÅÏö©
          <% @gijeongddeok_fields.each do |field| %>
            document.querySelector(`#production_log_<%= plan.id %>_<%= field.field_name %>`)?.setAttribute('value', defaults.<%= field.field_name %> || '');
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  });
</script>

<style>
  .nav-tab-apple {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #1d1d1f;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .nav-tab-apple:hover:not(.active) {
    color: #0071e3;
    border-bottom-color: #d2d2d7;
  }

  .nav-tab-apple.active {
    color: #0071e3;
    border-bottom-color: #0071e3;
  }

  .tab-content > .tab-pane {
    background-color: white;
  }
</style>
