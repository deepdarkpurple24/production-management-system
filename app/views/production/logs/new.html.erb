<div class="container-fluid px-4 py-4">
  <!-- ÎÇ†Ïßú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
  <div class="card-modern mb-3">
    <div class="card-body py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to new_production_log_path(date: @production_log.production_date - 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>

        <div class="text-center">
          <h5 class="mb-0" style="font-weight: 600;">
            <%= @production_log.production_date.strftime('%YÎÖÑ %mÏõî %dÏùº (%a)') %>
          </h5>
          <%= link_to "Ïò§Îäò", new_production_log_path(date: Date.today),
                      class: "btn btn-sm btn-link text-muted" %>
        </div>

        <%= link_to new_production_log_path(date: @production_log.production_date + 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <% if @production_plans.any? %>
    <!-- ÏÉùÏÇ∞ Í≥ÑÌöç ÌÉ≠ -->
    <div class="card-modern">
      <div class="card-body p-0">
        <%
          # ÌÉ≠ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±: (plan, recipe) Ï°∞Ìï© ÏÉùÏÑ±
          tab_items = []
          @production_plans.each do |plan|
            recipes = plan.finished_product.recipes
            if recipes.any?
              # Î†àÏãúÌîºÍ∞Ä ÏûàÏúºÎ©¥ Í∞Å Î†àÏãúÌîºÎ≥Ñ ÌÉ≠ ÏÉùÏÑ±
              recipes.each do |recipe|
                tab_items << { plan: plan, recipe: recipe }
              end
            else
              # Î†àÏãúÌîºÍ∞Ä ÏóÜÏúºÎ©¥ ÏôÑÏ†úÌíà ÏûêÏ≤¥Î°ú ÌÉ≠ ÏÉùÏÑ±
              tab_items << { plan: plan, recipe: nil }
            end
          end
        %>

        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <ul class="nav nav-tabs border-bottom-0" id="productionTabs" role="tablist" style="padding: 1rem 1rem 0 1rem;">
          <% tab_items.each_with_index do |item, index| %>
            <% plan = item[:plan] %>
            <% recipe = item[:recipe] %>
            <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>
            <%
              # Ìï¥Îãπ Î†àÏãúÌîºÏùò ÏùºÏßÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
              has_log = plan.production_logs.exists?(recipe_id: recipe&.id)
              # ÌÉ≠ ÌëúÏãúÎ™Ö: Î†àÏãúÌîºÍ∞Ä ÏûàÏúºÎ©¥ "ÏôÑÏ†úÌíàÎ™Ö (Î†àÏãúÌîºÎ™Ö)", ÏóÜÏúºÎ©¥ "ÏôÑÏ†úÌíàÎ™Ö"
              tab_label = recipe ? "#{recipe.name}" : plan.finished_product.name
            %>
            <li class="nav-item" role="presentation">
              <button class="nav-tab-modern <%= 'active' if index == 0 %>"
                      id="<%= tab_id %>-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#<%= tab_id %>"
                      type="button"
                      role="tab">
                <div class="d-flex align-items-center gap-2">
                  <strong><%= tab_label %></strong>
                  <span class="badge bg-secondary" style="font-size: 0.7rem;">
                    <%= number_with_delimiter(plan.quantity) %><%= plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°') ? 'ÌÜµ' : 'Í∞ú' %>
                  </span>
                  <% if has_log %>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 0.9rem;"></i>
                  <% end %>
                </div>
              </button>
            </li>
          <% end %>
        </ul>

        <!-- ÌÉ≠ ÎÇ¥Ïö© -->
        <div class="tab-content" id="productionTabsContent">
          <% tab_items.each_with_index do |item, index| %>
            <% plan = item[:plan] %>
            <% recipe = item[:recipe] %>
            <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>

            <div class="tab-pane fade <%= 'show active' if index == 0 %>"
                 id="<%= tab_id %>"
                 role="tabpanel">
              <div class="p-4">
                <%
                  # Ïù¥ÎØ∏ Îì±Î°ùÎêú ÏùºÏßÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ (recipe_idÎ°ú Íµ¨Î∂Ñ)
                  existing_log = plan.production_logs.find_by(recipe_id: recipe&.id)
                  log = existing_log || ProductionLog.new(
                    production_plan: plan,
                    finished_product: plan.finished_product,
                    recipe: recipe,
                    production_date: plan.production_date
                  )
                  form_url = existing_log ? production_log_path(existing_log) : production_logs_path
                  form_method = existing_log ? :patch : :post
                %>

                <!-- Î∞òÏ£ΩÏùºÏßÄ Ìèº -->
                <%= form_with(model: log, url: form_url, method: form_method, local: true) do |form| %>
                  <%= form.hidden_field :production_plan_id, value: plan.id %>
                  <%= form.hidden_field :finished_product_id, value: plan.finished_product_id %>
                  <%= form.hidden_field :recipe_id, value: recipe&.id %>

                  <% if log.errors.any? %>
                    <div class="alert alert-danger mb-4" role="alert">
                      <h5 class="alert-heading mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= pluralize(log.errors.count, "error") %> prohibited this production log from being saved:
                      </h5>
                      <ul class="mb-0">
                        <% log.errors.each do |error| %>
                          <li><%= error.full_message %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <!-- ÏÉùÏÇ∞ ÏùºÏãú -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <%= form.label :production_date, "ÏÉùÏÇ∞ ÎÇ†Ïßú", class: "form-label", style: "font-weight: 500;" %>
                      <span class="text-danger">*</span>
                      <%= form.date_field :production_date,
                                          class: "form-control",
                                          required: true %>
                      <small class="form-text text-muted">ÏÉùÏÇ∞ ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                    <div class="col-md-6">
                      <%= form.label :production_time, "ÏÉùÏÇ∞ ÏãúÍ∞Ñ", class: "form-label", style: "font-weight: 500;" %>
                      <%= form.time_field :production_time,
                                          value: log.production_time || Time.current.strftime('%H:%M'),
                                          class: "form-control",
                                          placeholder: "Ïòà: 09:00" %>
                      <small class="form-text text-muted">ÏÉùÏÇ∞ ÏãúÏûë ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                  </div>

                  <%
                    # Î†àÏãúÌîº Î∞∞Ïú® Í≥ÑÏÇ∞ (Í∞úÎãπ Ï§ëÎüâÏù¥ ÏÑ§Ï†ïÎêú Í≤ΩÏö∞ÏóêÎßå, Í∏∞Ï†ïÎñ° Ï†úÏô∏)
                    fpr = recipe.present? ? plan.finished_product.finished_product_recipes.find_by(recipe_id: recipe.id) : nil
                    weight_per_unit = fpr&.quantity || 0
                    is_gijeongddeok = plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°')
                    show_recipe_ingredients = recipe.present? && weight_per_unit > 0 && !is_gijeongddeok
                  %>
                  <% if show_recipe_ingredients %>
                    <%
                      # Î∞∞Ïú® = (ÏÉùÏÇ∞Í≥ÑÌöç ÏàòÎüâ √ó Í∞úÎãπ Ï§ëÎüâ) / Î†àÏãúÌîº 1Î∞∞ÏßÄ Ï¥ùÌï©
                      recipe_total = recipe.recipe_ingredients.where(row_type: ['ingredient', nil]).sum(:weight)
                      recipe_total = recipe_total.zero? ? 1 : recipe_total
                      multiplier = (plan.quantity.to_f * weight_per_unit) / recipe_total
                      total_scaled = recipe_total * multiplier

                      # Ïû•ÎπÑ ÏµúÎåÄ ÏûëÏóÖ Ï§ëÎüâ ÌôïÏù∏ (g Îã®ÏúÑÎ°ú Î≥ÄÌôò)
                      max_work_capacity = recipe.recipe_equipments.where.not(work_capacity: [nil, 0]).maximum(:work_capacity)
                      max_work_capacity_g = max_work_capacity ? max_work_capacity * 1000 : nil  # kg ‚Üí g Î≥ÄÌôò

                      # ÏûëÏóÖ ÌöüÏàò Í≥ÑÏÇ∞
                      if max_work_capacity_g && max_work_capacity_g > 0 && total_scaled > max_work_capacity_g
                        batch_count = (total_scaled / max_work_capacity_g).ceil
                      else
                        batch_count = 1
                      end
                    %>

                    <!-- Î†àÏãúÌîº Ïû¨Î£å (ÏÉùÏÇ∞ Î∂ÑÎüâ Ï†ÅÏö©) - ÏûëÏóÖ ÌöüÏàòÎßåÌÅº ÌÖåÏù¥Î∏î ÏÉùÏÑ± -->
                    <div class="d-flex gap-3 mb-3 flex-wrap">
                    <% batch_count.times do |batch_index| %>
                      <div class="card recipe-ingredients-card" style="flex: 1; min-width: 250px;">
                        <div class="card-body p-0">
                          <table class="table table-sm mb-0" style="font-size: 0.9rem;">
                            <thead>
                              <tr>
                                <th style="padding: 0.6rem 1rem; font-weight: 600; color: #1d1d1f; background-color: #d6d8db;">
                                  <%= recipe.name %>
                                  <% if batch_count > 1 %>
                                    <span class="badge bg-secondary ms-2" style="font-size: 0.75rem;">
                                      <%= batch_index + 1 %>/<%= batch_count %>
                                    </span>
                                  <% end %>
                                </th>
                                <th class="text-end" style="padding: 0.6rem 1rem; font-weight: 500; color: #6e6e73; background-color: #d6d8db;">
                                  <%= log.production_date&.strftime('%m-%d') || Date.today.strftime('%m-%d') %> <%= log.production_time || Time.current.strftime('%H:%M') %>
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              <% running_subtotal = 0.0 %>
                              <% recipe.recipe_ingredients.order(:position).each do |ri| %>
                                <% if ri.row_type == 'subtotal' %>
                                  <% scaled_subtotal = (running_subtotal * multiplier) / batch_count %>
                                  <tr>
                                    <td style="padding: 0.5rem 1rem; font-weight: 600; color: #1d1d1f; background-color: #d6d8db;">ÏÜåÍ≥Ñ</td>
                                    <td class="text-end" style="padding: 0.5rem 1rem; font-weight: 600; color: #0071e3; background-color: #d6d8db;">
                                      <%= number_with_delimiter(scaled_subtotal.round(0)) %>
                                    </td>
                                  </tr>
                                  <% running_subtotal = 0.0 %>
                                <% else %>
                                  <% running_subtotal += ri.weight.to_f %>
                                  <%
                                    scaled_weight = (ri.weight.to_f * multiplier) / batch_count
                                    field_key = "batch_#{batch_index}_ri_#{ri.id}"
                                    saved_weights = log.ingredient_weights || {}
                                    display_weight = saved_weights[field_key].present? ? saved_weights[field_key].to_i : scaled_weight.round(0)
                                  %>
                                  <tr class="ingredient-row" style="cursor: pointer; user-select: none;">
                                    <td style="padding: 0.5rem 1rem; color: #1d1d1f;"><%= ri.display_name %></td>
                                    <td class="text-end" style="padding: 0.5rem 1rem; color: #1d1d1f; font-weight: 500;">
                                      <input type="number" name="production_log[ingredient_weights][<%= field_key %>]"
                                             class="ingredient-weight-input"
                                             value="<%= display_weight %>"
                                             style="width: 80px; text-align: right; border: none; background: transparent; font-weight: 500; color: #1d1d1f; user-select: text;">
                                    </td>
                                  </tr>
                                <% end %>
                              <% end %>
                            </tbody>
                            <tfoot>
                              <tr>
                                <td style="padding: 0.6rem 1rem; font-weight: 700; color: #1d1d1f; background-color: #d6d8db; border-top: 1px solid #ced4da;">
                                  <%= recipe.name %>Î¨¥Í≤å
                                </td>
                                <td class="text-end" style="padding: 0.6rem 1rem; color: #0071e3; font-weight: 700; font-size: 1rem; background-color: #d6d8db; border-top: 1px solid #ced4da;">
                                  <%= number_with_delimiter((total_scaled / batch_count).round(0)) %>
                                </td>
                              </tr>
                            </tfoot>
                          </table>
                        </div>
                      </div>
                    <% end %>
                    </div>
                  <% end %>

                  <!-- Í∏∞Ï†ïÎñ° Ï†ÑÏö© ÌïÑÎìú ÏÑπÏÖò -->
                  <div id="gijeongddeok-fields-<%= tab_id %>" style="<%= plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°') ? '' : 'display: none;' %>">
                    <hr class="my-4">
                    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
                      <i class="bi bi-clipboard-data me-2"></i>Í∏∞Ï†ïÎñ° ÏÉùÏÇ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                    </h5>

                    <!-- ÏÑ§Ï†ïÎêú ÏàúÏÑúÎåÄÎ°ú ÌïÑÎìú Î†åÎçîÎßÅ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">üìù ÏÉùÏÇ∞ Ï†ïÎ≥¥</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <% @gijeongddeok_fields.each do |field| %>
                            <% next if field.field_name == 'makgeolli_consumption' %>
                            <div class="col-md-4">
                              <%= form.label field.field_name, field.label, class: "form-label" %>
                              <div class="input-group">
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= tab_id %>_<%= field.field_name %>', -0.5)">
                                    <i class="bi bi-dash"></i>
                                  </button>
                                <% end %>
                                <%= form.number_field field.field_name,
                                                      step: field.field_name == 'dough_count' ? 0.5 : ((field.field_name.ends_with?('_temp') || field.field_name.ends_with?('_amount') && field.field_name != 'yeast_amount' && field.field_name != 'salt_amount' && field.field_name != 'sugar_amount') ? 0.1 : nil),
                                                      value: field.field_name == 'dough_count' ? (log.dough_count || plan.quantity) : (log.persisted? ? log.send(field.field_name) : @gijeongddeok_default.send(field.field_name)),
                                                      class: "form-control",
                                                      id: "production_log_#{tab_id}_#{field.field_name}",
                                                      placeholder: field.category == 'temperature' ? "Ïòà: 25.0" : (field.field_name == 'water_amount' ? "Ïòà: 1.5" : "Ïòà: 100") %>
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= tab_id %>_<%= field.field_name %>', 0.5)">
                                    <i class="bi bi-plus"></i>
                                  </button>
                                  <span class="input-group-text">ÌÜµ</span>
                                <% else %>
                                  <span class="input-group-text">
                                    <%= case field.field_name
                                        when /temp$/
                                          '¬∞C'
                                        when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                                          'g'
                                        when 'water_amount'
                                          'L'
                                        else
                                          ''
                                        end %>
                                  </span>
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">üç∂ ÎßâÍ±∏Î¶¨ Í¥ÄÎ¶¨</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <%= form.label :makgeolli_consumption, "ÎßâÍ±∏Î¶¨ ÏÜåÎπÑÎüâ", class: "form-label" %>
                            <div class="input-group">
                              <%= form.number_field :makgeolli_consumption,
                                                    step: 0.1,
                                                    value: log.persisted? ? log.makgeolli_consumption : @gijeongddeok_default.makgeolli_consumption,
                                                    class: "form-control",
                                                    id: "production_log_#{tab_id}_makgeolli_consumption",
                                                    placeholder: "Ïòà: 2500" %>
                              <span class="input-group-text">mL</span>
                            </div>
                            <small class="form-text text-muted">ÏûÖÎ†• Ïãú ÏûêÎèôÏúºÎ°ú Ïû¨Í≥† Ï∂úÍ≥† Ï≤òÎ¶¨Îê©ÎãàÎã§.</small>
                          </div>

                          <div class="col-md-6">
                            <%= form.label :makgeolli_expiry_date, "ÎßâÍ±∏Î¶¨ Ïú†Ìö®Í∏∞Í∞Ñ", class: "form-label" %>
                            <%= form.date_field :makgeolli_expiry_date,
                                                class: "form-control" %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Í∏∞Î≥∏ ÎπÑÍ≥† -->
                  <div class="mb-3">
                    <%= form.label :notes, "ÎπÑÍ≥†", class: "form-label", style: "font-weight: 500;" %>
                    <%= form.text_area :notes,
                                       class: "form-control",
                                       rows: 3,
                                       placeholder: "ÏÉùÏÇ∞ Í≥ºÏ†ï Ï§ë ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)" %>
                  </div>

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <%= form.submit existing_log ? "ÏàòÏ†ï" : "Îì±Î°ù",
                                    class: "btn-modern btn-modern-primary" %>
                    <%= link_to "Ï∑®ÏÜå", production_logs_path,
                                class: "btn-modern btn-modern-outline" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- ÏÉùÏÇ∞ Í≥ÑÌöç ÏóÜÏùå -->
    <div class="card-modern">
      <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #d2d2d7;"></i>
        <p class="text-muted mt-3 mb-0">Ïò§Îäò(<%= Date.today.strftime('%YÎÖÑ %mÏõî %dÏùº') %>)Ïóê Îì±Î°ùÎêú ÏÉùÏÇ∞ Í≥ÑÌöçÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        <%= link_to production_plans_path(date: Date.today),
                    class: "btn-modern btn-modern-primary mt-3" do %>
          <i class="bi bi-calendar-plus me-2"></i>ÏÉùÏÇ∞ Í≥ÑÌöç Îì±Î°ù
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // Í∏∞Î≥∏Í∞í Î°úÎìú Ìï®Ïàò
  function loadGijeongddeokDefaults() {
    // Í∏∞Ï†ïÎñ° Í∏∞Î≥∏Í∞í Îç∞Ïù¥ÌÑ∞
    const defaults = {
      <% @gijeongddeok_fields.each do |field| %>
        <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
      <% end %>
    };

    // Í∞Å ÌÉ≠Ïùò ÌèºÏùÑ ÌôïÏù∏ÌïòÍ≥† Í∏∞Î≥∏Í∞í Ï†ÅÏö©
    <%
      # tab_items Ïû¨Íµ¨ÏÑ± (ÏúÑÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
      tab_items_js = []
      @production_plans.each do |plan|
        recipes = plan.finished_product.recipes
        if recipes.any?
          recipes.each do |recipe|
            tab_items_js << { plan: plan, recipe: recipe }
          end
        else
          tab_items_js << { plan: plan, recipe: nil }
        end
      end
    %>

    <% tab_items_js.each do |item| %>
      <% plan = item[:plan] %>
      <% recipe = item[:recipe] %>
      <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>
      <% if plan.finished_product.name.include?('Í∏∞Ï†ïÎñ°') %>
        <% existing_log = plan.production_logs.find_by(recipe_id: recipe&.id) %>
        <% if existing_log.nil? %>
          // ÏÉà Î†àÏΩîÎìúÏù∏ Í≤ΩÏö∞ÏóêÎßå Í∏∞Î≥∏Í∞í Ï†ÅÏö©
          <% @gijeongddeok_fields.each do |field| %>
            const field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %> = document.querySelector(`#production_log_<%= tab_id %>_<%= field.field_name %>`);
            if (field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %> && field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %>.value === '') {
              field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %>.value = defaults.<%= field.field_name %> || '';
            }
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  }

  // DOMContentLoadedÏôÄ turbo:load Î™®ÎëêÏóêÏÑú Ïã§Ìñâ
  document.addEventListener('DOMContentLoaded', loadGijeongddeokDefaults);
  document.addEventListener('turbo:load', loadGijeongddeokDefaults);

  // Î∞òÏ£Ω ÌÜµÏàò +/- Î≤ÑÌäº Ìï∏Îì§Îü¨
  function adjustValue(fieldId, delta) {
    const field = document.getElementById(fieldId);
    if (field) {
      const currentValue = parseFloat(field.value) || 0;
      const newValue = currentValue + delta;
      field.value = Math.max(0, newValue).toFixed(1);
    }
  }

  // Ïû¨Î£å Ìñâ ÎçîÎ∏îÌÅ¥Î¶≠/ÎçîÎ∏îÌÉ≠ - Ïû¨Î£å Ìà¨ÏûÖ ÏôÑÎ£å ÌëúÏãú (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ ÏÇ¨Ïö©)
  (function() {
    const CHECKED_COLOR = '#c8e6c9';  // Ïó∞Ìïú Ï¥àÎ°ùÏÉâ
    let lastTapTime = 0;
    let lastTapTarget = null;

    function toggleRowColor(row) {
      const cells = row.querySelectorAll('td');
      const isChecked = row.dataset.checked === 'true';

      if (isChecked) {
        cells.forEach(cell => {
          cell.style.backgroundColor = '';
        });
        row.dataset.checked = 'false';
      } else {
        cells.forEach(cell => {
          cell.style.backgroundColor = CHECKED_COLOR;
        });
        row.dataset.checked = 'true';
      }
    }

    // PC: ÎçîÎ∏îÌÅ¥Î¶≠ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ) - input Ï†úÏô∏
    document.addEventListener('dblclick', function(e) {
      // input ÌïÑÎìúÎäî ÎçîÎ∏îÌÅ¥Î¶≠ Î¨¥Ïãú
      if (e.target.tagName === 'INPUT') return;

      const row = e.target.closest('.ingredient-row');
      if (row) {
        e.preventDefault();
        toggleRowColor(row);
      }
    });

    // Î™®Î∞îÏùº: ÎçîÎ∏îÌÉ≠ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ) - input Ï†úÏô∏
    document.addEventListener('touchend', function(e) {
      // input ÌïÑÎìúÎäî ÎçîÎ∏îÌÉ≠ Î¨¥Ïãú
      if (e.target.tagName === 'INPUT') return;

      const row = e.target.closest('.ingredient-row');
      if (!row) return;

      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTapTime;

      if (tapLength < 300 && tapLength > 0 && lastTapTarget === row) {
        e.preventDefault();
        toggleRowColor(row);
      }

      lastTapTime = currentTime;
      lastTapTarget = row;
    });
  })();
</script>

<style>
  .nav-tab-modern {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #1d1d1f;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .nav-tab-modern:hover:not(.active) {
    color: #0071e3;
    border-bottom-color: #d2d2d7;
  }

  .nav-tab-modern.active {
    color: #0071e3;
    border-bottom-color: #0071e3;
  }

  .tab-content > .tab-pane {
    background-color: white;
  }
</style>
