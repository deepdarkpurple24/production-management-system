<div class="container-fluid px-4 py-4">
  <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="card-modern mb-3">
    <div class="card-body py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to new_production_log_path(date: @production_log.production_date - 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>

        <div class="text-center">
          <h5 class="mb-0" style="font-weight: 600;">
            <%= @production_log.production_date.strftime('%Yë…„ %mì›” %dì¼ (%a)') %>
          </h5>
          <%= link_to "ì˜¤ëŠ˜", new_production_log_path(date: Date.today),
                      class: "btn btn-sm btn-link text-muted" %>
        </div>

        <%= link_to new_production_log_path(date: @production_log.production_date + 1.day),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <% if @production_plans.any? %>
    <!-- ìƒì‚° ê³„íš íƒ­ -->
    <div class="card-modern">
      <div class="card-body p-0">
        <%
          # íƒ­ ë°ì´í„° êµ¬ì„±: (plan, recipe) ì¡°í•© ìƒì„±
          tab_items = []
          @production_plans.each do |plan|
            recipes = plan.finished_product.recipes
            if recipes.any?
              # ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ ê° ë ˆì‹œí”¼ë³„ íƒ­ ìƒì„±
              recipes.each do |recipe|
                tab_items << { plan: plan, recipe: recipe }
              end
            else
              # ë ˆì‹œí”¼ê°€ ì—†ìœ¼ë©´ ì™„ì œí’ˆ ìì²´ë¡œ íƒ­ ìƒì„±
              tab_items << { plan: plan, recipe: nil }
            end
          end
        %>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs border-bottom-0" id="productionTabs" role="tablist" style="padding: 1rem 1rem 0 1rem;">
          <% tab_items.each_with_index do |item, index| %>
            <% plan = item[:plan] %>
            <% recipe = item[:recipe] %>
            <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>
            <%
              # í•´ë‹¹ ë ˆì‹œí”¼ì˜ ì¼ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
              has_log = plan.production_logs.exists?(recipe_id: recipe&.id)
              # íƒ­ í‘œì‹œëª…: ë ˆì‹œí”¼ê°€ ìˆìœ¼ë©´ "ì™„ì œí’ˆëª… (ë ˆì‹œí”¼ëª…)", ì—†ìœ¼ë©´ "ì™„ì œí’ˆëª…"
              tab_label = recipe ? "#{recipe.name}" : plan.finished_product.name
            %>
            <li class="nav-item" role="presentation">
              <button class="nav-tab-modern <%= 'active' if index == 0 %>"
                      id="<%= tab_id %>-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#<%= tab_id %>"
                      type="button"
                      role="tab">
                <div class="d-flex align-items-center gap-2">
                  <strong><%= tab_label %></strong>
                  <span class="badge bg-secondary" style="font-size: 0.7rem;">
                    <%= number_with_delimiter(plan.quantity) %><%= plan.finished_product.name.include?('ê¸°ì •ë–¡') ? 'í†µ' : 'ê°œ' %>
                  </span>
                  <% if has_log %>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 0.9rem;"></i>
                  <% end %>
                </div>
              </button>
            </li>
          <% end %>
        </ul>

        <!-- íƒ­ ë‚´ìš© -->
        <div class="tab-content" id="productionTabsContent">
          <% tab_items.each_with_index do |item, index| %>
            <% plan = item[:plan] %>
            <% recipe = item[:recipe] %>
            <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>

            <div class="tab-pane fade <%= 'show active' if index == 0 %>"
                 id="<%= tab_id %>"
                 role="tabpanel">
              <div class="p-4">
                <%
                  # ì´ë¯¸ ë“±ë¡ëœ ì¼ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸ (recipe_idë¡œ êµ¬ë¶„)
                  existing_log = plan.production_logs.find_by(recipe_id: recipe&.id)
                  log = existing_log || ProductionLog.new(
                    production_plan: plan,
                    finished_product: plan.finished_product,
                    recipe: recipe,
                    production_date: plan.production_date
                  )
                  form_url = existing_log ? production_log_path(existing_log) : production_logs_path
                  form_method = existing_log ? :patch : :post
                %>

                <!-- ë°˜ì£½ì¼ì§€ í¼ -->
                <%= form_with(model: log, url: form_url, method: form_method, local: true) do |form| %>
                  <%= form.hidden_field :production_plan_id, value: plan.id %>
                  <%= form.hidden_field :finished_product_id, value: plan.finished_product_id %>
                  <%= form.hidden_field :recipe_id, value: recipe&.id %>

                  <% if log.errors.any? %>
                    <div class="alert alert-danger mb-4" role="alert">
                      <h5 class="alert-heading mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= pluralize(log.errors.count, "error") %> prohibited this production log from being saved:
                      </h5>
                      <ul class="mb-0">
                        <% log.errors.each do |error| %>
                          <li><%= error.full_message %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <!-- ìƒì‚° ì¼ì‹œ -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <%= form.label :production_date, "ìƒì‚° ë‚ ì§œ", class: "form-label", style: "font-weight: 500;" %>
                      <span class="text-danger">*</span>
                      <%= form.date_field :production_date,
                                          class: "form-control",
                                          required: true %>
                      <small class="form-text text-muted">ìƒì‚° ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</small>
                    </div>
                    <div class="col-md-6">
                      <%= form.label :production_time, "ìƒì‚° ì‹œê°„", class: "form-label", style: "font-weight: 500;" %>
                      <%= form.time_field :production_time,
                                          value: log.production_time || Time.current.strftime('%H:%M'),
                                          class: "form-control",
                                          placeholder: "ì˜ˆ: 09:00" %>
                      <small class="form-text text-muted">ìƒì‚° ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.</small>
                    </div>
                  </div>

                  <!-- ê¸°ì •ë–¡ ì „ìš© í•„ë“œ ì„¹ì…˜ -->
                  <div id="gijeongddeok-fields-<%= tab_id %>" style="<%= plan.finished_product.name.include?('ê¸°ì •ë–¡') ? '' : 'display: none;' %>">
                    <hr class="my-4">
                    <h5 class="mb-3" style="color: #1d1d1f; font-weight: 600;">
                      <i class="bi bi-clipboard-data me-2"></i>ê¸°ì •ë–¡ ìƒì‚° ìƒì„¸ ì •ë³´
                    </h5>

                    <!-- ì„¤ì •ëœ ìˆœì„œëŒ€ë¡œ í•„ë“œ ë Œë”ë§ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">ğŸ“ ìƒì‚° ì •ë³´</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <% @gijeongddeok_fields.each do |field| %>
                            <% next if field.field_name == 'makgeolli_consumption' %>
                            <div class="col-md-4">
                              <%= form.label field.field_name, field.label, class: "form-label" %>
                              <div class="input-group">
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= tab_id %>_<%= field.field_name %>', -0.5)">
                                    <i class="bi bi-dash"></i>
                                  </button>
                                <% end %>
                                <%= form.number_field field.field_name,
                                                      step: field.field_name == 'dough_count' ? 0.5 : ((field.field_name.ends_with?('_temp') || field.field_name.ends_with?('_amount') && field.field_name != 'yeast_amount' && field.field_name != 'salt_amount' && field.field_name != 'sugar_amount') ? 0.1 : nil),
                                                      value: field.field_name == 'dough_count' ? (log.dough_count || plan.quantity) : (log.persisted? ? log.send(field.field_name) : @gijeongddeok_default.send(field.field_name)),
                                                      class: "form-control",
                                                      id: "production_log_#{tab_id}_#{field.field_name}",
                                                      placeholder: field.category == 'temperature' ? "ì˜ˆ: 25.0" : (field.field_name == 'water_amount' ? "ì˜ˆ: 1.5" : "ì˜ˆ: 100") %>
                                <% if field.field_name == 'dough_count' %>
                                  <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('production_log_<%= tab_id %>_<%= field.field_name %>', 0.5)">
                                    <i class="bi bi-plus"></i>
                                  </button>
                                  <span class="input-group-text">í†µ</span>
                                <% else %>
                                  <span class="input-group-text">
                                    <%= case field.field_name
                                        when /temp$/
                                          'Â°C'
                                        when 'yeast_amount', 'salt_amount', 'sugar_amount', 'steiva_amount'
                                          'g'
                                        when 'water_amount'
                                          'L'
                                        else
                                          ''
                                        end %>
                                  </span>
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- ë§‰ê±¸ë¦¬ ê´€ë¦¬ -->
                    <div class="card mb-3">
                      <div class="card-header" style="background-color: #f5f5f7;">
                        <h6 class="mb-0" style="font-weight: 500;">ğŸ¶ ë§‰ê±¸ë¦¬ ê´€ë¦¬</h6>
                      </div>
                      <div class="card-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <%= form.label :makgeolli_consumption, "ë§‰ê±¸ë¦¬ ì†Œë¹„ëŸ‰", class: "form-label" %>
                            <div class="input-group">
                              <%= form.number_field :makgeolli_consumption,
                                                    step: 0.1,
                                                    value: log.persisted? ? log.makgeolli_consumption : @gijeongddeok_default.makgeolli_consumption,
                                                    class: "form-control",
                                                    id: "production_log_#{tab_id}_makgeolli_consumption",
                                                    placeholder: "ì˜ˆ: 2500" %>
                              <span class="input-group-text">mL</span>
                            </div>
                            <small class="form-text text-muted">ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì¬ê³  ì¶œê³  ì²˜ë¦¬ë©ë‹ˆë‹¤.</small>
                          </div>

                          <div class="col-md-6">
                            <%= form.label :makgeolli_expiry_date, "ë§‰ê±¸ë¦¬ ìœ íš¨ê¸°ê°„", class: "form-label" %>
                            <%= form.date_field :makgeolli_expiry_date,
                                                class: "form-control" %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ê¸°ë³¸ ë¹„ê³  -->
                  <div class="mb-3">
                    <%= form.label :notes, "ë¹„ê³ ", class: "form-label", style: "font-weight: 500;" %>
                    <%= form.text_area :notes,
                                       class: "form-control",
                                       rows: 3,
                                       placeholder: "ìƒì‚° ê³¼ì • ì¤‘ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" %>
                  </div>

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <%= form.submit existing_log ? "ìˆ˜ì •" : "ë“±ë¡",
                                    class: "btn-modern btn-modern-primary" %>
                    <%= link_to "ì·¨ì†Œ", production_logs_path,
                                class: "btn-modern btn-modern-outline" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- ìƒì‚° ê³„íš ì—†ìŒ -->
    <div class="card-modern">
      <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #d2d2d7;"></i>
        <p class="text-muted mt-3 mb-0">ì˜¤ëŠ˜(<%= Date.today.strftime('%Yë…„ %mì›” %dì¼') %>)ì— ë“±ë¡ëœ ìƒì‚° ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <%= link_to production_plans_path(date: Date.today),
                    class: "btn-modern btn-modern-primary mt-3" do %>
          <i class="bi bi-calendar-plus me-2"></i>ìƒì‚° ê³„íš ë“±ë¡
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // ê¸°ë³¸ê°’ ë¡œë“œ í•¨ìˆ˜
  function loadGijeongddeokDefaults() {
    // ê¸°ì •ë–¡ ê¸°ë³¸ê°’ ë°ì´í„°
    const defaults = {
      <% @gijeongddeok_fields.each do |field| %>
        <%= field.field_name %>: <%= @gijeongddeok_default.send(field.field_name).to_f %>,
      <% end %>
    };

    // ê° íƒ­ì˜ í¼ì„ í™•ì¸í•˜ê³  ê¸°ë³¸ê°’ ì ìš©
    <%
      # tab_items ì¬êµ¬ì„± (ìœ„ì™€ ë™ì¼í•œ ë¡œì§)
      tab_items_js = []
      @production_plans.each do |plan|
        recipes = plan.finished_product.recipes
        if recipes.any?
          recipes.each do |recipe|
            tab_items_js << { plan: plan, recipe: recipe }
          end
        else
          tab_items_js << { plan: plan, recipe: nil }
        end
      end
    %>

    <% tab_items_js.each do |item| %>
      <% plan = item[:plan] %>
      <% recipe = item[:recipe] %>
      <% tab_id = "plan-#{plan.id}-recipe-#{recipe&.id || 'none'}" %>
      <% if plan.finished_product.name.include?('ê¸°ì •ë–¡') %>
        <% existing_log = plan.production_logs.find_by(recipe_id: recipe&.id) %>
        <% if existing_log.nil? %>
          // ìƒˆ ë ˆì½”ë“œì¸ ê²½ìš°ì—ë§Œ ê¸°ë³¸ê°’ ì ìš©
          <% @gijeongddeok_fields.each do |field| %>
            const field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %> = document.querySelector(`#production_log_<%= tab_id %>_<%= field.field_name %>`);
            if (field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %> && field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %>.value === '') {
              field_<%= tab_id.gsub('-', '_') %>_<%= field.field_name %>.value = defaults.<%= field.field_name %> || '';
            }
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  }

  // DOMContentLoadedì™€ turbo:load ëª¨ë‘ì—ì„œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', loadGijeongddeokDefaults);
  document.addEventListener('turbo:load', loadGijeongddeokDefaults);

  // ë°˜ì£½ í†µìˆ˜ +/- ë²„íŠ¼ í•¸ë“¤ëŸ¬
  function adjustValue(fieldId, delta) {
    const field = document.getElementById(fieldId);
    if (field) {
      const currentValue = parseFloat(field.value) || 0;
      const newValue = currentValue + delta;
      field.value = Math.max(0, newValue).toFixed(1);
    }
  }
</script>

<style>
  .nav-tab-modern {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #1d1d1f;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .nav-tab-modern:hover:not(.active) {
    color: #0071e3;
    border-bottom-color: #d2d2d7;
  }

  .nav-tab-modern.active {
    color: #0071e3;
    border-bottom-color: #0071e3;
  }

  .tab-content > .tab-pane {
    background-color: white;
  }
</style>
