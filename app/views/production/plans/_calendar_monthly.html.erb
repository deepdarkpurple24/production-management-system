<%
  # 캘린더 시작일 (월요일 시작)
  calendar_start = start_date.beginning_of_month.beginning_of_week(:monday)
  calendar_end = end_date.end_of_month.end_of_week(:monday)

  # 날짜별 생산 계획 그룹화
  plans_by_date = production_plans.group_by { |plan| plan.production_date }
%>

<div class="table-responsive">
  <table class="table table-bordered mb-0" style="table-layout: fixed;">
    <thead style="background-color: #f5f5f7;">
      <tr>
        <% ['월', '화', '수', '목', '금', '토', '일'].each do |day| %>
          <th class="text-center py-2" style="font-weight: 500; font-size: 0.875rem; width: 14.28%;">
            <%= day %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% current_date = calendar_start %>
      <% while current_date <= calendar_end %>
        <tr>
          <% 7.times do %>
            <%
              is_today = current_date == Date.today
              is_other_month = current_date.month != date.month
              day_plans = plans_by_date[current_date] || []
            %>
            <td class="calendar-cell <%= 'today' if is_today %> <%= 'other-month' if is_other_month %>"
                data-date="<%= current_date %>"
                onclick="window.location.href='<%= new_production_plan_path(date: current_date, view: 'monthly') %>'">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span style="font-weight: <%= is_today ? '600' : '500' %>; font-size: 0.875rem;">
                  <%= current_date.day %>
                </span>
                <% if day_plans.any? %>
                  <span class="badge bg-primary rounded-pill" style="font-size: 0.7rem;">
                    <%= day_plans.size %>
                  </span>
                <% end %>
              </div>
              <div class="plans-container">
                <% day_plans.first(3).each do |plan| %>
                  <% unit = plan.finished_product.name == '기정떡' ? '통' : '개' %>
                  <div class="plan-item"
                       onclick="event.stopPropagation(); window.location.href='<%= edit_production_plan_path(plan, view: 'monthly') %>'"
                       title="<%= plan.finished_product.name %> <%= plan.quantity %><%= unit %>">
                    <%= truncate(plan.finished_product.name, length: 15) %> <%= plan.quantity %><%= unit %>
                  </div>
                <% end %>
                <% if day_plans.size > 3 %>
                  <div class="text-muted" style="font-size: 0.7rem; padding-left: 6px;">
                    +<%= day_plans.size - 3 %>개 더보기
                  </div>
                <% end %>
              </div>
            </td>
            <% current_date += 1.day %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
