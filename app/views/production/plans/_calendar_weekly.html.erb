<%
  # 날짜별 생산 계획 그룹화
  plans_by_date = production_plans.group_by { |plan| plan.production_date }
%>

<div class="table-responsive">
  <table class="table table-bordered mb-0" style="table-layout: fixed;">
    <thead style="background-color: #f5f5f7;">
      <tr>
        <% (start_date..end_date).each do |date| %>
          <%
            day_name = ['일', '월', '화', '수', '목', '금', '토'][date.wday]
            is_today = date == Date.today
          %>
          <th class="text-center py-2 <%= 'bg-primary text-white' if is_today %>"
              style="font-weight: 500; font-size: 0.875rem; width: 14.28%;">
            <%= day_name %><br>
            <small><%= date.day %>일</small>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <tr>
        <% (start_date..end_date).each do |date| %>
          <%
            is_today = date == Date.today
            day_plans = plans_by_date[date] || []
          %>
          <td class="calendar-cell <%= 'today' if is_today %>"
              data-date="<%= date %>"
              onclick="window.location.href='<%= new_production_plan_path(date: date, view: 'weekly') %>'">
            <div class="d-flex justify-content-end mb-2">
              <% if day_plans.any? %>
                <span class="badge bg-primary rounded-pill" style="font-size: 0.7rem;">
                  <%= day_plans.size %>
                </span>
              <% end %>
            </div>
            <div class="plans-container">
              <% day_plans.each do |plan| %>
                <div class="plan-item"
                     onclick="event.stopPropagation(); window.location.href='<%= edit_production_plan_path(plan, view: 'weekly') %>'"
                     title="<%= plan.finished_product.name %> (<%= plan.quantity %>개)">
                  <%= truncate(plan.finished_product.name, length: 12) %> (<%= plan.quantity %>)
                </div>
              <% end %>
            </div>
          </td>
        <% end %>
      </tr>
    </tbody>
  </table>
</div>
