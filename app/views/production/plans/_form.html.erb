<%
  form_url = production_plan.new_record? ? production_plans_path : production_plan_path(production_plan)
  form_method = production_plan.new_record? ? :post : :patch
%>
<%= form_with(model: production_plan, url: form_url, method: form_method, local: true) do |form| %>
  <% if production_plan.errors.any? %>
    <div class="alert alert-danger mb-4" role="alert">
      <h5 class="alert-heading mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= pluralize(production_plan.errors.count, "error") %> prohibited this production plan from being saved:
      </h5>
      <ul class="mb-0">
        <% production_plan.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-4">
    <%= form.label :finished_product_id, "완제품", class: "form-label", style: "font-weight: 500;" %>
    <%= form.select :finished_product_id,
                    options_from_collection_for_select(@finished_products, :id, :name, production_plan.finished_product_id),
                    { prompt: "완제품을 선택하세요" },
                    class: "form-select",
                    id: "finished_product_select",
                    required: true %>
    <small class="form-text text-muted">생산할 완제품을 선택하세요.</small>

    <% @finished_products.each do |fp| %>
      <input type="hidden" id="finished_product_name_<%= fp.id %>" value="<%= fp.name %>">
    <% end %>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <%= form.label :production_date, "생산 예정일", class: "form-label", style: "font-weight: 500;" %>
      <%= form.text_field :production_date,
                          value: production_plan.production_date&.strftime('%Y-%m-%d'),
                          class: "form-control flatpickr",
                          placeholder: "날짜를 선택하세요",
                          readonly: true,
                          required: true %>
      <small class="form-text text-muted">생산 예정 날짜를 입력하세요.</small>
    </div>

    <div class="col-md-6">
      <%= form.label :quantity, "수량", class: "form-label", style: "font-weight: 500;" %>
      <div class="input-group">
        <button type="button" class="btn btn-outline-secondary" id="quantity_decrease">
          <i class="bi bi-dash"></i>
        </button>
        <%= form.number_field :quantity,
                              class: "form-control text-center",
                              min: 0.5,
                              step: 1,
                              id: "quantity_input",
                              required: true,
                              placeholder: "생산 수량 입력" %>
        <button type="button" class="btn btn-outline-secondary" id="quantity_increase">
          <i class="bi bi-plus"></i>
        </button>
        <span class="input-group-text" id="quantity_unit">개</span>
      </div>
      <small class="form-text text-muted">생산할 수량을 입력하세요.</small>
    </div>
  </div>

  <div class="mb-4">
    <%= form.label :notes, "비고", class: "form-label", style: "font-weight: 500;" %>
    <%= form.text_area :notes,
                       class: "form-control",
                       rows: 4,
                       placeholder: "추가 메모나 특이사항을 입력하세요 (선택사항)" %>
    <small class="form-text text-muted">생산 계획에 대한 추가 메모를 입력할 수 있습니다.</small>
  </div>

  <%= form.hidden_field :view, value: params[:view] %>

  <div class="d-flex justify-content-end gap-2">
    <%= link_to production_plans_path(view: params[:view] || 'monthly', date: production_plan.production_date || Date.today),
                class: "btn btn-outline-secondary" do %>
      <i class="bi bi-x-lg me-2"></i>취소
    <% end %>
    <%= form.submit production_plan.new_record? ? "등록" : "수정",
                    class: "btn-apple btn-apple-primary" %>
  </div>
<% end %>

<script>
  document.addEventListener('turbo:load', function() {
    // Flatpickr 초기화 (한국어, YYYY-MM-DD 형식)
    flatpickr('.flatpickr', {
      locale: 'ko',
      dateFormat: 'Y-m-d',
      allowInput: false,
      disableMobile: true
    });

    // 완제품 선택 및 수량 관리
    var finishedProductSelect = document.getElementById('finished_product_select');
    var quantityInput = document.getElementById('quantity_input');
    var quantityUnit = document.getElementById('quantity_unit');
    var quantityDecrease = document.getElementById('quantity_decrease');
    var quantityIncrease = document.getElementById('quantity_increase');
    var currentStep = 1;
    var currentMin = 1;

    // 완제품 선택 시 단위 변경
    if (finishedProductSelect) {
      // 초기 로드 시 체크
      updateQuantitySettings();

      finishedProductSelect.addEventListener('change', function() {
        updateQuantitySettings();
      });
    }

    function updateQuantitySettings() {
      var selectedId = finishedProductSelect.value;
      if (!selectedId) return;

      var nameInput = document.getElementById('finished_product_name_' + selectedId);
      if (!nameInput) return;

      var productName = nameInput.value;
      console.log('선택된 완제품:', productName);

      if (productName === '기정떡') {
        // 기정떡: 통 단위, 0.5씩 증감
        quantityUnit.textContent = '통';
        currentStep = 0.5;
        currentMin = 0.5;
        quantityInput.step = 0.5;
        quantityInput.min = 0.5;

        // 현재 값이 0이거나 비어있으면 0.5로 설정
        if (!quantityInput.value || parseFloat(quantityInput.value) === 0) {
          quantityInput.value = 0.5;
        }
      } else {
        // 다른 제품: 개 단위, 1씩 증감
        quantityUnit.textContent = '개';
        currentStep = 1;
        currentMin = 1;
        quantityInput.step = 1;
        quantityInput.min = 1;

        // 현재 값이 0이거나 비어있으면 1로 설정
        if (!quantityInput.value || parseFloat(quantityInput.value) === 0) {
          quantityInput.value = 1;
        }
      }
    }

    // +/- 버튼 기능
    if (quantityDecrease) {
      quantityDecrease.addEventListener('click', function() {
        var currentValue = parseFloat(quantityInput.value) || currentMin;
        var newValue = currentValue - currentStep;
        if (newValue >= currentMin) {
          quantityInput.value = newValue;
        }
      });
    }

    if (quantityIncrease) {
      quantityIncrease.addEventListener('click', function() {
        var currentValue = parseFloat(quantityInput.value) || 0;
        var newValue = currentValue + currentStep;
        quantityInput.value = newValue;
      });
    }
  });
</script>
