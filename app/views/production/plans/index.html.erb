<%= render 'production/shared/sub_navigation' %>

<div class="container mt-4">
  <!-- 헤더 섹션 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0" style="font-weight: 600; letter-spacing: -0.02em;">생산 계획</h4>
      <p class="text-muted small mb-0">Production Planning</p>
    </div>
  </div>

  <!-- 뷰 모드 탭 -->
  <ul class="nav nav-tabs mb-3" id="viewModeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= params[:view] != 'list' ? 'active' : '' %>" id="calendar-tab" data-bs-toggle="tab"
              data-bs-target="#calendar-view" type="button" role="tab" aria-controls="calendar-view" aria-selected="true">
        <i class="bi bi-calendar3 me-1"></i>캘린더 뷰
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= params[:view] == 'list' ? 'active' : '' %>" id="list-tab" data-bs-toggle="tab"
              data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="false">
        <i class="bi bi-list-ul me-1"></i>리스트 뷰
      </button>
    </li>
  </ul>

  <div class="tab-content" id="viewModeTabContent">
    <!-- ===============================
         캘린더 뷰
    =============================== -->
    <div class="tab-pane fade <%= params[:view] != 'list' ? 'show active' : '' %>" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
      <!-- 날짜 네비게이션 -->
      <div class="card-modern mb-4">
        <div class="card-body py-3 px-3">
          <div class="d-flex justify-content-between align-items-center">
            <%= link_to production_plans_path(date: @date - 1.month),
                        class: "btn btn-sm btn-outline-secondary" do %>
              <i class="bi bi-chevron-left"></i>
            <% end %>

            <div class="text-center">
              <h5 class="mb-0" style="font-weight: 600;">
                <%= @date.strftime('%Y년 %m월') %>
              </h5>
              <%= link_to "오늘", production_plans_path(date: Date.today),
                          class: "btn btn-sm btn-link text-muted" %>
            </div>

            <%= link_to production_plans_path(date: @date + 1.month),
                        class: "btn btn-sm btn-outline-secondary" do %>
              <i class="bi bi-chevron-right"></i>
            <% end %>
          </div>
        </div>
      </div>

      <!-- 캘린더 그리드 -->
      <div class="card-modern">
        <div class="card-body p-0">
          <div class="calendar-grid">
            <!-- 요일 헤더 -->
            <div class="calendar-header">
              <% %w[일 월 화 수 목 금 토].each_with_index do |day, index| %>
                <div class="calendar-day-name <%= index == 0 ? 'sunday' : '' %> <%= index == 6 ? 'saturday' : '' %>">
                  <%= day %>
                </div>
              <% end %>
            </div>

            <!-- 날짜 셀 -->
            <div class="calendar-body">
              <%
                # 달력 시작일 (해당 월 1일이 속한 주의 일요일)
                first_day = @start_date
                start_calendar = first_day - first_day.wday.days

                # 달력 종료일 (해당 월 마지막 날이 속한 주의 토요일)
                last_day = @end_date
                end_calendar = last_day + (6 - last_day.wday).days

                # 날짜별 생산계획 그룹화
                plans_by_date = @production_plans.group_by(&:production_date)
              %>

              <% (start_calendar..end_calendar).each do |day| %>
                <%
                  is_current_month = day.month == @date.month
                  is_today = day == Date.today
                  is_past = day < Date.today
                  is_future = day > Date.today
                  day_plans = plans_by_date[day] || []
                  has_plans = day_plans.any?
                %>
                <div class="calendar-cell <%= 'other-month' unless is_current_month %> <%= 'today' if is_today %> <%= 'past' if is_past %> <%= 'has-plans' if has_plans %>"
                     data-date="<%= day.to_s %>"
                     data-is-past="<%= is_past %>">
                  <div class="calendar-date <%= 'sunday' if day.wday == 0 %> <%= 'saturday' if day.wday == 6 %>">
                    <%= day.day %>
                  </div>
                  <div class="calendar-content">
                    <% if has_plans %>
                      <% day_plans.each do |plan| %>
                        <%
                          is_gijeongddeok = plan.recipe&.name&.include?('기정떡')
                          recipe_name = plan.recipe&.name || plan.finished_product&.name || '기타'
                        %>
                        <div class="plan-badge <%= is_gijeongddeok ? 'gijeongddeok' : 'other' %>">
                          <span class="plan-name"><%= truncate(recipe_name, length: 10) %></span>
                          <span class="plan-qty"><%= plan.quantity %><%= plan.unit_label %></span>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- 범례 -->
      <div class="mt-3 d-flex gap-4 justify-content-center">
        <div class="d-flex align-items-center">
          <span class="legend-dot gijeongddeok me-2"></span>
          <small class="text-muted">기정떡</small>
        </div>
        <div class="d-flex align-items-center">
          <span class="legend-dot other me-2"></span>
          <small class="text-muted">기타 제품</small>
        </div>
        <div class="d-flex align-items-center">
          <span class="legend-dot past me-2"></span>
          <small class="text-muted">과거 (실적)</small>
        </div>
      </div>
    </div>

    <!-- ===============================
         리스트 뷰 (기존 레시피 기반 입력)
    =============================== -->
    <div class="tab-pane fade <%= params[:view] == 'list' ? 'show active' : '' %>" id="list-view" role="tabpanel" aria-labelledby="list-tab">
      <!-- 날짜 네비게이션 -->
      <div class="card-modern mb-4">
        <div class="card-body py-3 px-3">
          <div class="d-flex justify-content-between align-items-center">
            <%= link_to production_plans_path(date: @date - 1.month, view: 'list'),
                        class: "btn btn-sm btn-outline-secondary" do %>
              <i class="bi bi-chevron-left"></i>
            <% end %>

            <div class="text-center">
              <h5 class="mb-0" style="font-weight: 600;">
                <%= @date.strftime('%Y년 %m월') %>
              </h5>
              <%= link_to "오늘", production_plans_path(date: Date.today, view: 'list'),
                          class: "btn btn-sm btn-link text-muted" %>
            </div>

            <%= link_to production_plans_path(date: @date + 1.month, view: 'list'),
                        class: "btn btn-sm btn-outline-secondary" do %>
              <i class="bi bi-chevron-right"></i>
            <% end %>
          </div>
        </div>
      </div>

      <!-- 레시피 기반 생산 계획 (기존 코드) -->
      <% if @recipes.any? %>
        <%= form_with url: batch_create_production_plans_path, method: :post, local: true, id: "production-plan-form" do |f| %>
          <%= hidden_field_tag :date, @date.to_s %>

          <% @recipes.each do |recipe| %>
            <%
              existing_plan = @production_plans.find { |p| p.recipe_id == recipe.id }
              current_quantity = existing_plan&.quantity || 0
              current_unit_type = existing_plan&.unit_type || '통'

              is_gijeongddeok = recipe.name.include?('기정떡')
              default_unit = is_gijeongddeok ? '통' : '개'
              step_value = is_gijeongddeok ? 0.5 : 1
              current_unit_type = existing_plan ? existing_plan.unit_type : default_unit

              related_products = recipe.finished_products.order(:name)

              gijeongddeok_default = GijeongddeokDefault.instance
              primary_product_id = nil
              if is_gijeongddeok
                default_product_ids = gijeongddeok_default.default_finished_product_ids || []
                primary_product_id = gijeongddeok_default.primary_finished_product_id
                if default_product_ids.any?
                  default_products = FinishedProduct.where(id: default_product_ids)
                  existing_ids = related_products.pluck(:id)
                  additional_products = default_products.reject { |p| existing_ids.include?(p.id) }
                  related_products = (related_products.to_a + additional_products).sort_by(&:name)
                end
              end
            %>

            <div class="card-modern mb-3">
              <div class="card-header d-flex justify-content-between align-items-center"
                   style="background-color: #f5f5f7; border-bottom: 1px solid #e8e8ed;">
                <div class="d-flex align-items-center">
                  <i class="bi bi-journal-text me-2" style="color: #0071e3; font-size: 1.2rem;"></i>
                  <h5 class="mb-0" style="font-weight: 600;"><%= recipe.name %></h5>
                  <% if recipe.total_weight > 0 %>
                    <span class="badge bg-light text-muted ms-2" style="font-weight: normal;">
                      <%= number_with_delimiter(recipe.total_weight.round(0)) %>g/1<%= default_unit %>
                    </span>
                  <% end %>
                </div>
                <div class="d-flex align-items-center">
                  <!-- 수량 입력 -->
                  <div class="quantity-input-group d-flex align-items-center me-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn"
                            data-action="decrease" data-recipe-id="<%= recipe.id %>" data-step="<%= step_value %>"
                            style="border-radius: 8px 0 0 8px; width: 36px; height: 36px;">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input type="number"
                           name="plans[<%= recipe.id %>][quantity]"
                           value="<%= current_quantity %>"
                           min="0"
                           step="<%= step_value %>"
                           class="form-control text-center quantity-input"
                           data-recipe-id="<%= recipe.id %>"
                           data-original="<%= current_quantity %>"
                           data-step="<%= step_value %>"
                           style="width: 70px; border-radius: 0; border-left: 0; border-right: 0; height: 36px; font-weight: 600;">
                    <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn"
                            data-action="increase" data-recipe-id="<%= recipe.id %>" data-step="<%= step_value %>"
                            style="border-radius: 0 8px 8px 0; width: 36px; height: 36px;">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                  <!-- 단위 선택 -->
                  <select name="plans[<%= recipe.id %>][unit_type]"
                          class="form-select form-select-sm"
                          style="width: 70px; height: 36px;">
                    <option value="개" <%= '통' != current_unit_type ? 'selected' : '' %>>개</option>
                    <option value="통" <%= '통' == current_unit_type ? 'selected' : '' %>>통</option>
                  </select>
                </div>
              </div>

              <div id="recipe-<%= recipe.id %>">
                <div class="card-body p-0">
                  <% if related_products.any? %>
                    <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                      <thead style="background-color: #fafafa;">
                        <tr>
                          <th style="padding: 0.75rem 1rem; font-weight: 600; color: #6e6e73;">제품명</th>
                          <th style="padding: 0.75rem 1rem; font-weight: 600; color: #6e6e73; width: 100px;">개당 중량</th>
                          <th class="text-center" style="padding: 0.75rem 1rem; font-weight: 600; color: #6e6e73; width: 180px;">수량 (개)</th>
                          <th class="text-end" style="padding: 0.75rem 1rem; font-weight: 600; color: #6e6e73; width: 120px;">사용 중량</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% related_products.each do |product| %>
                          <%
                            existing_allocation = existing_plan&.production_plan_allocations&.find { |a| a.finished_product_id == product.id }
                            allocation_qty = existing_allocation&.quantity || 0
                            product_weight = product.weight || 0
                            is_primary = primary_product_id && primary_product_id == product.id
                          %>
                          <tr class="<%= 'table-warning' if is_primary %>">
                            <td style="padding: 0.75rem 1rem; color: #1d1d1f;">
                              <% if is_primary %>
                                <i class="bi bi-star-fill me-2" style="color: #ff9500;"></i>
                              <% else %>
                                <i class="bi bi-box me-2" style="color: #34c759;"></i>
                              <% end %>
                              <%= product.name %>
                              <% if is_primary %>
                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7rem;">자동계산</span>
                              <% end %>
                            </td>
                            <td style="padding: 0.75rem 1rem; color: #6e6e73;">
                              <%= number_with_delimiter(product_weight.round(0)) %><%= product.weight_unit || 'g' %>
                            </td>
                            <td class="text-center" style="padding: 0.5rem 1rem;">
                              <% if is_primary %>
                                <div class="d-flex justify-content-center align-items-center">
                                  <input type="number"
                                         name="plans[<%= recipe.id %>][allocations][<%= product.id %>]"
                                         value="<%= allocation_qty %>"
                                         min="0"
                                         class="form-control text-center primary-allocation-input"
                                         data-recipe-id="<%= recipe.id %>"
                                         data-product-id="<%= product.id %>"
                                         data-weight="<%= product_weight %>"
                                         data-is-primary="true"
                                         readonly
                                         style="width: 80px; height: 32px; font-weight: 600; font-size: 0.85rem; background-color: #fff3cd; border-color: #ffc107;">
                                </div>
                              <% else %>
                                <div class="quantity-input-group d-flex justify-content-center align-items-center">
                                  <button type="button" class="btn btn-outline-secondary btn-sm allocation-btn"
                                          data-action="decrease"
                                          data-recipe-id="<%= recipe.id %>"
                                          data-product-id="<%= product.id %>"
                                          style="border-radius: 8px 0 0 8px; width: 32px; height: 32px;">
                                    <i class="bi bi-dash"></i>
                                  </button>
                                  <input type="number"
                                         name="plans[<%= recipe.id %>][allocations][<%= product.id %>]"
                                         value="<%= allocation_qty %>"
                                         min="0"
                                         class="form-control text-center allocation-input"
                                         data-recipe-id="<%= recipe.id %>"
                                         data-product-id="<%= product.id %>"
                                         data-weight="<%= product_weight %>"
                                         data-original="<%= allocation_qty %>"
                                         style="width: 60px; border-radius: 0; border-left: 0; border-right: 0; height: 32px; font-weight: 600; font-size: 0.85rem;">
                                  <button type="button" class="btn btn-outline-secondary btn-sm allocation-btn"
                                          data-action="increase"
                                          data-recipe-id="<%= recipe.id %>"
                                          data-product-id="<%= product.id %>"
                                          style="border-radius: 0 8px 8px 0; width: 32px; height: 32px;">
                                    <i class="bi bi-plus"></i>
                                  </button>
                                </div>
                              <% end %>
                            </td>
                            <td class="text-end allocation-weight" style="padding: 0.75rem 1rem; color: <%= is_primary ? '#ff9500' : '#0071e3' %>; font-weight: 600;"
                                data-recipe-id="<%= recipe.id %>"
                                data-product-id="<%= product.id %>"
                                data-is-primary="<%= is_primary %>">
                              <%= number_with_delimiter((product_weight * allocation_qty).round(0)) %>g
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                      <tfoot style="background-color: #f5f5f7;">
                        <tr>
                          <td colspan="3" class="text-end" style="padding: 0.75rem 1rem; font-weight: 600;">
                            잔여 중량 (기본 제품용):
                          </td>
                          <td class="text-end remaining-weight" style="padding: 0.75rem 1rem; font-weight: 700; color: #ff9500;"
                              data-recipe-id="<%= recipe.id %>"
                              data-total-weight="<%= recipe.total_weight %>">
                            -
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  <% else %>
                    <div class="text-center py-4">
                      <span class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        이 레시피를 사용하는 완제품이 없습니다.
                      </span>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

          <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn-modern btn-modern-primary" id="save-btn">
              <i class="bi bi-check-lg me-2"></i>저장
            </button>
          </div>
        <% end %>
      <% else %>
        <div class="card-modern">
          <div class="card-body text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #c7c7cc;"></i>
            <p class="mt-3 mb-0" style="color: #6e6e73;">등록된 레시피가 없습니다.</p>
            <p class="text-muted small">레시피 관리에서 레시피를 먼저 등록해주세요.</p>
            <%= link_to "레시피 등록하기", recipes_path, class: "btn btn-outline-primary mt-2" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 생산계획 입력/수정 모달 -->
<div class="modal fade" id="planInputModal" tabindex="-1" aria-labelledby="planInputModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #f5f5f7;">
        <h5 class="modal-title" id="planInputModalLabel">
          <i class="bi bi-calendar-plus me-2" style="color: #0071e3;"></i>
          <span id="modal-date-display"></span>
          <span id="modal-date-badge" class="badge ms-2"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: batch_create_production_plans_path, method: :post, local: true, id: "modal-plan-form" do %>
        <input type="hidden" name="date" id="modal-plan-date" value="">
        <input type="hidden" name="redirect_to_calendar" value="true">
        <div class="modal-body" id="planInputModalBody">
          <!-- 레시피 목록 동적 로드 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>저장
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 날짜 상세 보기 모달 (과거 날짜용) -->
<div class="modal fade" id="dayViewModal" tabindex="-1" aria-labelledby="dayViewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayViewModalLabel">
          <span id="view-modal-date-display"></span>
          <span id="view-modal-date-badge" class="badge bg-secondary ms-2">과거 (실적)</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="dayViewModalBody">
        <!-- 동적으로 로드 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* 캘린더 스타일 */
  .calendar-grid {
    display: flex;
    flex-direction: column;
  }

  .calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background-color: #f5f5f7;
    border-bottom: 1px solid #e8e8ed;
  }

  .calendar-day-name {
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    color: #1d1d1f;
  }

  .calendar-day-name.sunday { color: #ff3b30; }
  .calendar-day-name.saturday { color: #007aff; }

  .calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }

  .calendar-cell {
    min-height: 100px;
    border-right: 1px solid #e8e8ed;
    border-bottom: 1px solid #e8e8ed;
    padding: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .calendar-cell:hover {
    background-color: #f0f7ff;
  }

  .calendar-cell.selected {
    background-color: #e3f2fd;
    box-shadow: inset 0 0 0 2px #0071e3;
  }

  .calendar-cell:hover::after {
    content: '더블클릭하여 입력';
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-size: 0.6rem;
    color: #0071e3;
    opacity: 0.7;
  }

  .calendar-cell {
    position: relative;
  }

  .calendar-cell:nth-child(7n) {
    border-right: none;
  }

  .calendar-cell.other-month {
    background-color: #fafafa;
    opacity: 0.6;
  }

  .calendar-cell.today {
    background-color: #e3f2fd;
  }

  .calendar-cell.past {
    background-color: #f9f9f9;
  }

  .calendar-cell.has-plans {
    border-left: 3px solid #0071e3;
  }

  .calendar-date {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .calendar-date.sunday { color: #ff3b30; }
  .calendar-date.saturday { color: #007aff; }

  .calendar-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .plan-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.25rem;
    margin-bottom: 2px;
  }

  .plan-badge .plan-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
  }

  .plan-badge .plan-qty {
    flex-shrink: 0;
    font-weight: 700;
    background-color: rgba(255,255,255,0.6);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.65rem;
  }

  .plan-badge.gijeongddeok {
    background-color: #e8f5e9;
    color: #2e7d32;
    border-left: 3px solid #4caf50;
  }

  .plan-badge.gijeongddeok .plan-qty {
    background-color: rgba(46, 125, 50, 0.15);
    color: #1b5e20;
  }

  .plan-badge.other {
    background-color: #fff3e0;
    color: #e65100;
    border-left: 3px solid #ff9800;
  }

  .plan-badge.other .plan-qty {
    background-color: rgba(230, 81, 0, 0.15);
    color: #bf360c;
  }

  .more-plans {
    font-size: 0.7rem;
    color: #6e6e73;
    text-align: center;
    margin-top: 0.25rem;
  }

  /* 범례 */
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .legend-dot.gijeongddeok { background-color: #4caf50; }
  .legend-dot.other { background-color: #ff9800; }
  .legend-dot.past { background-color: #9e9e9e; }

  /* 기존 스타일 */
  .quantity-input-group .quantity-btn,
  .quantity-input-group .allocation-btn {
    transition: all 0.2s ease;
  }

  .quantity-input-group .quantity-btn:hover,
  .quantity-input-group .allocation-btn:hover {
    background-color: #0071e3;
    border-color: #0071e3;
    color: white;
  }

  .quantity-input:focus,
  .allocation-input:focus {
    box-shadow: none;
    border-color: #0071e3;
  }

  .quantity-input.changed,
  .allocation-input.changed {
    background-color: #fff3cd;
    border-color: #ffc107;
  }

  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button,
  .allocation-input::-webkit-outer-spin-button,
  .allocation-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .quantity-input[type=number],
  .allocation-input[type=number] {
    -moz-appearance: textfield;
  }
</style>

<script>
document.addEventListener('turbo:load', function() {
  // ===============================
  // 캘린더 뷰 관련
  // ===============================

  // 레시피 데이터 (모달 폼용)
  const recipesData = <%= raw(@recipes.map { |r|
    is_gijeongddeok = r.name.include?('기정떡')
    {
      id: r.id,
      name: r.name,
      total_weight: r.total_weight,
      is_gijeongddeok: is_gijeongddeok,
      default_unit: is_gijeongddeok ? '통' : '개',
      step_value: is_gijeongddeok ? 0.5 : 1
    }
  }.to_json) %>;

  // 날짜별 기존 계획 데이터
  const plansData = <%= raw(@production_plans.group_by { |p| p.production_date.to_s }.transform_values { |plans|
    plans.map { |p|
      {
        id: p.id,
        recipe_id: p.recipe_id,
        recipe_name: p.recipe&.name,
        quantity: p.quantity,
        unit_type: p.unit_label,
        allocations: p.production_plan_allocations.map { |a|
          { product_name: a.finished_product.name, quantity: a.quantity }
        }
      }
    }
  }.to_json) %>;

  // 캘린더 셀 더블클릭 이벤트
  document.querySelectorAll('.calendar-cell').forEach(function(cell) {
    cell.addEventListener('dblclick', function(e) {
      e.preventDefault();
      const dateStr = this.dataset.date;
      // 과거/미래 관계없이 모두 입력 모달 열기
      openPlanInputModal(dateStr);
    });

    // 싱글클릭 시 약간의 하이라이트 효과 (선택적)
    cell.addEventListener('click', function(e) {
      document.querySelectorAll('.calendar-cell.selected').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
    });
  });

  // 생산계획 입력 모달 열기
  function openPlanInputModal(dateStr) {
    const date = new Date(dateStr);
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('modal-date-display').textContent = date.toLocaleDateString('ko-KR', options);
    document.getElementById('modal-plan-date').value = dateStr;

    const isToday = dateStr === '<%= Date.today.to_s %>';
    const badge = document.getElementById('modal-date-badge');
    if (isToday) {
      badge.textContent = '오늘';
      badge.className = 'badge bg-success ms-2';
    } else {
      badge.textContent = '계획';
      badge.className = 'badge bg-primary ms-2';
    }

    // 기존 계획 데이터 가져오기
    const existingPlans = plansData[dateStr] || [];
    const existingByRecipe = {};
    existingPlans.forEach(p => {
      existingByRecipe[p.recipe_id] = p;
    });

    // 폼 내용 생성
    let html = '';
    if (recipesData.length === 0) {
      html = `
        <div class="text-center py-4">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #c7c7cc;"></i>
          <p class="mt-3 mb-0 text-muted">등록된 레시피가 없습니다.</p>
          <a href="/recipes" class="btn btn-outline-primary mt-2">레시피 등록하기</a>
        </div>
      `;
    } else {
      html = '<div class="list-group list-group-flush">';
      recipesData.forEach(function(recipe) {
        const existing = existingByRecipe[recipe.id];
        const currentQty = existing ? existing.quantity : 0;
        const currentUnit = existing ? existing.unit_type : recipe.default_unit;

        html += `
          <div class="list-group-item py-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="bi ${recipe.is_gijeongddeok ? 'bi-star-fill text-success' : 'bi-journal-text text-primary'} me-2" style="font-size: 1.2rem;"></i>
                <div>
                  <h6 class="mb-0" style="font-weight: 600;">${recipe.name}</h6>
                  ${recipe.total_weight > 0 ? `<small class="text-muted">${recipe.total_weight.toLocaleString()}g/1${recipe.default_unit}</small>` : ''}
                </div>
              </div>
              <div class="d-flex align-items-center">
                <div class="quantity-input-group d-flex align-items-center me-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm modal-qty-btn"
                          data-action="decrease" data-recipe-id="${recipe.id}" data-step="${recipe.step_value}"
                          style="border-radius: 8px 0 0 8px; width: 36px; height: 36px;">
                    <i class="bi bi-dash"></i>
                  </button>
                  <input type="number"
                         name="plans[${recipe.id}][quantity]"
                         value="${currentQty}"
                         min="0"
                         step="${recipe.step_value}"
                         class="form-control text-center modal-qty-input"
                         data-recipe-id="${recipe.id}"
                         data-step="${recipe.step_value}"
                         style="width: 70px; border-radius: 0; border-left: 0; border-right: 0; height: 36px; font-weight: 600;">
                  <button type="button" class="btn btn-outline-secondary btn-sm modal-qty-btn"
                          data-action="increase" data-recipe-id="${recipe.id}" data-step="${recipe.step_value}"
                          style="border-radius: 0 8px 8px 0; width: 36px; height: 36px;">
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
                <select name="plans[${recipe.id}][unit_type]" class="form-select form-select-sm" style="width: 70px; height: 36px;">
                  <option value="개" ${currentUnit !== '통' ? 'selected' : ''}>개</option>
                  <option value="통" ${currentUnit === '통' ? 'selected' : ''}>통</option>
                </select>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }

    document.getElementById('planInputModalBody').innerHTML = html;

    // +/- 버튼 이벤트 바인딩
    document.querySelectorAll('.modal-qty-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const action = this.dataset.action;
        const recipeId = this.dataset.recipeId;
        const step = parseFloat(this.dataset.step) || 1;
        const input = document.querySelector(`.modal-qty-input[data-recipe-id="${recipeId}"]`);
        let value = parseFloat(input.value) || 0;

        if (action === 'increase') {
          value = Math.round((value + step) * 10) / 10;
        } else if (action === 'decrease' && value >= step) {
          value = Math.round((value - step) * 10) / 10;
        }

        input.value = value;
        highlightIfChanged(input);
      });
    });

    // 입력값 변경 시 하이라이트
    document.querySelectorAll('.modal-qty-input').forEach(function(input) {
      input.addEventListener('input', function() {
        highlightIfChanged(this);
      });
    });

    function highlightIfChanged(input) {
      const value = parseFloat(input.value) || 0;
      if (value > 0) {
        input.style.backgroundColor = '#fff3cd';
        input.style.borderColor = '#ffc107';
      } else {
        input.style.backgroundColor = '';
        input.style.borderColor = '';
      }
    }

    // 초기 하이라이트
    document.querySelectorAll('.modal-qty-input').forEach(input => highlightIfChanged(input));

    // getOrCreateInstance를 사용하여 중복 인스턴스 방지
    const modalEl = document.getElementById('planInputModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  // 과거 날짜 보기 모달
  function openViewModal(dateStr) {
    const date = new Date(dateStr);
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('view-modal-date-display').textContent = date.toLocaleDateString('ko-KR', options);

    const dayPlans = plansData[dateStr] || [];

    let html = '';
    if (dayPlans.length > 0) {
      html = '<div class="list-group">';
      dayPlans.forEach(function(plan) {
        html += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${plan.recipe_name || '기타 제품'}</h6>
                <p class="mb-1 text-muted">수량: ${plan.quantity}${plan.unit_type}</p>
              </div>
            </div>
        `;

        if (plan.allocations && plan.allocations.length > 0) {
          html += '<div class="mt-2"><small class="text-muted">배분:</small><ul class="mb-0 small">';
          plan.allocations.forEach(function(a) {
            html += `<li>${a.product_name}: ${a.quantity}개</li>`;
          });
          html += '</ul></div>';
        }

        html += '</div>';
      });
      html += '</div>';
    } else {
      html = `
        <div class="text-center py-4">
          <i class="bi bi-calendar-x" style="font-size: 3rem; color: #c7c7cc;"></i>
          <p class="mt-3 mb-0 text-muted">이 날짜에 생산 실적이 없습니다.</p>
        </div>
      `;
    }

    document.getElementById('dayViewModalBody').innerHTML = html;

    // getOrCreateInstance를 사용하여 중복 인스턴스 방지
    const modalEl = document.getElementById('dayViewModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  // ===============================
  // 리스트 뷰 관련 (기존 코드)
  // ===============================

  // 레시피 수량 +/- 버튼
  document.querySelectorAll('.quantity-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const action = this.dataset.action;
      const recipeId = this.dataset.recipeId;
      const step = parseFloat(this.dataset.step) || 1;
      const input = document.querySelector(`input.quantity-input[data-recipe-id="${recipeId}"]`);
      let value = parseFloat(input.value) || 0;

      if (action === 'increase') {
        value = Math.round((value + step) * 10) / 10;
      } else if (action === 'decrease' && value >= step) {
        value = Math.round((value - step) * 10) / 10;
      }

      input.value = value;
      checkIfChanged(input);
      updateRemainingWeight(recipeId);
    });
  });

  // 완제품 배분 +/- 버튼
  document.querySelectorAll('.allocation-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const action = this.dataset.action;
      const recipeId = this.dataset.recipeId;
      const productId = this.dataset.productId;
      const input = document.querySelector(`input.allocation-input[data-recipe-id="${recipeId}"][data-product-id="${productId}"]`);
      let value = parseInt(input.value) || 0;

      if (action === 'increase') {
        value++;
      } else if (action === 'decrease' && value > 0) {
        value--;
      }

      input.value = value;
      checkIfChanged(input);
      updateAllocationWeight(recipeId, productId);
      updateRemainingWeight(recipeId);
    });
  });

  // 레시피 수량 입력 변경
  document.querySelectorAll('.quantity-input').forEach(function(input) {
    input.addEventListener('input', function() {
      checkIfChanged(this);
      updateRemainingWeight(this.dataset.recipeId);
    });
  });

  // 완제품 배분 입력 변경
  document.querySelectorAll('.allocation-input').forEach(function(input) {
    input.addEventListener('input', function() {
      checkIfChanged(this);
      updateAllocationWeight(this.dataset.recipeId, this.dataset.productId);
      updateRemainingWeight(this.dataset.recipeId);
    });
  });

  function checkIfChanged(input) {
    const original = parseFloat(input.dataset.original) || 0;
    const current = parseFloat(input.value) || 0;

    if (original !== current) {
      input.classList.add('changed');
    } else {
      input.classList.remove('changed');
    }
  }

  function updateAllocationWeight(recipeId, productId) {
    const input = document.querySelector(`input.allocation-input[data-recipe-id="${recipeId}"][data-product-id="${productId}"]`);
    const weightCell = document.querySelector(`.allocation-weight[data-recipe-id="${recipeId}"][data-product-id="${productId}"]`);
    const weight = parseFloat(input.dataset.weight) || 0;
    const qty = parseInt(input.value) || 0;
    weightCell.textContent = (weight * qty).toLocaleString() + 'g';
  }

  function updateRemainingWeight(recipeId) {
    const quantityInput = document.querySelector(`input.quantity-input[data-recipe-id="${recipeId}"]`);
    const remainingCell = document.querySelector(`.remaining-weight[data-recipe-id="${recipeId}"]`);
    const primaryInput = document.querySelector(`input.primary-allocation-input[data-recipe-id="${recipeId}"]`);

    if (!remainingCell) return;

    const totalWeightPerUnit = parseFloat(remainingCell.dataset.totalWeight) || 0;
    const quantity = parseFloat(quantityInput.value) || 0;
    const totalWeight = totalWeightPerUnit * quantity;

    let allocatedWeight = 0;
    document.querySelectorAll(`input.allocation-input[data-recipe-id="${recipeId}"]`).forEach(function(input) {
      const weight = parseFloat(input.dataset.weight) || 0;
      const qty = parseInt(input.value) || 0;
      allocatedWeight += weight * qty;
    });

    const remaining = totalWeight - allocatedWeight;

    if (primaryInput) {
      const primaryWeight = parseFloat(primaryInput.dataset.weight) || 0;
      if (primaryWeight > 0 && remaining > 0) {
        const primaryQty = Math.floor(remaining / primaryWeight);
        primaryInput.value = primaryQty;

        const primaryWeightCell = document.querySelector(`.allocation-weight[data-recipe-id="${recipeId}"][data-is-primary="true"]`);
        if (primaryWeightCell) {
          primaryWeightCell.textContent = (primaryWeight * primaryQty).toLocaleString() + 'g';
        }

        const actualRemaining = remaining - (primaryWeight * primaryQty);
        remainingCell.textContent = actualRemaining.toLocaleString() + 'g';

        if (actualRemaining < 0) {
          remainingCell.style.color = '#ff3b30';
        } else if (actualRemaining > 0) {
          remainingCell.style.color = '#ff9500';
        } else {
          remainingCell.style.color = '#34c759';
        }
      } else {
        primaryInput.value = 0;
        const primaryWeightCell = document.querySelector(`.allocation-weight[data-recipe-id="${recipeId}"][data-is-primary="true"]`);
        if (primaryWeightCell) {
          primaryWeightCell.textContent = '0g';
        }
        remainingCell.textContent = remaining.toLocaleString() + 'g';

        if (remaining < 0) {
          remainingCell.style.color = '#ff3b30';
        } else {
          remainingCell.style.color = '#ff9500';
        }
      }
    } else {
      remainingCell.textContent = remaining.toLocaleString() + 'g';

      if (remaining < 0) {
        remainingCell.style.color = '#ff3b30';
      } else {
        remainingCell.style.color = '#ff9500';
      }
    }
  }

  // 초기 계산
  document.querySelectorAll('.remaining-weight').forEach(function(cell) {
    updateRemainingWeight(cell.dataset.recipeId);
  });
});
</script>
