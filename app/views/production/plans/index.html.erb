<%= render 'production/shared/sub_navigation' %>

<div class="container mt-4">
  <!-- 헤더 섹션 -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0" style="font-weight: 600; letter-spacing: -0.02em;">생산 계획</h4>
      <p class="text-muted small mb-0">Production Planning</p>
    </div>
  </div>

  <!-- 날짜 네비게이션 -->
  <div class="card-modern mb-4">
    <div class="card-body py-3 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to production_plans_path(date: @date - 1.month),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>

        <div class="text-center">
          <h5 class="mb-0" style="font-weight: 600;">
            <%= @date.strftime('%Y년 %m월') %>
          </h5>
          <%= link_to "오늘", production_plans_path(date: Date.today),
                      class: "btn btn-sm btn-link text-muted" %>
        </div>

        <%= link_to production_plans_path(date: @date + 1.month),
                    class: "btn btn-sm btn-outline-secondary" do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 완제품 목록 & 수량 입력 -->
  <div class="card-modern">
    <div class="card-header" style="background-color: #f5f5f7; border-bottom: 1px solid #e8e8ed;">
      <h5 class="mb-0" style="font-weight: 600;">
        <i class="bi bi-box-seam me-2" style="color: #0071e3;"></i>
        완제품 생산 계획
      </h5>
    </div>
    <div class="card-body p-0">
      <% if @finished_products.any? %>
        <%= form_with url: batch_create_production_plans_path, method: :post, local: true, id: "production-plan-form" do |f| %>
          <%= hidden_field_tag :date, @date.to_s %>

          <div class="table-responsive">
            <table class="table table-hover mb-0" style="font-size: 0.95rem;">
              <thead style="background-color: #f5f5f7; border-bottom: 2px solid #e8e8ed;">
                <tr>
                  <th style="padding: 1rem; font-weight: 600; color: #1d1d1f; width: 50%;">완제품명</th>
                  <th class="text-center" style="padding: 1rem; font-weight: 600; color: #1d1d1f; width: 30%;">수량</th>
                  <th class="text-center" style="padding: 1rem; font-weight: 600; color: #1d1d1f; width: 20%;">현재 계획</th>
                </tr>
              </thead>
              <tbody>
                <% @finished_products.each do |product| %>
                  <%
                    # 해당 월의 기존 계획 찾기
                    existing_plan = @production_plans.find { |p| p.finished_product_id == product.id && p.production_date.month == @date.month && p.production_date.year == @date.year }
                    current_quantity = existing_plan&.quantity || 0
                  %>
                  <tr>
                    <td style="padding: 1rem; color: #1d1d1f; font-weight: 500;">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-box me-2" style="color: #0071e3;"></i>
                        <%= product.name %>
                        <% if product.weight.present? %>
                          <span class="badge bg-light text-muted ms-2" style="font-weight: normal;">
                            <%= product.weight %><%= product.weight_unit || 'g' %>
                          </span>
                        <% end %>
                      </div>
                    </td>
                    <td class="text-center" style="padding: 0.75rem;">
                      <div class="quantity-input-group d-flex justify-content-center align-items-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn"
                                data-action="decrease" data-product-id="<%= product.id %>"
                                style="border-radius: 8px 0 0 8px; width: 38px; height: 38px;">
                          <i class="bi bi-dash"></i>
                        </button>
                        <input type="number"
                               name="quantities[<%= product.id %>]"
                               value="<%= current_quantity %>"
                               min="0"
                               class="form-control text-center quantity-input"
                               data-product-id="<%= product.id %>"
                               data-original="<%= current_quantity %>"
                               style="width: 80px; border-radius: 0; border-left: 0; border-right: 0; height: 38px; font-weight: 600;">
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn"
                                data-action="increase" data-product-id="<%= product.id %>"
                                style="border-radius: 0 8px 8px 0; width: 38px; height: 38px;">
                          <i class="bi bi-plus"></i>
                        </button>
                      </div>
                    </td>
                    <td class="text-center" style="padding: 1rem;">
                      <% if existing_plan %>
                        <span class="badge bg-primary" style="font-size: 0.85rem; padding: 0.5em 0.8em;">
                          <%= existing_plan.quantity %>개
                        </span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="p-3 bg-light border-top d-flex justify-content-end">
            <button type="submit" class="btn-modern btn-modern-primary" id="save-btn">
              <i class="bi bi-check-lg me-2"></i>저장
            </button>
          </div>
        <% end %>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #c7c7cc;"></i>
          <p class="mt-3 mb-0" style="color: #6e6e73;">등록된 완제품이 없습니다.</p>
          <p class="text-muted small">레시피 관리에서 완제품을 먼저 등록해주세요.</p>
          <%= link_to "완제품 등록하기", finished_products_path, class: "btn btn-outline-primary mt-2" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  .quantity-input-group .quantity-btn {
    transition: all 0.2s ease;
  }

  .quantity-input-group .quantity-btn:hover {
    background-color: #0071e3;
    border-color: #0071e3;
    color: white;
  }

  .quantity-input:focus {
    box-shadow: none;
    border-color: #0071e3;
  }

  .quantity-input.changed {
    background-color: #fff3cd;
    border-color: #ffc107;
  }

  /* 숫자 입력 스피너 숨기기 */
  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .quantity-input[type=number] {
    -moz-appearance: textfield;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // +/- 버튼 클릭 이벤트
  document.querySelectorAll('.quantity-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const action = this.dataset.action;
      const productId = this.dataset.productId;
      const input = document.querySelector(`input[data-product-id="${productId}"]`);
      let value = parseInt(input.value) || 0;

      if (action === 'increase') {
        value++;
      } else if (action === 'decrease' && value > 0) {
        value--;
      }

      input.value = value;
      checkIfChanged(input);
    });
  });

  // 수량 입력 변경 감지
  document.querySelectorAll('.quantity-input').forEach(function(input) {
    input.addEventListener('input', function() {
      checkIfChanged(this);
    });
  });

  function checkIfChanged(input) {
    const original = parseInt(input.dataset.original) || 0;
    const current = parseInt(input.value) || 0;

    if (original !== current) {
      input.classList.add('changed');
    } else {
      input.classList.remove('changed');
    }
  }
});
</script>
