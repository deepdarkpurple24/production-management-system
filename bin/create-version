#!/usr/bin/env bash
# 새 버전 생성 스크립트
# 사용법: bin/create-version [major|minor|patch] "변경사항 설명"
# 예시: bin/create-version minor "재고 리포트 기능 추가"

set -e

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 인자 확인
if [ -z "$1" ] || [ -z "$2" ]; then
  echo -e "${RED}에러: 버전 타입과 설명을 입력해주세요${NC}"
  echo "사용법: bin/create-version [major|minor|patch] \"변경사항 설명\""
  echo ""
  echo "버전 타입:"
  echo "  major - 주요 변경 (1.0.0 → 2.0.0)"
  echo "  minor - 기능 추가 (1.0.0 → 1.1.0)"
  echo "  patch - 버그 수정 (1.0.0 → 1.0.1)"
  exit 1
fi

VERSION_TYPE=$1
DESCRIPTION=$2

# 현재 최신 버전 가져오기
CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo -e "${BLUE}현재 버전: $CURRENT_VERSION${NC}"

# 버전 번호 파싱
VERSION_NUM=${CURRENT_VERSION#v}
IFS='.' read -r -a VERSION_PARTS <<< "$VERSION_NUM"
MAJOR=${VERSION_PARTS[0]:-0}
MINOR=${VERSION_PARTS[1]:-0}
PATCH=${VERSION_PARTS[2]:-0}

# 새 버전 계산
case $VERSION_TYPE in
  major)
    MAJOR=$((MAJOR + 1))
    MINOR=0
    PATCH=0
    ;;
  minor)
    MINOR=$((MINOR + 1))
    PATCH=0
    ;;
  patch)
    PATCH=$((PATCH + 1))
    ;;
  *)
    echo -e "${RED}에러: 잘못된 버전 타입입니다 (major|minor|patch 중 선택)${NC}"
    exit 1
    ;;
esac

NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
echo -e "${GREEN}새 버전: $NEW_VERSION${NC}"
echo ""

# 변경사항 확인
if ! git diff-index --quiet HEAD --; then
  echo -e "${RED}에러: 커밋되지 않은 변경사항이 있습니다${NC}"
  echo "먼저 변경사항을 커밋해주세요:"
  echo "  git add ."
  echo "  git commit -m \"변경사항 설명\""
  exit 1
fi

# 테스트 실행 여부 확인
echo -e "${YELLOW}테스트를 실행하시겠습니까? (y/n)${NC}"
read -r run_tests
if [ "$run_tests" = "y" ]; then
  echo -e "${YELLOW}테스트 실행 중...${NC}"
  if bin/rails test; then
    echo -e "${GREEN}✓ 모든 테스트 통과${NC}"
  else
    echo -e "${RED}에러: 테스트 실패. 버전 생성을 중단합니다${NC}"
    exit 1
  fi
fi

# 버전 태그 생성
echo -e "${YELLOW}버전 태그를 생성합니다...${NC}"
git tag -a "$NEW_VERSION" -m "$DESCRIPTION"
echo -e "${GREEN}✓ 태그 생성 완료: $NEW_VERSION${NC}"

# 원격 저장소에 푸시
echo -e "${YELLOW}원격 저장소에 푸시하시겠습니까? (y/n)${NC}"
read -r do_push
if [ "$do_push" = "y" ]; then
  git push origin main
  git push --tags
  echo -e "${GREEN}✓ 원격 저장소에 푸시 완료${NC}"
fi

echo ""
echo -e "${GREEN}=== 버전 생성 완료 ===${NC}"
echo "버전: $NEW_VERSION"
echo "설명: $DESCRIPTION"
echo ""
echo -e "${BLUE}버전 히스토리:${NC}"
git tag -l --sort=-v:refname | head -5
echo ""
echo -e "${YELLOW}롤백이 필요한 경우:${NC}"
echo "  bin/rollback-version $CURRENT_VERSION"
