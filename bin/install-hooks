#!/usr/bin/env bash
# Install Git hooks for automatic environment synchronization

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}🔧 Git Hooks 설치${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Check if we're in a git repository
if [ ! -d ".git" ]; then
  echo -e "${RED}❌ Error: .git 디렉토리를 찾을 수 없습니다.${NC}"
  echo "   프로젝트 루트 디렉토리에서 실행해주세요."
  exit 1
fi

# Check if hooks directory exists
if [ ! -d "hooks" ]; then
  echo -e "${RED}❌ Error: hooks 디렉토리를 찾을 수 없습니다.${NC}"
  exit 1
fi

# Install hooks
HOOKS_INSTALLED=0
HOOKS_FAILED=0

for hook_file in hooks/*; do
  if [ -f "$hook_file" ]; then
    hook_name=$(basename "$hook_file")
    echo -n "Installing $hook_name... "

    # Copy hook to .git/hooks/
    cp "$hook_file" ".git/hooks/$hook_name"
    chmod +x ".git/hooks/$hook_name"

    if [ -f ".git/hooks/$hook_name" ]; then
      echo -e "${GREEN}✓${NC}"
      HOOKS_INSTALLED=$((HOOKS_INSTALLED + 1))
    else
      echo -e "${RED}✗${NC}"
      HOOKS_FAILED=$((HOOKS_FAILED + 1))
    fi
  fi
done

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ $HOOKS_INSTALLED -gt 0 ]; then
  echo -e "${GREEN}✅ Git hooks 설치 완료!${NC}"
  echo ""
  echo "설치된 hooks: $HOOKS_INSTALLED개"

  if [ -f ".git/hooks/post-merge" ]; then
    echo ""
    echo -e "${YELLOW}📌 post-merge hook이 활성화되었습니다.${NC}"
    echo "   이제 git pull을 실행하면 자동으로:"
    echo "   • 데이터베이스 마이그레이션 확인 및 실행"
    echo "   • 의존성 업데이트 (필요시)"
    echo "   • CSS 재빌드 (필요시)"
    echo "   • 서버 재시작 안내"
  fi
else
  echo -e "${RED}❌ Hook 설치 실패${NC}"
  exit 1
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
