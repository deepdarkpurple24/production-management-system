#!/usr/bin/env bash
# 안전한 버전 롤백 스크립트
# 사용법: bin/rollback-version [version_tag]
# 예시: bin/rollback-version v1.0.0

set -e

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 버전 태그 확인
if [ -z "$1" ]; then
  echo -e "${RED}에러: 롤백할 버전을 지정해주세요${NC}"
  echo "사용법: bin/rollback-version [version_tag]"
  echo ""
  echo "사용 가능한 버전 목록:"
  git tag -l --sort=-v:refname | head -10
  exit 1
fi

VERSION=$1

# 태그 존재 여부 확인
if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
  echo -e "${RED}에러: '$VERSION' 태그를 찾을 수 없습니다${NC}"
  echo ""
  echo "사용 가능한 버전 목록:"
  git tag -l --sort=-v:refname
  exit 1
fi

echo -e "${YELLOW}=== 버전 롤백 시작 ===${NC}"
echo "현재 버전: $(git describe --tags --always)"
echo "롤백 대상: $VERSION"
echo ""

# 현재 상태 저장 (안전장치)
BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
echo -e "${YELLOW}현재 상태를 백업 브랜치로 저장합니다: $BACKUP_BRANCH${NC}"
git branch "$BACKUP_BRANCH"
echo -e "${GREEN}✓ 백업 완료${NC}"
echo ""

# 변경사항 확인
if ! git diff-index --quiet HEAD --; then
  echo -e "${RED}경고: 커밋되지 않은 변경사항이 있습니다${NC}"
  echo "계속하려면 'yes'를 입력하세요:"
  read -r response
  if [ "$response" != "yes" ]; then
    echo "롤백 취소"
    exit 0
  fi
fi

# 데이터베이스 마이그레이션 상태 확인
echo -e "${YELLOW}데이터베이스 마이그레이션 상태 확인 중...${NC}"
CURRENT_MIGRATIONS=$(bin/rails db:migrate:status 2>/dev/null | grep "up" | wc -l)
echo "현재 적용된 마이그레이션: $CURRENT_MIGRATIONS개"
echo ""

# 코드만 롤백 (DB는 그대로)
echo -e "${YELLOW}코드를 $VERSION으로 롤백합니다 (데이터베이스는 유지)...${NC}"
git reset --hard "$VERSION"
echo -e "${GREEN}✓ 코드 롤백 완료${NC}"
echo ""

# 의존성 체크
echo -e "${YELLOW}의존성 확인 중...${NC}"
if ! bundle check >/dev/null 2>&1; then
  echo -e "${YELLOW}Gemfile이 변경되었습니다. bundle install을 실행합니다...${NC}"
  bundle install
fi

if [ -f "package.json" ]; then
  echo -e "${YELLOW}JavaScript 의존성을 확인합니다...${NC}"
  yarn install --check-files >/dev/null 2>&1 || yarn install
fi

# CSS 재빌드
if [ -f "package.json" ] && grep -q "build:css" package.json; then
  echo -e "${YELLOW}CSS를 재빌드합니다...${NC}"
  yarn build:css
fi

echo ""
echo -e "${GREEN}=== 롤백 완료 ===${NC}"
echo ""
echo -e "${YELLOW}중요 안내사항:${NC}"
echo "1. 코드는 $VERSION으로 롤백되었습니다"
echo "2. 데이터베이스는 변경되지 않았습니다"
echo "3. 원래 상태는 '$BACKUP_BRANCH' 브랜치에 백업되어 있습니다"
echo ""
echo -e "${YELLOW}다음 작업:${NC}"
echo "- 서버 재시작: bin/dev"
echo "- 원격 저장소에 반영: git push --force-with-lease"
echo "- 백업 브랜치 확인: git log $BACKUP_BRANCH"
echo "- 백업으로 복구: git reset --hard $BACKUP_BRANCH"
echo ""
echo -e "${RED}주의: 원격 저장소에 반영하려면 force push가 필요합니다${NC}"
echo "다른 개발자와 협업 중이라면 팀원들에게 알려주세요"
