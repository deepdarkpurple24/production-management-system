#!/usr/bin/env bash
# Post-pull environment synchronization script
# Run this after 'git pull' to ensure all changes are properly applied

set -e  # Exit on error

echo "üîÑ Post-Pull Environment Sync"
echo "=============================="
echo ""

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "bin/rails" ]; then
  echo -e "${RED}‚ùå Error: Must be run from Rails project root${NC}"
  exit 1
fi

echo "üìã Checking environment status..."
echo ""

# 1. Check for pending migrations
echo "1Ô∏è‚É£  Checking database migrations..."
PENDING_MIGRATIONS=$(bin/rails db:migrate:status 2>/dev/null | grep "^\s*down" || true)

if [ -n "$PENDING_MIGRATIONS" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Found pending migrations:${NC}"
  echo "$PENDING_MIGRATIONS"
  echo ""
  read -p "Run migrations now? (y/n) " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "   Running migrations..."
    bin/rails db:migrate
    echo -e "${GREEN}‚úì Migrations completed${NC}"
  else
    echo -e "${YELLOW}‚ö†Ô∏è  Skipped migrations (run 'bin/rails db:migrate' manually)${NC}"
  fi
else
  echo -e "${GREEN}‚úì No pending migrations${NC}"
fi
echo ""

# 2. Update dependencies
echo "2Ô∏è‚É£  Checking dependencies..."

# Check if Gemfile changed
if git diff HEAD@{1} HEAD --name-only | grep -q "^Gemfile"; then
  echo "   Gemfile changed, running bundle install..."
  bundle install
  echo -e "${GREEN}‚úì Ruby gems updated${NC}"
else
  echo -e "${GREEN}‚úì Gemfile unchanged${NC}"
fi

# Check if package.json changed
if git diff HEAD@{1} HEAD --name-only | grep -q "^package.json"; then
  echo "   package.json changed, running yarn install..."
  yarn install
  echo -e "${GREEN}‚úì Node packages updated${NC}"
else
  echo -e "${GREEN}‚úì package.json unchanged${NC}"
fi
echo ""

# 3. Rebuild CSS
echo "3Ô∏è‚É£  Checking CSS changes..."

# Check if any SCSS files changed
if git diff HEAD@{1} HEAD --name-only | grep -q "\.scss$"; then
  echo "   SCSS files changed, rebuilding CSS..."
  yarn build:css
  echo -e "${GREEN}‚úì CSS rebuilt${NC}"
else
  # Even if no SCSS changed, rebuild if builds directory is missing
  if [ ! -f "app/assets/builds/application.css" ]; then
    echo "   CSS build file missing, rebuilding..."
    yarn build:css
    echo -e "${GREEN}‚úì CSS built${NC}"
  else
    echo -e "${GREEN}‚úì No SCSS changes detected${NC}"
  fi
fi
echo ""

# 4. Summary
echo "=============================="
echo "‚úÖ Environment sync complete!"
echo ""
echo "Current state:"
echo "  Commit: $(git log -1 --oneline)"
echo "  Migrations: $(bin/rails db:migrate:status 2>/dev/null | grep "^\s*up" | wc -l | tr -d ' ') up"
if [ -f "app/assets/builds/application.css" ]; then
  echo "  CSS build: $(ls -lh app/assets/builds/application.css | awk '{print $5}') ($(date -r app/assets/builds/application.css '+%Y-%m-%d %H:%M:%S'))"
fi
echo ""

# 5. Reminder to restart server
echo -e "${YELLOW}‚ö†Ô∏è  Remember to restart your development server:${NC}"
echo "   Ctrl+C to stop, then run: bin/dev"
echo ""
